<!-- Converted by db4-upgrade version 1.0 -->

<section xml:id="s-samba-s"><info><title>Conceitos gerais para a configuração do SAMBA</title></info>
<para>
Este capítulo documenta como configurar o seu servidor <command>SAMBA</command>
permitindo o acesso a compartilhamento de arquivos e impressão no sistema.
</para>
<section xml:id="s-samba-nome"><info><title>Nome de máquina (nome NetBios)</title></info>
<para>
Toda a máquina em uma rede NetBEUI é identificada por um nome, este nome deve
ser único na rede e permite que outras máquinas acessem os recursos
disponibilizados ou que sejam enviadas mensagens para a máquina.  Este nome é
composto de 16 caracteres, sendo 15 que identificam a máquina e o último o tipo
de serviço que ela disponibiliza.  O tipo de serviço é associado com o nome da
máquina e registrado em servidores de nomes confirme a configuração da máquina
(você verá isto mais adiante).
</para>
<para>
O nome de máquina é especificado nas diretivas <emphasis>netbios
name</emphasis> e <emphasis>netbios aliases</emphasis> (veja <xref linkend="s-samba-s-global-nome"/>) para detalhes.
</para>
</section>

<section xml:id="s-samba-workgroup"><info><title>Grupo de trabalho</title></info>
<para>
O grupo de trabalho organiza a estrutura de máquinas da rede em forma de
árvore, facilitando sua pesquisa e localização.  Tomemos como exemplo uma
empresa grande com os departamentos <literal>comunicação</literal>,
<literal>redes</literal>, <literal>web</literal>, <literal>rh</literal>, as
máquinas que pertencem ao grupo de <literal>redes</literal> serão agrupadas no
programa de navegação:
</para>
<screen>
redes
  gleydson
  tecnico
  marcelo
  henrique
  michelle

rh
  mrpaoduro
 
web
  web1
  web2
  web3

comunicacao
  comunic1
  comunic2
  comunic3
</screen>
<para>
A segurança no acesso a arquivos e diretórios na configuração de
<emphasis>grupo de trabalho</emphasis> é controlada pela própria máquina,
normalmente usando segurança a nível de compartilhamento.  Esta segurança
funciona definindo um usuário/senha para acessar cada compartilhamento que a
máquina possui.  O <command>Lan Manager</command>, <command>Windows for
Workgroups</command>, <command>Windows 95</command>, <command>Windows
98</command>, <command>XP Home Edition</command> usam este nível de acesso por
padrão.  Se deseja configurar uma rede usando o nível de grupo de trabalho,
veja <xref linkend="s-samba-wrkgrp"/> para detalhes passo a passo e exemplos
práticos.
</para>
<para>
Os programas para navegação na rede NetBIOS são mostrados em <xref linkend="s-samba-c-workgroup-linux-smbclient"/>, <xref linkend="s-samba-c-workgroup-linux-nmblookup"/> e <xref linkend="s-samba-c-graficos"/>.
</para>
</section>

<section xml:id="s-samba-dominio"><info><title>Domínio</title></info>
<para>
O funcionamento é semelhante ao grupo de trabalho, com a diferença que a
segurança é controlada pela máquina central (PDC) usando diretivas de acesso e
grupos.  O PDC (Primary Domain Controller) deverá ter todas as contas de acesso
que serão utilizadas pelo usuário para acessar os recursos existentes em outras
máquinas, script de logon que poderá ser executado em cada máquina para fazer
ajustes, sincronismo, manutenção ou qualquer outra tarefa programada pelo
administrador do sistema.
</para>
<para>
Estas características para configuração de máquinas em domínio são documentadas
passo a passo em <xref linkend="s-samba-dom-intro"/>.
</para>
</section>

<section xml:id="s-samba-compart"><info><title>Compartilhamento</title></info>
<para>
Um compartilhamento é um recurso da máquina local que é disponibilizado para
acesso via rede, que poderá ser <emphasis>mapeada</emphasis> (veja <xref linkend="s-samba-mapeamento"/>) por outra máquina.  O compartilhamento pode ser
um diretório, arquivo, impressora.  Além de permitir o acesso do usuário, o
compartilhamento pode ser protegido por senha, e ter controle de acesso de
leitura/gravação, monitoração de acessos, diretórios ocultos, autenticação via
PDC (domínio) e outras formas para restringir e garantir segurança na
disponibilização dos dados (veja <xref linkend="s-samba-a"/> para aprender os
métodos de como fazer isto).
</para>
<para>
Um compartilhamento no SAMBA pode ser acessível publicamente (sem senha) ou
estar rigidamente protegido tendo que passar por diversas barreiras para chegar
ao seu conteúdo, como senhas, endereço de origem, interfaces, usuário
autorizados, permissões de visualização, etc.
</para>
<para>
O guia <emphasis>Foca Linux</emphasis> abordará estes assuntos com detalhes e
explicará didaticamente como tornar seguro seu servidor samba e garantir um
minucioso controle de acesso a seus compartilhamentos.
</para>
</section>

<section xml:id="s-samba-mapeamento"><info><title>Mapeamento</title></info>
<para>
Mapear significa pegar um diretório/arquivo/impressora compartilhado por alguma
máquina da rede para ser acessada pela máquina local.  Para mapear algum
recurso de rede, é necessário que ele seja compartilhado na outra máquina (veja
<xref linkend="s-samba-compart"/>).  Por exemplo, o diretório
<filename>/usr</filename> <literal>compartilhado</literal> com o nome
<literal>usr</literal>, pode ser mapeado por uma máquina
<command>Windows</command> como a unidade <emphasis>F:</emphasis>, ou mapeado
por uma máquina <command>Linux</command> no diretório
<filename>/mnt/samba</filename>.
</para>
<para>
O programa responsável por mapear unidades compartilhadas no
<command>Linux</command> é o <command>smbmount</command> e
<command>smbclient</command> (veja <xref linkend="s-samba-c-workgroup-linux"/>).
</para>
</section>

<section xml:id="s-samba-nmbd"><info><title>Navegação na Rede e controle de domínio</title></info>
<para>
Esta função é controlada pelo <command>nmbd</command> que fica ativo o tempo
todo disponibilizando os recursos da máquina na rede, participando de eleições
NetBIOS (<xref linkend="s-samba-s-oslevel"/>), fazer logon de máquinas no
domínio (<xref linkend="s-samba-dom-intro"/>), etc.
</para>
<para>
A função de navegação na rede é feita utilizando o compartilhamento
<filename>IPC$</filename>.  Este compartilhamento possui acesso público somente
leitura e utiliza o usuário "guest" para disponibilização de seus.  Como deve
ter percebido, é necessário especificar esta ID de usuário através do parâmetro
<literal>guest account</literal> (<xref linkend="s-samba-s-a-param"/>), ou a
navegação de recursos no sistema (ou na rede, dependendo da configuração do
SAMBA) não funcionará.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> A função de navegação (browsing) poderá
não funcionar corretamente caso a máquina não consiga resolver nomes NetBIOS
para endereços IP.
</para>
</section>

<section xml:id="s-samba-arquivocfg"><info><title>Arquivo de configuração do samba</title></info>
<para>
Toda a configuração relacionada com nomes, grupo de trabalho, tipo de servidor,
log, compartilhamento de arquivos e impressão do <command>samba</command> é
colocada no arquivo de configuração <filename>/etc/samba/smb.conf</filename>.
Este arquivo é dividido em <emphasis>seções</emphasis> e
<emphasis>parâmetros</emphasis>.
</para>
<para>
Uma seção no arquivo de configuração do <command>samba</command>
(<filename>smb.conf</filename>) é definido por um nome entre "[ ]".  As seções
tem o objetivo de organizar os parâmetros pra que tenham efeito somente em
algumas configurações de compartilhamento do servidor (exceto os da seção
<literal>[global]</literal> que não especificam compartilhamentos, mas suas
diretivas podem ser válidas para todas os compartilhamentos do arquivo de
configuração).  Alguns nomes de seções foram reservados para configurações
específicas do <command>samba</command>, eles são os seguintes:
</para>
<variablelist>
<varlistentry>
<term><literal>[global]</literal></term>
<listitem>
<para>
Define configurações que afetam o servidor samba como um todo, fazendo efeito
em todos os compartilhamentos existentes na máquina.  Por exemplo, o grupo de
trabalho, nome do servidor, página de código, restrições de acesso por nome,
etc.  Veja <xref linkend="s-samba-s-global"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>[homes]</literal></term>
<listitem>
<para>
Especifica opções de acesso a diretórios homes de usuários.  O diretório home é
disponibilizado somente para seu dono, após se autenticar no sistema.  Veja
<xref linkend="s-samba-s-homes"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>[printers]</literal></term>
<listitem>
<para>
Define opções gerais para controle das impressoras do sistema.  Este
compartilhamento mapeia os nomes de todas as impressoras encontradas no
<filename>/etc/printcap</filename>.  Configurações especiais podem ser feitas
separadamente.  Veja <xref linkend="s-samba-s-printers"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>[profile]</literal></term>
<listitem>
<para>
Define um perfil quando o servidor <command>samba</command> é usado como PDC de
domínio.  Veja <xref linkend="s-samba-dom-profiles"/>.
</para>
</listitem>
</varlistentry>
</variablelist>
<para>
Qualquer outro nome de [seção] no arquivo <filename>smb.conf</filename> que não
sejam as acima, são tratadas como um compartilhamento ou impressora.
</para>
<para>
Um <emphasis>parâmetro</emphasis> é definido no formato <emphasis>nome =
valor</emphasis>.  Para um exemplo prático, veja um exemplo de arquivo
<filename>smb.conf</filename> em <xref linkend="s-samba-exemplos"/>.  Na
configuração de booleanos, a seguinte sintaxe pode ser usada:
</para>
<itemizedlist>
<listitem>
<para>
<literal>0</literal> ou <literal>1</literal>
</para>
</listitem>
<listitem>
<para>
<literal>yes</literal> ou <literal>no</literal>
</para>
</listitem>
<listitem>
<para>
<literal>true</literal> ou <literal>false</literal>
</para>
</listitem>
</itemizedlist>
<para>
Assim, as seguintes configurações são equivalentes
</para>
<screen>
master browse = 0
master browse = no
master browse = false
</screen>
<para>
Todos significam "NÃO ser o navegador principal de domínio".  A escolha fica a
gosto do administrador.  Durante a configuração, você notará o poder da
flexibilidade oferecida pelo samba na configuração de um servidor SMB :-)
</para>
<para>
Linhas iniciadas por <literal>#</literal> ou <literal>;</literal> são tratadas
como comentário.  Quebras de linha pode ser especificadas com uma
<literal>\</literal> no final da linha.
</para>
</section>

<section xml:id="s-samba-s-global"><info><title>Seção <literal>[global]</literal></title></info>
<para>
Os parâmetros especificados nesta seção tem efeito em todo o servidor
<command>samba</command> incluindo os compartilhamentos.  Caso o parâmetro seja
novamente especificado para o compartilhamento, o valor que valerá é o do
compartilhamento.
</para>
<para>
Por exemplo, se <literal>guest user = nobody</literal> for usado na seção
<emphasis>[global]</emphasis> e o <literal>guest user = foca</literal> for
usado no compartilhamento <literal>[focalinux]</literal>, o usuário que fará
acesso público a todos os compartilhamentos do servidor será o
<literal>nobody</literal>, exceto para o compartilhamento
<literal>[focalinux]</literal>, que será feito pelo usuário
<literal>foca</literal>.  Veja <xref linkend="s-samba-s-a"/> para obter uma
lista e descrição dos principais parâmetros de compartilhamentos existentes.
Uma lista completa pode ser obtida na página de manual do
<filename>smb.conf</filename>.
</para>
<para>
Irei descrever alguns parâmetros utilizados nesta seção, organizado de forma
didática e simplificada.
</para>
<section xml:id="s-samba-s-global-nome"><info><title>Nomes e grupos de trabalho</title></info>
<variablelist>
<varlistentry>
<term>netbios name = [nome do servidor]</term>
<listitem>
<para>
Especifica o nome NetBIOS primário do servidor samba.  Caso não seja ajustado,
ele usará o hostname de sua máquina como valor padrão.
</para>
<para>
Ex.: <literal>netbios name = focasamba</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>workgroup = [grupo de trabalho/domínio]</term>
<listitem>
<para>
Diz qual o nome do grupo de trabalho/domínio que a máquina samba pertencerá.
</para>
<para>
Ex.: <literal>workgroup = focalinux</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>netbios aliases = [nomes alternativos ao sistema]</term>
<listitem>
<para>
Permite o uso de nomes alternativos ao servidor, separados por espaços.
</para>
<para>
Ex.: <literal>teste1 teste2</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>server string = [identificação]</term>
<listitem>
<para>
Identificação enviada do servidor samba para o ambiente de rede.  A string
padrão é <literal>Samba %v</literal> (%v é substituída pela versão do samba,
para maiores detalhes, veja <xref linkend="s-samba-s-varsubst"/>).
</para>
<para>
Ex: <literal>server string = Servidor Samba versão %v</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>name resolve order = [ordem]</term>
<listitem>
<para>
Define a ordem de pesquisa para a resolução de nomes no samba.  A ordem padrão
é: <literal>lmhosts host wins bcast</literal>, que é a melhor para resolução
rápida e que tente gerar menos tráfego broadcast possível.  Veja <xref linkend="s-samba-s-nameresolv"/> para uma explicação mais detalhada.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section xml:id="s-samba-s-global-carac"><info><title>Caracteres e página de código</title></info>
<para>
Uma das partes essenciais após colocar o <command>SAMBA</command> em
funcionamento, é configurar a página de código para que os caracteres sejam
gravados e exibidos corretamente no cliente.  A primeira coisa que precisa
verificar é se seu kernel possui o suporte a página de código local.  Caso não
tenha, baixe o fonte do kernel e siga os seguintes passos na configuração:
</para>
<itemizedlist>
<listitem>
<para>
Dentro da opção "File Systems", "Network File Systems" defina como "Default
Remote NLS Option" a iso8859-1.  Esta opção permite ao
<command>smbmount</command> montar os volumes locais usando os caracteres
corretos.
</para>
</listitem>
<listitem>
<para>
Entre na opção "File Systems", "Native Language Support".  Na opção "Default
NLS Option" coloque "iso8859-1".  Ative também o suporte as páginas de código
437, 850 e 860 e também ao conjunto de caracteres iso8859-1 e UTF8.
</para>
</listitem>
</itemizedlist>
<para>
Note que esta ordem pode variar dependendo da versão do seu kernel, basta que
as entenda para fazer as modificações apropriadas.  Em caso de dúvidas sobre a
compilação do kernel, veja <xref linkend="kern-recompilando"/>.
</para>
<variablelist>
<varlistentry>
<term>character set = [conjunto_caracteres]</term>
<listitem>
<para>
Seleciona o conjunto de caracteres dos arquivos exibidos pelo servidor samba.
Para os idiomas de língua latina, sempre utilize iso8859-1.
</para>
<para>
Ex.: <literal>character set = iso8859-1</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>client code page = [pagina_de_codigo]</term>
<listitem>
<para>
Seleciona a página de código do servidor samba para tratar os caracteres.  Para
os idiomas de língua latina, sempre utilize 850.
</para>
<para>
Ex.: <literal>client code page = 850</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>preserve case =</term>
<listitem>
<para>
Seleciona se arquivos com nomes extensos criados serão criados com os
caracteres em maiúsculas/minúsculas definidos pelo cliente (no) ou se será
usado o valor de <emphasis>default case</emphasis> (caso seja especificado
<literal>yes</literal>).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>short preserve case =</term>
<listitem>
<para>
Seleciona se os arquivos com nomes curtos (formato 8.3) serão criados com os
caracteres mixtos enviados pelo cliente (no) ou se será usando o valor de
<emphasis>default case</emphasis> (caso seja especificado
<literal>yes</literal>).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>default case = [lower/upper]</term>
<listitem>
<para>
Define se os arquivos criados terão seus nomes todos em minúsculas (lower) ou
maiúsculas (upper).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>valid chars = [caracteres]</term>
<listitem>
<para>
Define caracteres válidos nos nomes de arquivos: <literal>valid chars =á:Á é:É
í:Í ó:Ó ú:Ú â:Â ê:Ê ô:Ô ã:Ã õ:Õ à:À ò:Ò</literal>.  Este parâmetro <emphasis role="strong">DEVERÁ</emphasis> ser sempre especificado depois do
<literal>client code page</literal>, pois caso contrário, eles serão
substituídos por estes.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section xml:id="s-samba-s-global-restrusu"><info><title>Restrições de acesso/mapeamento de usuários</title></info>
<variablelist>
<varlistentry>
<term><literal>guest account = [conta]</literal></term>
<listitem>
<para>
Define a conta local de usuário que será mapeada quando um usuário se conectar
sem senha (usuário guest).  Veja mais detalhes em <xref linkend="s-samba-s-a-param"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>invalid users</literal></term>
<listitem>
<para>
Define uma lista de usuários que não terão acesso aos recursos do servidor ou
compartilhamento.  É seguro restringir o acesso samba a usuários com grande
poder no sistema (como o <literal>root</literal>).  Veja mais detalhes em <xref linkend="s-samba-a-restrusu"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>valid users</literal></term>
<listitem>
<para>
Semelhante a opção <literal>invalid users</literal> mas permite que somente os
usuários especificados tenham acesso ao sistema.  Veja mais detalhes em <xref linkend="s-samba-a-restrusu"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>default service = nome</literal></term>
<listitem>
<para>
Caso o serviço que o usuário deseja se conectar não for encontrado no servidor,
o SAMBA mapeará o serviço especificado nesta diretiva como alternativa.  A
variável "%S" e o caracter "_" podem ser interessantes em algumas alternativas
de configuração.  A opção <literal>default</literal> é um sinônimo para esta
opção.  Caso utilize esta opção, crie o compartilhamento em modo somente
leitura e com acesso público, caso contrário (dependendo do planejamento de
partições e segurança do sistema de arquivos) a máquina poderá ser derrubada
sem dificuldades.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>username map = [arquivo]</literal></term>
<listitem>
<para>
Especifica um arquivo que faz o mapeamento entre nomes fornecidos por clientes
e nomes de contas Unix locais.  Veja <xref linkend="s-samba-a-usernamemap"/>
para mais detalhes de como configurar este recurso.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>obey pam restrictions = yes</term>
<listitem>
<para>
Indica se as restrições do usuário nos módulos PAM terão efeito também no
SAMBA.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section xml:id="s-samba-s-global-nivelauth"><info><title>Níveis de autenticação</title></info>
<para>
(esta seção contém algumas explicações que dependem do resto do conteúdo do
guia, caso não entenda de imediato a fundo as explicações, recomendo que a leia
novamente mais tarde).
</para>
<variablelist>
<varlistentry>
<term/>
<listitem>
<para>
Define o nível de segurança do servidor.  Os seguintes valores são válidos:
</para>
<itemizedlist>
<listitem>
<para>
<literal>share</literal> - Usada principalmente quando apenas a senha é enviada
por compartilhamento acessado para o servidor, caso muito típico em sistemas
<command>Lan Manager</command> e <command>Windows for Workgroups</command>.
</para>
<para>
Mesmo assim o samba tenta mapear para um UID de usuário local do sistema usando
os seguintes métodos (retirado da página de manual do samba):
</para>
<orderedlist numeration="arabic">
<listitem>
<para>
Se o parâmetro <literal>guest only</literal> é usado no compartilhamento junto
com o <literal>guest ok</literal>, o acesso é imediatamente permitido, sem
verificar inclusive a senha.
</para>
</listitem>
<listitem>
<para>
Caso um nome de usuário seja enviado junto com a senha, ele é utilizado para
mapear o UID e aplicar as permissões deste usuário (como acontece no nível de
segurança <emphasis>user</emphasis>).
</para>
</listitem>
<listitem>
<para>
Se ele usou um nome para fazer o logon no <command>Windows</command> este nome
será usado como usuário local do SAMBA.  Caso ele seja diferente, você deverá
usar o mapeamento de nomes para associar o nome remoto do nome local (veja
<xref linkend="s-samba-a-usernamemap"/>)
</para>
</listitem>
<listitem>
<para>
O nome do serviço é tentado como nome de usuário.
</para>
</listitem>
<listitem>
<para>
O nome da máquina NetBios é tentada como nome de usuário
</para>
</listitem>
<listitem>
<para>
Os usuários especificados na opção <literal>user</literal> do compartilhamentos
são utilizados (veja <xref linkend="s-samba-s-a-param"/>).
</para>
</listitem>
<listitem>
<para>
Caso nenhum destes métodos acima for satisfeito, o acesso é NEGADO.
</para>
</listitem>
</orderedlist>
<para>
Hoje em dia, o uso do nível de acesso <literal>share</literal> é raramente
usado, porque todos os sistemas a partir do <command>Windows 95</command> e
acima enviam o nome de usuário ao acessar um compartilhamento (caindo na
segunda checagem do nível <emphasis>share</emphasis>), sendo equivalente a usar
o nível <emphasis>user</emphasis>.  Entretanto, o nível de segurança
<emphasis>share</emphasis> é recomendado para servidores onde TODO o conteúdo
deve ter acesso público (seja leitura ou gravação) e o parâmetro <literal>guest
shares</literal> também funciona nativamente.
</para>
<para>
As senhas criptografadas (<literal>encrypt passwords = 1</literal>) <emphasis role="strong">NÃO</emphasis> funcionarão no nível <emphasis>share</emphasis>,
lembre-se deste detalhe.
</para>
</listitem>
<listitem>
<para>
<literal>user</literal> - Este é o padrão.  O usuário precisa ter uma conta de
usuário no <command>Linux</command> para acessar seus compartilhamentos.  A
mesma conta de usuário/senha deverá ser usada no <command>Windows</command>
para acessar seus recursos ou realizado um mapeamento de nomes de usuários
(veja <xref linkend="s-samba-a-usernamemap"/>).  Este é o padrão do SAMBA.  No
nível de acesso <emphasis>user</emphasis> o usuário precisa ser autenticado de
qualquer forma, inclusive se for usado o parâmetro <literal>guest
only</literal> ou <literal>user</literal>.  Os seguintes passos são usados para
autorizar uma conexão usando o nível <emphasis>user</emphasis> (retirado da
documentação do SAMBA):
</para>
<itemizedlist>
<listitem>
<para>
É tentada a validação usando o nome/senha passados pelo cliente.  Se tudo
estiver OK, a conexão é permitida.
</para>
</listitem>
<listitem>
<para>
Caso já tenha se autenticado anteriormente para acessar o recurso e forneceu a
senha correta, o acesso é permitido.
</para>
</listitem>
<listitem>
<para>
O nome NetBIOS da máquina do cliente e qualquer nome de usuário que foi usado é
novamente tentado junto com a senha para tentar permitir o acesso ao recurso
compartilhado.
</para>
</listitem>
<listitem>
<para>
Caso o cliente tenha validado o nome/senha com o servidor e o cliente enviou
novamente o token de validação, este nome de usuário é usado.
</para>
</listitem>
<listitem>
<para>
É tentada a checagem com o parâmetro <emphasis>user</emphasis> no
compartilhamento (veja <xref linkend="s-samba-s-a-param"/>.
</para>
</listitem>
<listitem>
<para>
É verificado se o serviço é público, então a conexão é feita usando o usuário
<literal>guest account</literal> e ignorando a senha (veja <xref linkend="s-samba-a-publico"/>).
</para>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<para>
<literal>domain</literal> - Neste nível, o acesso só será permitido quando a
máquina for adicionada ao domínio com o <command>smbpasswd</command> (<xref linkend="s-samba-c-dominio-linux"/>).  Neste nível de acesso, a conta de
usuário será validada em um servidor PDC (controlador de domínio) e o acesso
aos recursos das máquinas que fazem parte do domínio será feito a partir do
PDC.  Veja <xref linkend="s-samba-c-dominio-linux"/> para detalhes.
</para>
</listitem>
<listitem>
<para>
<literal>server</literal> - A máquina samba tentara autenticar o usuário em
outro servidor NT (ou samba).  No caso da autenticação falhar, será usado o
nível de acesso <emphasis>user</emphasis> na base de usuários local (será
necessário o arquivo de senhas criptografado do samba para que a autenticação
local funcione, veja <xref linkend="s-samba-senhas-crypto"/>).  Este nível é
bastante usado quando configuramos um servidor de perfis de usuários ou logon
separado do PDC.
</para>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>

<section xml:id="s-samba-s-global-log"><info><title>Log de acessos/serviços</title></info>
<variablelist>
<varlistentry>
<term>log file= [arquivo]</term>
<listitem>
<para>
Define a localização e nome do arquivo de log gerado pelo samba.  As variáveis
de expansão podem ser usadas caso o administrador queira ter um melhor controle
dos logs gerados (veja <xref linkend="s-samba-s-varsubst"/>).
</para>
<para>
Ex.: <literal>/var/log/samba/samba-log-%m</literal>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Se possível coloque uma extensão no
arquivo de log gerado pelo <command>SAMBA</command> (como
<filename>.log</filename>).  O motivo disto é porque se estes logs forem
rotacionados pelo <command>logrotate</command> você terá problemas de
recompactação múltiplas caso utilize um coringa
<filename>samba-log-*</filename>, gerando arquivos como
<filename>.gz.gz.gz..</filename>, lotando a tabela de arquivos do diretório e
deixando sua máquina em um loop de compactação.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>max log size = [tamanho]</term>
<listitem>
<para>
Especifica o tamanho máximo em Kb do arquivo de log gerado pelo samba.  O valor
padrão é 5000Kb (5MB).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>debug pid = [valor]</term>
<listitem>
<para>
Este processo adiciona a pid aos logs gerados pelo processo
<command>smbd</command> Isto é útil para depuração caso existam múltiplos
processos rodando.  O valor padrão é <emphasis>no</emphasis> e a opção
<emphasis>debug timestamp</emphasis> deve ser <literal>yes</literal> para esta
opção ter efeito.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>debug timestamp = [valor]</term>
<listitem>
<para>
Ativa ou desativa a gravação de data/hora nos arquivos de log gerados pelo
samba.  O valor padrão é <literal>yes</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>debug level = [valor]</term>
<listitem>
<para>
Aumenta o nível de depuração dos daemons do SAMBA de <literal>0</literal> a
<literal>9</literal>.  Um nível de depuração interessante e que produz uma
quantidade razoável de dados para configuração de um
<command>logrotate</command> só para o SAMBA é o <literal>2</literal>,
produzindo a lista de todos os compartilhamentos acessados, quem acessou,
data/hora (dependendo das outras opções de depuração).  Isto permite ao
administrador saber exatamente o que está sendo acessado e por quem, quais as
tentativas de acesso.  Assim terá certeza que o conteúdo não está sendo
acessado indevidamente.  O nível de depuração <literal>0</literal> é o padrão.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>debug uid = [valor]</term>
<listitem>
<para>
Este parâmetro inclui o euid, egid, uid, gid nos arquivos de log.  O valor
padrão é <literal>no</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>lock directory = [diretório]</term>
<listitem>
<para>
Define onde serão gravados os arquivos de lock gerados pelo samba.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section xml:id="s-samba-s-global-browsing"><info><title>Navegação no servidor/tipo de servidor</title></info>
<variablelist>
<varlistentry>
<term>os level=[num]</term>
<listitem>
<para>
Especifica o nível do sistema operacional.  Este número é usado para as
eleições netbios para definir o navegador de grupo local e controlador de
domínio (veja <xref linkend="s-samba-s-oslevel"/> para detalhes).  O valor pode
ser de 0 a 255, o padrão é 32.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>announce as = [sistema]</term>
<listitem>
<para>
Selecione o nome que o <command>samba</command> (<command>nmbd</command>) se
anunciará na lista de pesquisa de rede.  Os seguintes nomes podem ser usados:
</para>
<itemizedlist>
<listitem>
<para>
<literal>NT Server (ou NT)</literal> - Anuncia como <emphasis>Windows NT
Server</emphasis>.  Este é o padrão.
</para>
</listitem>
<listitem>
<para>
<literal>NT Workstation</literal> - Anuncia-se como um <emphasis>NT
Workstation</emphasis>.
</para>
</listitem>
<listitem>
<para>
<literal>Win95 ou WfW</literal> - Anuncia-se na rede como uma estação
<emphasis>Windows 9x</emphasis>, <emphasis>Windows for Workgroups</emphasis>,
<emphasis>Windows NT Server</emphasis> e <emphasis>Windows NT
Workstation</emphasis> de uma só vez.
</para>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>domain master = [valor]</term>
<listitem>
<para>
Diz se o servidor tentará se tornar o navegador principal de domínio.  Os
valores que podem ser especificados são: <literal>yes, no e auto</literal>.  O
valor padrão é <literal>auto</literal>.  Veja <xref linkend="s-samba-dom-dmbrowser"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>local master = [valor]</term>
<listitem>
<para>
Diz se o servidor participará ou não das eleições para navegador local do grupo
de trabalho (workgroup).  Os valores que podem ser especificados são:
<literal>yes, no</literal>.  O valor padrão é <literal>yes</literal>.  Para
vencer a eleição, o samba precisa ter o valor de <literal>os level</literal>
maior que os demais.
</para>
<para>
Note também que o Windows NT não aceita perder as eleições e convoca uma nova
eleição caso ele perca.  Como esta eleição é feita via broadcasting, isso gera
um tráfego grande na rede.  Desta forma, se tiver um computador NT na rede
configure este valor para "no".  Veja <xref linkend="s-samba-dom-lmbrowser"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>preferred master = [valor]</term>
<listitem>
<para>
Diz se o servidor samba terá ou não vantagens de ganhar uma eleição local.  Se
estiver configurado para "yes", o servidor samba pedirá uma eleição e terá
vantagens para ganha-la.  O servidor poderá se tornar garantidamente o
<emphasis>navegador principal do domínio</emphasis> se esta opção for usada em
conjunto com <emphasis>domain master = 1</emphasis>.  Os valores especificados
podem ser <literal>yes, no e auto</literal>, o padrão é
<literal>auto</literal>.
</para>
<para>
Antes de ajustar este valor para <literal>yes</literal>, verifique se existem
outros servidores NetBIOS em sua rede que tem preferência para se tornar o
master principal, pois poderá ocorrer um tráfego alto de broadcasting causado
pelas eleições solicitadas pelas outras máquinas.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section xml:id="s-samba-s-global-outras"><info><title>Outros parâmetros de configuração</title></info>
<variablelist>
<varlistentry>
<term><literal>include</literal></term>
<listitem>
<para>
Inclui um outro arquivo de configuração na porção atual do arquivo de
configuração.  Você pode utilizar variáveis de substituição, exceto
<literal>%u</literal>, <literal>%P</literal> e <literal>%S</literal> (veja
<xref linkend="s-samba-s-varsubst"/>).
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

</section>

<section xml:id="s-samba-s-homes"><info><title>Seção <literal>[homes]</literal></title></info>
<para>
Esta seção tem a função especial de disponibilizar o diretório home do usuário.
Quando o usuário envia seu nome de login como compartilhamento é feita uma
busca no arquivo <filename>smb.conf</filename> procurando por um nome de
compartilhamento que confira.  Caso nenhum seja encontrado, é feita uma busca
por um nome de usuário correspondente no arquivo
<filename>/etc/passwd</filename>, se um nome conferir e a senha enviada também,
o diretório de usuário é disponibilizado como um compartilhamento com o mesmo
nome do usuário local.  O diretório home do usuário poderá ser modificado com o
uso de mapeamento de nomes, veja <xref linkend="s-samba-a-usernamemap"/>.
Quando o caminho do compartilhamento não for especificado, o SAMBA utilizará o
diretório home do usuário (no <filename>/etc/passwd</filename>).
</para>
<para>
Para maior segurança da instalação, principalmente porque o diretório home do
usuário não é um requerimento para a autenticação de usuário, recomendo usar a
variável de substituição <literal>%S</literal> apontando para um diretório com
as permissões apropriadas configuradas em seu sistema, por exemplo:
</para>
<screen>
 [homes]
  comment = Diretórios de Usuários
  path=/pub/usuarios/%S
</screen>
<para>
Você apenas terá o trabalho extra de criar os diretórios de usuários que farão
acesso ao sistema.  Isto não será nenhum problema após você programar um shell
script simples que verifique os nomes de contas em
<filename>/etc/passwd</filename> e crie os diretórios com as permissões/grupos
adequados (isso não será abordado por este capítulo do guia, embora não seja
complicado).  Se deseja, existem exemplos em <xref linkend="s-samba-exemplos"/>
sobre a seção <emphasis>[homes]</emphasis> no arquivo de configuração.
</para>
<para>
Os parâmetros aceitos em <emphasis>[homes]</emphasis> aqui são os mesmos usados
para compartilhamentos normais (veja <xref linkend="s-samba-s-a-param"/>).
Abaixo segue mais um exemplo de seção <emphasis>[homes]</emphasis>:
</para>
<screen>
[homes] 
comment = Diretório home de usuários
writable = yes
public = no
invalid users = root nobody @adm
follow symlinks = no
create mode = 0640
directory mode = 0750
</screen>
<para>
A explicação de cada um dos parâmetros podem ser encontradas em <xref linkend="s-samba-s-a-param"/>.  O guia está com os parâmetros bem organizados
em seções específicas, apenas de uma olhada para entender com o capítulo do
SAMBA foi organizado e não terá dificuldades de se localizar.
</para>
<para>
<emphasis role="strong">OBS1:</emphasis>Caso nenhum caminho de compartilhamento
seja utilizado, o diretório home do usuário será compartilhado.
</para>
<para>
<emphasis role="strong">OBS2:</emphasis>Não utilize o parâmetro
<emphasis>public yes</emphasis> na seção guest, caso contrário todos os
diretórios de usuários serão lidos por todos.  Veja <xref linkend="s-samba-a-public-access"/> para maiores detalhes.
</para>
</section>

<section xml:id="s-samba-s-printers"><info><title>Seção <literal>[printers]</literal></title></info>
<para>
Esta seção tem a função de disponibilizar as impressoras existentes no sistema
(lp, lp1, lp2, etc) existentes no <filename>/etc/printcap</filename> como
compartilhamento de sistemas Windows.  O método que os nomes de impressoras são
pesquisados é idêntico a forma feita para a seção <emphasis>[homes]</emphasis>:
Primeiro o nome do compartilhamento é pesquisado como um nome de serviço,
depois se ele é um nome de usuário (tentando mapear o serviço disponibilizado
em [homes]), depois será verificado a seção <emphasis>[printers]</emphasis>.
</para>
<para>
Ao invés de usar este recurso, se preferir você poderá compartilhar as
impressoras individualmente.  Para detalhes, veja <xref linkend="s-samba-i-win-linux"/>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis>É importante lembrar que a seção
<emphasis>[printers]</emphasis> <emphasis role="strong">DEVE</emphasis> ser
definida como <literal>printable</literal> usando o parâmetro
<emphasis>printable = yes</emphasis> para funcionar.  O utilitário
<command>testparm</command> poderá ser usado para verificar problemas no
arquivo cd configuração do SAMBA (veja <xref linkend="s-samba-s-testparm"/>).
</para>
</section>

<section xml:id="s-samba-s-testparm"><info><title>Buscando problemas na configuração</title></info>
<para>
Durante o processo de configuração do SAMBA, é comum cometer erros de
digitação, usar parâmetros em lugares indevidos, etc.  É recomendável o uso do
<command>testparm</command> para checar a configuração do SAMBA sempre que
houver modificações para ter certeza nada comprometa o funcionamento que
planejou para sua máquina.
</para>
<para>
Para usar o <command>testparm</command> é só digitar
<literal>testparm</literal>.  Logo após executa-lo, analise se existem erros
nas seções de configuração e te pedirá para pressionar &lt;ENTER&gt; para ver
um dump do arquivo:
</para>
<screen>
Load smb config files from /etc/samba/smb.conf
Processing section "[homes]"
Processing section "[printers]"
Processing section "[tmp]"
Processing section "[cdrom]"
Loaded services file OK.
Press enter to see a dump of your service definitions
</screen>
<para>
A saída acima indica que está tudo OK com todas as configurações que foram
realizadas no servidor.  É possível especificar um outro arquivo de
configuração do SAMBA usando <literal>testparm /etc/samba/smb2.conf</literal>.
</para>
<para>
Também é permitido simular o nome NetBIOS que fará acesso a máquina usando o
parâmetro <literal>-L nome</literal> (que será substituído na variável
<replaceable>%L</replaceable>).
</para>
</section>

<section xml:id="s-samba-s-oslevel"><info><title>Níveis de sistema para eleição de rede</title></info>
<para>
Para selecionar qual sistema NetBIOS será o local master browse ou domain
master browse, é usado um método bastante interessante: o de eleições.
</para>
<para>
Quando uma nova máquina entra na rede NetBIOS, ela solicita quem é o Local
Master Browser, caso nenhuma responda, ela força uma eleição na rede através de
uma requisição Broadcasting especial.  Vence a eleição quem tiver o ***maior
número***, chamado de OS Level (nível de sistema operacional).  Caso duas
máquinas empatem, o desempate é feito usando outros critérios.
</para>
<para>
Se você for a única máquina de um workgroup, automaticamente você será o Local
Master Browser.  De meia em meia hora uma nova eleição é feita, forçando mais
tráfego broadcasting na rede.  Durante este novo processo de eleição, a lista
de computadores é atualizada; as novas máquinas são adicionadas e as desligadas
saem da lista após 36 minutos.  Este é o motivo porque as máquinas Windows
continuam aparecendo no ambiente de rede por algum tempo mesmo depois que
desligadas ou porque elas não aparecem de imediato.
</para>
<para>
O OS Level é um número que é característico de cada sistema operacional ficando
entre 0 (mais baixo) e 255.  Os níveis de acessos dos sistemas operacionais são
os seguintes:
</para>
<screen>
Windows for Workgroups                         1
Windows 95                                     1
Windows 98                                     2
Windows 98 Second Edition                      2


Windows 2000 Server (standalone)               16
Windows 2000 Professional                      16
Windows NT 4.0 Wks                             17
Windows NT 3.51 Wks                            16


Windows NT 3.51 Server                         32
Windows NT 4.0 Server                          33
Windows 2000 Server (Domain Controller)        32

SAMBA                                          32
</screen>
<para>
O valor padrão do OS Level do SAMBA é 32, entretanto ele é bastante flexível
para permitir sua mudança através do parâmetro "os level" (veja <xref linkend="s-samba-s-global-browsing"/>), isto garante que o SAMBA sempre vença
as eleições da rede sobre qualquer outro sistema operacional.
</para>
<para>
No caso de um servidor que estiver configurado para ser o navegador de rede,
assim que for iniciado ele solicitará uma eleição de rede.  As regras são as
mesmas, vence o que tiver o *maior* número.  Este número pode ser configurado
facilmente no SAMBA para que ele sempre vença as eleições de rede, tomando
conta da lista de máquinas.  Isto é especialmente interessante por causa da
estabilidade do servidor <command>Linux</command>, quando migramos de servidor
NT ou para fornecer mais serviços de navegação, como servidor WINS.
</para>
<para>
<emphasis role="strong">OBS</emphasis>: Nunca deixe um servidor NT configurado
para ser o Local Browser ou Domain Master Browser competir com o SAMBA.  Mesmo
que o SAMBA ganhe, o NT é um péssimo perdedor e convoca uma nova eleição para
tentar novamente se eleger, gerando um *extremo* tráfego broadcasting em redes
grandes.
</para>
</section>

<section xml:id="s-samba-s-varsubst"><info><title>Variáveis de substituição</title></info>
<para>
Esta seção foi baseada nos dados da página de manual do samba, com adições que
não estavam presentes na versão original e exemplos.  Existem variáveis
especiais que podem ser usadas no arquivo de configuração do samba e são
substituídas por parâmetros especiais no momento da conexão do usuário.  Um
exemplo de utilização de variáveis de substituição seria mudar a localização do
diretório home do usuário:
</para>
<screen>
[homes]
 comment = Diretório home do usuário
 path = /home/usuarios/%u
</screen>
<para>
Cada uma das variáveis são descritas em detalhes abaixo:
</para>
<variablelist>
<varlistentry>
<term>%S</term>
<listitem>
<para>
O nome do serviço atual, se existir.  Seu uso é interessante, principalmente no
uso de diretórios homes.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%P</term>
<listitem>
<para>
O diretório raíz do serviço atual, se existir.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%u</term>
<listitem>
<para>
O nome de usuário do serviço atual, se aplicável.  Esta variável é bastante
útil para programação de scripts e também para criar arquivos de log
personalizados, etc.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%g</term>
<listitem>
<para>
O grupo primário do usuário %u.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%U</term>
<listitem>
<para>
O nome de usuário da seção (o nome de usuário solicitado pelo cliente, não é
uma regra que ele será sempre o mesmo que ele recebeu).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%G</term>
<listitem>
<para>
O nome do grupo primário de %U.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%H</term>
<listitem>
<para>
O diretório home do usuário, de acordo com %u.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%v</term>
<listitem>
<para>
A versão do Samba.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%h</term>
<listitem>
<para>
O nome DNS da máquina que está executando o Samba.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%m</term>
<listitem>
<para>
O nome NetBIOS da máquina do cliente.  Isto é muito útil para log de conexões
personalizados e outras coisas úteis.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%L</term>
<listitem>
<para>
O nome NetBIOS do servidor.  Como o servidor pode usar mais de um nome no samba
(aliases), você poderá saber com qual nome o seu servidor está sendo acessado e
possivelmente torna-lo o nome primário de sua máquina.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%M</term>
<listitem>
<para>
O nome DNS da máquina cliente.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%N</term>
<listitem>
<para>
O nome do seu servidor de diretórios home NIS.  Este parâmetro é obtido de uma
entrada no seu arquivo auto.map.  Se não tiver compilado o SAMBA com a opção
<literal>--with-automount</literal> então este valor será o mesmo de %L.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%p</term>
<listitem>
<para>
O caminho do diretório home do serviço, obtido de uma entrada mapeada no
arquivo <filename>auto.map</filename> do NIS.  A entrada NIS do arquivo
<filename>auto.map</filename> é dividida na forma "%N:%p".
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%R</term>
<listitem>
<para>
O nível de protocolo selecionado após a negociação.  O valor retornado pode ser
CORE, COREPLUS, LANMAN1, LANMAN2 ou NT1.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%d</term>
<listitem>
<para>
A identificação de processo do processo atual do servidor.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%a</term>
<listitem>
<para>
A arquitetura da máquina remota.  Somente algumas são reconhecidas e a resposta
pode não ser totalmente confiável.  O <command>samba</command> atualmente
reconhece <emphasis>Samba</emphasis>, <emphasis>Windows for
Workgroups</emphasis>, <emphasis>Windows 95</emphasis>, <emphasis>Windows
NT</emphasis> e <emphasis>Windows 2000</emphasis>.  Qualquer outra coisa será
mostrado como "UNKNOWN" (<emphasis>desconhecido</emphasis>).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%I</term>
<listitem>
<para>
O endereço IP da máquina do cliente.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%T</term>
<listitem>
<para>
A data e hora atual.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%$(var_ambiente)</term>
<listitem>
<para>
Retorna o valor da <emphasis>variável de ambiente</emphasis> especificada.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

</section>

