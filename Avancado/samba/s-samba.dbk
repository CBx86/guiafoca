<?xml version='1.0' encoding='utf-8'?>
<!-- -*- DocBook -*- -->
<chapter id="s-samba"><title>SAMBA</title>
<para>
Este capítulo descreve a configuração, utilização, aplicação, integração de
redes <command>Windows</command> e <command>Linux</command> através do
<command>SAMBA</command>.  Entre as explicações de cada opção, são passados
detalhes importantes relacionados com seu funcionamento, performance e impactos
de segurança sobre o servidor como um todo.
</para>
<para>
Uma seção foi especialmente separada para os mais paranóicos (como eu)
conhecerem, combinar e aplicar as restrições de forma mais adequada a
configuração da máquina.
</para>
<section id="s-samba-intro"><title>Introdução</title>
<para>
O <command>SAMBA</command> é um servidor e conjunto de ferramentas que permite
que máquinas <command>Linux</command> e <command>Windows</command> se
comuniquem entre si, compartilhando serviços (arquivos, diretório, impressão)
através do protocolo SMB (Server Message Block)/CIFS (Common Internet File
System), equivalentes a implementação NetBEUI no Windows.  O
<command>SAMBA</command> é uma das soluções em ambiente UNIX capaz de
interligar redes heterogênea.
</para>
<para>
Na lógica da rede Windows o <command>NetBEUI</command> é o protocolo e o
<command>NETBIOS</command> define a forma com que os dados são transportados.
Não é correto dizer que o <command>NetBIOS</command> é o protocolo, como muitos
fazem.
</para>
<para>
Com o <command>SAMBA</command>, é possível construir domínios completos, fazer
controle de acesso a nível de usuário, compartilhamento, montar um servidor
WINS, servidor de domínio, impressão, etc.  Na maioria dos casos o controle de
acesso e exibição de diretórios no samba é mais minucioso e personalizável que
no próprio Windows.
</para>
<para>
O guia Foca GNU/Linux documentará como instalar e ter as máquinas Windows de
diferentes versões (<command>Win3.11, Win95, Win95OSR/2, Win98, XP, WinNT,
W2K</command>) acessando e comunicando-se entre si em uma rede NetBEUI.  Estas
explicações lhe poderão ser indispensáveis para solucionar problemas, até mesmo
se você for um técnico especialista em redes Windows e não tem ainda planos de
implementar um servidor SAMBA em sua rede.
</para>
<section id="s-samba-versao"><title>Versão documentada</title>
<para>
A versão do servidor samba documentada neste capítulo do guia é a 2.2.
</para>
</section>

<section id="s-samba-historia"><title>História</title>
<para>
Andrew Tridgell - Desenvolveu o samba porque precisava montar um volume Unix em
sua máquina DOS.  Inicialmente ele utilizava o NFS, mas um aplicativo precisava
de suporte NetBIOS.  Andrew então utilizou um método muito avançado usado por
administradores para detectar problemas: escreveu um sniffer de pacotes que
atendesse aos requerimentos para ter uma única função: analisar e auxilia-lo a
interpretar todo o tráfego NetBIOS da rede.
</para>
<para>
Ele escreveu o primeiro código que fez o servidor Unix aparecer como um
servidor de arquivos Windows para sua máquina DOS que foi publicado mais ou
menos em meados de 1992 quando também começou a receber patches.  Satisfeito
com o funcionamento de seu trabalho, deixou seu trabalho de lado por quase 2
anos.  Um dia, ele resolveu testar a máquina Windows de sua esposa com sua
máquina Linux, e ficou maravilhado com o funcionamento do programa que criou e
veio a descobrir que o protocolo era documentado e resolveu levar este trabalho
a fundo melhorando e implementando novas funções.
</para>
<para>
O SAMBA atualmente é um servidor fundamental para a migração de pequenos grupos
de trabalho à grandes domínios com clientes mixtos.  Nenhum servidor de rede
NetBEUI conhecido proporciona tanta flexibilidade de acesso a clientes como o
SAMBA para compartilhamento de arquivos/impressão em rede.  As funções de
segurança que foram adicionadas ao SAMBA hoje garantem um controle mais
rigoroso que a própria implementação usada no Windows NT, incluindo o serviços
de diretórios, mapeamento entre IDs de usuários Windows com Linux, PDC, perfis
móveis e uma coisa que inclusive apresenta problemas no Windows:
compatibilidade total entre as diferentes implementações de versões do Windows.
</para>
<para>
Sua configuração pode receber ajustes finos pelo administrador nos soquetes TCP
de transmissão, recepção, cache por compartilhamento, configurações físicas que
afetam a performance de rede.  Seu código vem sendo melhorado constantemente
por hackers, obtendo excelente performance com hardwares mais obsoletos.  O
guia tem por objetivo abordar estes temas e permitir que você configure seu
sistema com uma performance batendo a mesma alcançada em um servidor NT
dedicado.
</para>
</section>

<section id="s-samba-contribuindo"><title>Contribuindo</title>
<para>
Para contribuir com o desenvolvimento do samba, veja os detalhes na página:
http://us1.samba.org/samba/devel/
</para>
<para>
Caso encontre um bug no programa, ele poderá ser relatado se inscrevendo na
lista de discussão samba-technical-request@lists.samba.org.  Após responder a
mensagem de confirmação, envie um relato detalhado do problema encontrado no
programa.
</para>
</section>

<section id="s-samba-caracteristicas"><title>Características</title>
<para>
Segue abaixo algumas funcionalidades importantes de aplicações do samba e seu
conjunto de ferramentas:
</para>
<itemizedlist>
<listitem>
<para>
Compartilhamento de arquivos entre máquinas <command>Windows</command> e
<command>Linux</command> ou de máquinas <command>Linux</command> (sendo o
servidor SAMBA) com outro SO que tenha um cliente NetBEUI (Macintosh, OS/2,
LanManager, etc).
</para>
</listitem>
<listitem>
<para>
Montar um servidor de compartilhamento de impressão no <command>Linux</command>
que receberá a impressão de outras máquinas <command>Windows</command> da rede.
</para>
</listitem>
<listitem>
<para>
Controle de acesso aos recursos compartilhados no servidor através de diversos
métodos (compartilhamento, usuário, domínio, servidor).
</para>
</listitem>
<listitem>
<para>
Controle de acesso leitura/gravação por compartilhamento.
</para>
</listitem>
<listitem>
<para>
Controle de acesso de leitura/gravação por usuário autenticado.
</para>
</listitem>
<listitem>
<para>
Possibilidade de definir contas de "Convidados", que podem se conectar sem
fornecer senha.
</para>
</listitem>
<listitem>
<para>
Possibilidade de uso do banco de dados de senha do sistema
(<filename>/etc/passwd</filename>), autenticação usando o arquivo de dados
criptografados do samba, LDAP, PAM, etc.
</para>
</listitem>
<listitem>
<para>
Controle de cache e opções de tunning por compartilhamento.
</para>
</listitem>
<listitem>
<para>
Permite ocultar o conteúdo de determinados diretórios que não quer que sejam
exibidos ao usuário de forma fácil.
</para>
</listitem>
<listitem>
<para>
Possui configuração bastante flexível com relação ao mapeamento de nomes DOS =>
UNIX e vice versa, página de código, acentuação, etc.
</para>
</listitem>
<listitem>
<para>
Permite o uso de aliases na rede para identificar uma máquina com outro nome e
simular uma rede NetBIOS virtual.
</para>
</listitem>
<listitem>
<para>
O <command>samba</command> possibilita ajuste fino nas configurações de
transmissão e recepção dos pacotes TCP/IP, como forma de garantir a melhor
performance possível de acordo com suas instalações.
</para>
</listitem>
<listitem>
<para>
Permite o uso do gerenciador de mensagem do Linux (<command>Linpopup</command>)
para a troca de mensagens com estações <command>Windows</command> via
<literal>NetBios</literal>.  Com a flexibilidade do <command>samba</command> é
possível até redirecionar a mensagem recebida via e-mail ou pager.
</para>
</listitem>
<listitem>
<para>
Possui suporte completo a servidor WINS (também chamado de
<emphasis>NBNS</emphasis> - <emphasis>NetBios Name Service</emphasis>) de rede.
A configuração é bastante fácil.
</para>
</listitem>
<listitem>
<para>
Faz auditoria tanto dos acessos a pesquisa de nomes na rede como acesso a
compartilhamentos.  Entre os detalhes salvos estão a data de acesso, IP de
origem, etc.
</para>
</listitem>
<listitem>
<para>
Suporte completo a controlador de domínio Windows (PDC).
</para>
</listitem>
<listitem>
<para>
Suporte quase completo a backup do controlador de domínio (BDC).  Até a versão
2.2 do <command>samba</command>, o suporte a BDC é parcial.  Este código
provavelmente estará estável até a versão 3.0.
</para>
</listitem>
<listitem>
<para>
Permite montar unidades mapeadas de sistemas <command>Windows</command> ou
outros servidores <command>Linux</command> como um diretório no
<command>Linux</command>.
</para>
</listitem>
<listitem>
<para>
Permite a configuração de recursos simples através de programas de configuração
gráficos, tanto via sistema, como via web.
</para>
</listitem>
<listitem>
<para>
Permite executar comandos no acesso ao compartilhamento ou quando o acesso ao
compartilhamento é finalizado.
</para>
</listitem>
<listitem>
<para>
Com um pouco de conhecimento e habilidade de administração de sistemas
<command>Linux</command>, é possível criar ambientes de auditoria e monitoração
até monitoração de acesso a compartilhamento em tempo real.
</para>
</listitem>
<listitem>
<para>
Entre outras possibilidades.
</para>
</listitem>
</itemizedlist>
</section>

<section id="s-samba-ficha"><title>Ficha técnica</title>
<para>
Pacote <systemitem role="package">samba</systemitem>
</para>
<para>
Outros utilitários importantes para a operação do clientes
<command>samba</command>.
</para>
<itemizedlist>
<listitem>
<para>
<literal>smbclient</literal> - Ferramenta para navegação e gerenciamento de
arquivos, diretórios e impressoras compartilhados por servidores
<command>Windows</command> ou <command>samba</command>.
</para>
</listitem>
<listitem>
<para>
<literal>smbfs</literal> - Pacote que possui ferramentas para o mapeamento de
arquivos e diretórios compartilhados por servidores <command>Windows</command>
ou <command>samba</command> em um diretório local.
</para>
</listitem>
<listitem>
<para>
<literal>winbind</literal> - Daemon que resolve nomes de usuários e grupo
através de um servidor NT/SAMBA e mapeia os UIDs/GIDs deste servidor como
usuários locais.
</para>
</listitem>
</itemizedlist>
</section>

<section id="s-samba-hwreq"><title>Requerimentos de Hardware</title>
<para>
Processador 386 ou superior, 15 MB de espaço em disco (não levando em conta os
logs gerados e espaço para arquivos de usuários, aplicativos, etc.), 8 MB de
memória RAM.
</para>
</section>

<section id="s-samba-logs"><title>Arquivos de log criados</title>
<para>
O daemon nmbd salva seus logs em /var/log/daemon.log (dependendo da diretiva de
configuração <emphasis>syslog</emphasis> do arquivo smb.conf) e em
<filename>/var/log/samba/log.nmbd</filename>.  Os detalhes de acesso a
compartilhamento são gravados no arquivo
<filename>/var/log/samba/log.smbd</filename> (que pode ser modificado de acordo
com a diretiva <emphasis>log file</emphasis> no <filename>smb.conf</filename>,
<xref linkend="s-samba-s-global-log"/>).
</para>
</section>

<section id="s-samba-install"><title>Instalação</title>
<para>
Digite <literal>apt-get install samba smbclient smbfs</literal> para instalar o
conjunto de aplicativos samba.  O pacote <systemitem
role="package">samba</systemitem> é o servidor samba e os pacotes <systemitem
role="package">smbclient</systemitem> e <systemitem
role="package">smbfs</systemitem> fazem parte dos aplicativos cliente.  Caso
deseje apenas mapear compartilhamentos remotos na máquina Linux, instale
somente os 2 últimos pacotes.
</para>
</section>

<section id="s-samba-rodando"><title>Iniciando o servidor/reiniciando/recarregando a configuração</title>
<para>
O servidor samba pode ser executado tanto via inetd como daemon:
</para>
<variablelist>
<varlistentry>
<term>inetd</term>
<listitem>
<para>
No modo inetd, o servidor de nomes <emphasis>nmbd</emphasis> será carregado
assim que for feita a primeira requisição de pesquisa e ficará residente na
memória.  No caso de acesso a um compartilhamento, o <emphasis>smbd</emphasis>
será carregado e lerá a configuração em <filename>smb.conf</filename> a cada
acesso do cliente a um compartilhamento.  Quando o <command>samba</command>
opera via inetd, ele não usa o controle de acesso dos arquivos
<filename>hosts.allow</filename> e <filename>hosts.deny</filename>.  Veja <xref
linkend="s-samba-a-restrip"/> e <xref linkend="s-samba-a-restrif"/> para
detalhes de como fazer o controle de acesso.
</para>
<para>
Para reiniciar o samba digite <literal>killall -HUP nmbd</literal>.  Não é
necessário reiniciar o serviço <literal>smbd</literal>, conforme foi explicado
acima.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>daemon</term>
<listitem>
<para>
Quando opera no modo <emphasis>daemon</emphasis>, ambos os daemons
<command>nmbd</command> e <command>smbd</command> são carregados.  No caso de
um acesso a compartilhamento, é criado um processo filho do
<command>smbd</command> que é finalizado assim que o compartilhamento não for
mais usado.
</para>
<para>
Para iniciar o samba em modo <literal>daemon</literal> digite:
<literal>/etc/init.d/samba start</literal>, para interromper o samba:
<literal>/etc/init.d/samba stop</literal> e para reiniciar:
<literal>/etc/init.d/samba restart</literal>.
</para>
</listitem>
</varlistentry>
</variablelist>
<para>
Se desejar mudar do modo <emphasis>daemon</emphasis> para
<emphasis>inetd</emphasis> ou vice versa, edite o arquivo
<filename>/etc/default/samba</filename> e modifique o valor da linha
<literal>RUN_MODE=</literal> para <literal>daemons</literal> ou
<literal>inetd</literal>.  Uma forma de fazer isso automaticamente é executando
o <literal>dpkg-reconfigure samba</literal>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Como praticamente não existe diferença
entre os modos de operação <emphasis>inetd</emphasis> e
<emphasis>daemon</emphasis> para o <command>SAMBA</command>, é aconselhável que
execute sempre que possível via <emphasis>inetd</emphasis>, pois isto garantirá
uma disponibilidade maior do serviço caso algo aconteça com um dos processos.
</para>
</section>

<section id="s-samba-opcoescmd"><title>Opções de linha de comando</title>
<para>
Opções de linha de comando usadas pelo <command>nmbd</command>:
</para>
<variablelist>
<varlistentry>
<term>-H [arquivo_lmhosts]</term>
<listitem>
<para>
Quando especificado, o servidor samba fará a procura de nomes primeiro neste
arquivo e depois usando a rede.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>-s [arquivo_cfg]</term>
<listitem>
<para>
Especifica uma nova localização para o arquivo de configuração do samba.  Por
padrão o <filename>/etc/samba/smb.conf</filename> é usado.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>-d [num]</term>
<listitem>
<para>
Especifica o nível de depuração do nmbd, que podem ir de 0 a 10.  O valor
padrão é 0.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>-l [diretório]</term>
<listitem>
<para>
Especifica a localização do diretório onde o nmbd gravará o arquivo de log
<filename>log.nmbd</filename>.  O valor padrão é
<filename>/var/log/samba</filename>
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>-n [nomeNetBIOS]</term>
<listitem>
<para>
Permite utilizar o nome NetBIOS especificado a invés do especificado no arquivo
<filename>smb.conf</filename> para identificar o computador na rede.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

</section>

<section id="s-samba-s"><title>Conceitos gerais para a configuração do SAMBA</title>
<para>
Este capítulo documenta como configurar o seu servidor <command>SAMBA</command>
permitindo o acesso a compartilhamento de arquivos e impressão no sistema.
</para>
<section id="s-samba-nome"><title>Nome de máquina (nome NetBios)</title>
<para>
Toda a máquina em uma rede NetBEUI é identificada por um nome, este nome deve
ser único na rede e permite que outras máquinas acessem os recursos
disponibilizados ou que sejam enviadas mensagens para a máquina.  Este nome é
composto de 16 caracteres, sendo 15 que identificam a máquina e o último o tipo
de serviço que ela disponibiliza.  O tipo de serviço é associado com o nome da
máquina e registrado em servidores de nomes confirme a configuração da máquina
(você verá isto mais adiante).
</para>
<para>
O nome de máquina é especificado nas diretivas <emphasis>netbios
name</emphasis> e <emphasis>netbios aliases</emphasis> (veja <xref
linkend="s-samba-s-global-nome"/>) para detalhes.
</para>
</section>

<section id="s-samba-workgroup"><title>Grupo de trabalho</title>
<para>
O grupo de trabalho organiza a estrutura de máquinas da rede em forma de
árvore, facilitando sua pesquisa e localização.  Tomemos como exemplo uma
empresa grande com os departamentos <literal>comunicação</literal>,
<literal>redes</literal>, <literal>web</literal>, <literal>rh</literal>, as
máquinas que pertencem ao grupo de <literal>redes</literal> serão agrupadas no
programa de navegação:
</para>
<screen>
redes
  gleydson
  tecnico
  marcelo
  henrique
  michelle

rh
  mrpaoduro
 
web
  web1
  web2
  web3

comunicacao
  comunic1
  comunic2
  comunic3
</screen>
<para>
A segurança no acesso a arquivos e diretórios na configuração de
<emphasis>grupo de trabalho</emphasis> é controlada pela própria máquina,
normalmente usando segurança a nível de compartilhamento.  Esta segurança
funciona definindo um usuário/senha para acessar cada compartilhamento que a
máquina possui.  O <command>Lan Manager</command>, <command>Windows for
Workgroups</command>, <command>Windows 95</command>, <command>Windows
98</command>, <command>XP Home Edition</command> usam este nível de acesso por
padrão.  Se deseja configurar uma rede usando o nível de grupo de trabalho,
veja <xref linkend="s-samba-wrkgrp"/> para detalhes passo a passo e exemplos
práticos.
</para>
<para>
Os programas para navegação na rede NetBIOS são mostrados em <xref
linkend="s-samba-c-workgroup-linux-smbclient"/>, <xref
linkend="s-samba-c-workgroup-linux-nmblookup"/> e <xref
linkend="s-samba-c-graficos"/>.
</para>
</section>

<section id="s-samba-dominio"><title>Domínio</title>
<para>
O funcionamento é semelhante ao grupo de trabalho, com a diferença que a
segurança é controlada pela máquina central (PDC) usando diretivas de acesso e
grupos.  O PDC (Primary Domain Controller) deverá ter todas as contas de acesso
que serão utilizadas pelo usuário para acessar os recursos existentes em outras
máquinas, script de logon que poderá ser executado em cada máquina para fazer
ajustes, sincronismo, manutenção ou qualquer outra tarefa programada pelo
administrador do sistema.
</para>
<para>
Estas características para configuração de máquinas em domínio são documentadas
passo a passo em <xref linkend="s-samba-dom-intro"/>.
</para>
</section>

<section id="s-samba-compart"><title>Compartilhamento</title>
<para>
Um compartilhamento é um recurso da máquina local que é disponibilizado para
acesso via rede, que poderá ser <emphasis>mapeada</emphasis> (veja <xref
linkend="s-samba-mapeamento"/>) por outra máquina.  O compartilhamento pode ser
um diretório, arquivo, impressora.  Além de permitir o acesso do usuário, o
compartilhamento pode ser protegido por senha, e ter controle de acesso de
leitura/gravação, monitoração de acessos, diretórios ocultos, autenticação via
PDC (domínio) e outras formas para restringir e garantir segurança na
disponibilização dos dados (veja <xref linkend="s-samba-a"/> para aprender os
métodos de como fazer isto).
</para>
<para>
Um compartilhamento no SAMBA pode ser acessível publicamente (sem senha) ou
estar rigidamente protegido tendo que passar por diversas barreiras para chegar
ao seu conteúdo, como senhas, endereço de origem, interfaces, usuário
autorizados, permissões de visualização, etc.
</para>
<para>
O guia <emphasis>Foca Linux</emphasis> abordará estes assuntos com detalhes e
explicará didaticamente como tornar seguro seu servidor samba e garantir um
minucioso controle de acesso a seus compartilhamentos.
</para>
</section>

<section id="s-samba-mapeamento"><title>Mapeamento</title>
<para>
Mapear significa pegar um diretório/arquivo/impressora compartilhado por alguma
máquina da rede para ser acessada pela máquina local.  Para mapear algum
recurso de rede, é necessário que ele seja compartilhado na outra máquina (veja
<xref linkend="s-samba-compart"/>).  Por exemplo, o diretório
<filename>/usr</filename> <literal>compartilhado</literal> com o nome
<literal>usr</literal>, pode ser mapeado por uma máquina
<command>Windows</command> como a unidade <emphasis>F:</emphasis>, ou mapeado
por uma máquina <command>Linux</command> no diretório
<filename>/mnt/samba</filename>.
</para>
<para>
O programa responsável por mapear unidades compartilhadas no
<command>Linux</command> é o <command>smbmount</command> e
<command>smbclient</command> (veja <xref
linkend="s-samba-c-workgroup-linux"/>).
</para>
</section>

<section id="s-samba-nmbd"><title>Navegação na Rede e controle de domínio</title>
<para>
Esta função é controlada pelo <command>nmbd</command> que fica ativo o tempo
todo disponibilizando os recursos da máquina na rede, participando de eleições
NetBIOS (<xref linkend="s-samba-s-oslevel"/>), fazer logon de máquinas no
domínio (<xref linkend="s-samba-dom-intro"/>), etc.
</para>
<para>
A função de navegação na rede é feita utilizando o compartilhamento
<filename>IPC$</filename>.  Este compartilhamento possui acesso público somente
leitura e utiliza o usuário "guest" para disponibilização de seus.  Como deve
ter percebido, é necessário especificar esta ID de usuário através do parâmetro
<literal>guest account</literal> (<xref linkend="s-samba-s-a-param"/>), ou a
navegação de recursos no sistema (ou na rede, dependendo da configuração do
SAMBA) não funcionará.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> A função de navegação (browsing) poderá
não funcionar corretamente caso a máquina não consiga resolver nomes NetBIOS
para endereços IP.
</para>
</section>

<section id="s-samba-arquivocfg"><title>Arquivo de configuração do samba</title>
<para>
Toda a configuração relacionada com nomes, grupo de trabalho, tipo de servidor,
log, compartilhamento de arquivos e impressão do <command>samba</command> é
colocada no arquivo de configuração <filename>/etc/samba/smb.conf</filename>.
Este arquivo é dividido em <emphasis>seções</emphasis> e
<emphasis>parâmetros</emphasis>.
</para>
<para>
Uma seção no arquivo de configuração do <command>samba</command>
(<filename>smb.conf</filename>) é definido por um nome entre "[ ]".  As seções
tem o objetivo de organizar os parâmetros pra que tenham efeito somente em
algumas configurações de compartilhamento do servidor (exceto os da seção
<literal>[global]</literal> que não especificam compartilhamentos, mas suas
diretivas podem ser válidas para todas os compartilhamentos do arquivo de
configuração).  Alguns nomes de seções foram reservados para configurações
específicas do <command>samba</command>, eles são os seguintes:
</para>
<variablelist>
<varlistentry>
<term><literal>[global]</literal></term>
<listitem>
<para>
Define configurações que afetam o servidor samba como um todo, fazendo efeito
em todos os compartilhamentos existentes na máquina.  Por exemplo, o grupo de
trabalho, nome do servidor, página de código, restrições de acesso por nome,
etc.  Veja <xref linkend="s-samba-s-global"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>[homes]</literal></term>
<listitem>
<para>
Especifica opções de acesso a diretórios homes de usuários.  O diretório home é
disponibilizado somente para seu dono, após se autenticar no sistema.  Veja
<xref linkend="s-samba-s-homes"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>[printers]</literal></term>
<listitem>
<para>
Define opções gerais para controle das impressoras do sistema.  Este
compartilhamento mapeia os nomes de todas as impressoras encontradas no
<filename>/etc/printcap</filename>.  Configurações especiais podem ser feitas
separadamente.  Veja <xref linkend="s-samba-s-printers"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>[profile]</literal></term>
<listitem>
<para>
Define um perfil quando o servidor <command>samba</command> é usado como PDC de
domínio.  Veja <xref linkend="s-samba-dom-profiles"/>.
</para>
</listitem>
</varlistentry>
</variablelist>
<para>
Qualquer outro nome de [seção] no arquivo <filename>smb.conf</filename> que não
sejam as acima, são tratadas como um compartilhamento ou impressora.
</para>
<para>
Um <emphasis>parâmetro</emphasis> é definido no formato <emphasis>nome =
valor</emphasis>.  Para um exemplo prático, veja um exemplo de arquivo
<filename>smb.conf</filename> em <xref linkend="s-samba-exemplos"/>.  Na
configuração de booleanos, a seguinte sintaxe pode ser usada:
</para>
<itemizedlist>
<listitem>
<para>
<literal>0</literal> ou <literal>1</literal>
</para>
</listitem>
<listitem>
<para>
<literal>yes</literal> ou <literal>no</literal>
</para>
</listitem>
<listitem>
<para>
<literal>true</literal> ou <literal>false</literal>
</para>
</listitem>
</itemizedlist>
<para>
Assim, as seguintes configurações são equivalentes
</para>
<screen>
master browse = 0
master browse = no
master browse = false
</screen>
<para>
Todos significam "NÃO ser o navegador principal de domínio".  A escolha fica a
gosto do administrador.  Durante a configuração, você notará o poder da
flexibilidade oferecida pelo samba na configuração de um servidor SMB :-)
</para>
<para>
Linhas iniciadas por <literal>#</literal> ou <literal>;</literal> são tratadas
como comentário.  Quebras de linha pode ser especificadas com uma
<literal>\</literal> no final da linha.
</para>
</section>

<section id="s-samba-s-global"><title>Seção <literal>[global]</literal></title>
<para>
Os parâmetros especificados nesta seção tem efeito em todo o servidor
<command>samba</command> incluindo os compartilhamentos.  Caso o parâmetro seja
novamente especificado para o compartilhamento, o valor que valerá é o do
compartilhamento.
</para>
<para>
Por exemplo, se <literal>guest user = nobody</literal> for usado na seção
<emphasis>[global]</emphasis> e o <literal>guest user = foca</literal> for
usado no compartilhamento <literal>[focalinux]</literal>, o usuário que fará
acesso público a todos os compartilhamentos do servidor será o
<literal>nobody</literal>, exceto para o compartilhamento
<literal>[focalinux]</literal>, que será feito pelo usuário
<literal>foca</literal>.  Veja <xref linkend="s-samba-s-a"/> para obter uma
lista e descrição dos principais parâmetros de compartilhamentos existentes.
Uma lista completa pode ser obtida na página de manual do
<filename>smb.conf</filename>.
</para>
<para>
Irei descrever alguns parâmetros utilizados nesta seção, organizado de forma
didática e simplificada.
</para>
<section id="s-samba-s-global-nome"><title>Nomes e grupos de trabalho</title>
<variablelist>
<varlistentry>
<term>netbios name = [nome do servidor]</term>
<listitem>
<para>
Especifica o nome NetBIOS primário do servidor samba.  Caso não seja ajustado,
ele usará o hostname de sua máquina como valor padrão.
</para>
<para>
Ex.: <literal>netbios name = focasamba</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>workgroup = [grupo de trabalho/domínio]</term>
<listitem>
<para>
Diz qual o nome do grupo de trabalho/domínio que a máquina samba pertencerá.
</para>
<para>
Ex.: <literal>workgroup = focalinux</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>netbios aliases = [nomes alternativos ao sistema]</term>
<listitem>
<para>
Permite o uso de nomes alternativos ao servidor, separados por espaços.
</para>
<para>
Ex.: <literal>teste1 teste2</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>server string = [identificação]</term>
<listitem>
<para>
Identificação enviada do servidor samba para o ambiente de rede.  A string
padrão é <literal>Samba %v</literal> (%v é substituída pela versão do samba,
para maiores detalhes, veja <xref linkend="s-samba-s-varsubst"/>).
</para>
<para>
Ex: <literal>server string = Servidor Samba versão %v</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>name resolve order = [ordem]</term>
<listitem>
<para>
Define a ordem de pesquisa para a resolução de nomes no samba.  A ordem padrão
é: <literal>lmhosts host wins bcast</literal>, que é a melhor para resolução
rápida e que tente gerar menos tráfego broadcast possível.  Veja <xref
linkend="s-samba-s-nameresolv"/> para uma explicação mais detalhada.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section id="s-samba-s-global-carac"><title>Caracteres e página de código</title>
<para>
Uma das partes essenciais após colocar o <command>SAMBA</command> em
funcionamento, é configurar a página de código para que os caracteres sejam
gravados e exibidos corretamente no cliente.  A primeira coisa que precisa
verificar é se seu kernel possui o suporte a página de código local.  Caso não
tenha, baixe o fonte do kernel e siga os seguintes passos na configuração:
</para>
<itemizedlist>
<listitem>
<para>
Dentro da opção "File Systems", "Network File Systems" defina como "Default
Remote NLS Option" a iso8859-1.  Esta opção permite ao
<command>smbmount</command> montar os volumes locais usando os caracteres
corretos.
</para>
</listitem>
<listitem>
<para>
Entre na opção "File Systems", "Native Language Support".  Na opção "Default
NLS Option" coloque "iso8859-1".  Ative também o suporte as páginas de código
437, 850 e 860 e também ao conjunto de caracteres iso8859-1 e UTF8.
</para>
</listitem>
</itemizedlist>
<para>
Note que esta ordem pode variar dependendo da versão do seu kernel, basta que
as entenda para fazer as modificações apropriadas.  Em caso de dúvidas sobre a
compilação do kernel, veja <xref linkend="kern-recompilando"/>.
</para>
<variablelist>
<varlistentry>
<term>character set = [conjunto_caracteres]</term>
<listitem>
<para>
Seleciona o conjunto de caracteres dos arquivos exibidos pelo servidor samba.
Para os idiomas de língua latina, sempre utilize iso8859-1.
</para>
<para>
Ex.: <literal>character set = iso8859-1</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>client code page = [pagina_de_codigo]</term>
<listitem>
<para>
Seleciona a página de código do servidor samba para tratar os caracteres.  Para
os idiomas de língua latina, sempre utilize 850.
</para>
<para>
Ex.: <literal>client code page = 850</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>preserve case =</term>
<listitem>
<para>
Seleciona se arquivos com nomes extensos criados serão criados com os
caracteres em maiúsculas/minúsculas definidos pelo cliente (no) ou se será
usado o valor de <emphasis>default case</emphasis> (caso seja especificado
<literal>yes</literal>).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>short preserve case =</term>
<listitem>
<para>
Seleciona se os arquivos com nomes curtos (formato 8.3) serão criados com os
caracteres mixtos enviados pelo cliente (no) ou se será usando o valor de
<emphasis>default case</emphasis> (caso seja especificado
<literal>yes</literal>).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>default case = [lower/upper]</term>
<listitem>
<para>
Define se os arquivos criados terão seus nomes todos em minúsculas (lower) ou
maiúsculas (upper).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>valid chars = [caracteres]</term>
<listitem>
<para>
Define caracteres válidos nos nomes de arquivos: <literal>valid chars =á:Á é:É
í:Í ó:Ó ú:Ú â:Â ê:Ê ô:Ô ã:Ã õ:Õ à:À ò:Ò</literal>.  Este parâmetro <emphasis
role="strong">DEVERÁ</emphasis> ser sempre especificado depois do
<literal>client code page</literal>, pois caso contrário, eles serão
substituídos por estes.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section id="s-samba-s-global-restrusu"><title>Restrições de acesso/mapeamento de usuários</title>
<variablelist>
<varlistentry>
<term><literal>guest account = [conta]</literal></term>
<listitem>
<para>
Define a conta local de usuário que será mapeada quando um usuário se conectar
sem senha (usuário guest).  Veja mais detalhes em <xref
linkend="s-samba-s-a-param"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>invalid users</literal></term>
<listitem>
<para>
Define uma lista de usuários que não terão acesso aos recursos do servidor ou
compartilhamento.  É seguro restringir o acesso samba a usuários com grande
poder no sistema (como o <literal>root</literal>).  Veja mais detalhes em <xref
linkend="s-samba-a-restrusu"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>valid users</literal></term>
<listitem>
<para>
Semelhante a opção <literal>invalid users</literal> mas permite que somente os
usuários especificados tenham acesso ao sistema.  Veja mais detalhes em <xref
linkend="s-samba-a-restrusu"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>default service = nome</literal></term>
<listitem>
<para>
Caso o serviço que o usuário deseja se conectar não for encontrado no servidor,
o SAMBA mapeará o serviço especificado nesta diretiva como alternativa.  A
variável "%S" e o caracter "_" podem ser interessantes em algumas alternativas
de configuração.  A opção <literal>default</literal> é um sinônimo para esta
opção.  Caso utilize esta opção, crie o compartilhamento em modo somente
leitura e com acesso público, caso contrário (dependendo do planejamento de
partições e segurança do sistema de arquivos) a máquina poderá ser derrubada
sem dificuldades.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term><literal>username map = [arquivo]</literal></term>
<listitem>
<para>
Especifica um arquivo que faz o mapeamento entre nomes fornecidos por clientes
e nomes de contas Unix locais.  Veja <xref linkend="s-samba-a-usernamemap"/>
para mais detalhes de como configurar este recurso.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>obey pam restrictions = yes</term>
<listitem>
<para>
Indica se as restrições do usuário nos módulos PAM terão efeito também no
SAMBA.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section id="s-samba-s-global-nivelauth"><title>Níveis de autenticação</title>
<para>
(esta seção contém algumas explicações que dependem do resto do conteúdo do
guia, caso não entenda de imediato a fundo as explicações, recomendo que a leia
novamente mais tarde).
</para>
<variablelist>
<varlistentry>
<term></term>
<listitem>
<para>
Define o nível de segurança do servidor.  Os seguintes valores são válidos:
</para>
<itemizedlist>
<listitem>
<para>
<literal>share</literal> - Usada principalmente quando apenas a senha é enviada
por compartilhamento acessado para o servidor, caso muito típico em sistemas
<command>Lan Manager</command> e <command>Windows for Workgroups</command>.
</para>
<para>
Mesmo assim o samba tenta mapear para um UID de usuário local do sistema usando
os seguintes métodos (retirado da página de manual do samba):
</para>
<orderedlist numeration="arabic">
<listitem>
<para>
Se o parâmetro <literal>guest only</literal> é usado no compartilhamento junto
com o <literal>guest ok</literal>, o acesso é imediatamente permitido, sem
verificar inclusive a senha.
</para>
</listitem>
<listitem>
<para>
Caso um nome de usuário seja enviado junto com a senha, ele é utilizado para
mapear o UID e aplicar as permissões deste usuário (como acontece no nível de
segurança <emphasis>user</emphasis>).
</para>
</listitem>
<listitem>
<para>
Se ele usou um nome para fazer o logon no <command>Windows</command> este nome
será usado como usuário local do SAMBA.  Caso ele seja diferente, você deverá
usar o mapeamento de nomes para associar o nome remoto do nome local (veja
<xref linkend="s-samba-a-usernamemap"/>)
</para>
</listitem>
<listitem>
<para>
O nome do serviço é tentado como nome de usuário.
</para>
</listitem>
<listitem>
<para>
O nome da máquina NetBios é tentada como nome de usuário
</para>
</listitem>
<listitem>
<para>
Os usuários especificados na opção <literal>user</literal> do compartilhamentos
são utilizados (veja <xref linkend="s-samba-s-a-param"/>).
</para>
</listitem>
<listitem>
<para>
Caso nenhum destes métodos acima for satisfeito, o acesso é NEGADO.
</para>
</listitem>
</orderedlist>
<para>
Hoje em dia, o uso do nível de acesso <literal>share</literal> é raramente
usado, porque todos os sistemas a partir do <command>Windows 95</command> e
acima enviam o nome de usuário ao acessar um compartilhamento (caindo na
segunda checagem do nível <emphasis>share</emphasis>), sendo equivalente a usar
o nível <emphasis>user</emphasis>.  Entretanto, o nível de segurança
<emphasis>share</emphasis> é recomendado para servidores onde TODO o conteúdo
deve ter acesso público (seja leitura ou gravação) e o parâmetro <literal>guest
shares</literal> também funciona nativamente.
</para>
<para>
As senhas criptografadas (<literal>encrypt passwords = 1</literal>) <emphasis
role="strong">NÃO</emphasis> funcionarão no nível <emphasis>share</emphasis>,
lembre-se deste detalhe.
</para>
</listitem>
<listitem>
<para>
<literal>user</literal> - Este é o padrão.  O usuário precisa ter uma conta de
usuário no <command>Linux</command> para acessar seus compartilhamentos.  A
mesma conta de usuário/senha deverá ser usada no <command>Windows</command>
para acessar seus recursos ou realizado um mapeamento de nomes de usuários
(veja <xref linkend="s-samba-a-usernamemap"/>).  Este é o padrão do SAMBA.  No
nível de acesso <emphasis>user</emphasis> o usuário precisa ser autenticado de
qualquer forma, inclusive se for usado o parâmetro <literal>guest
only</literal> ou <literal>user</literal>.  Os seguintes passos são usados para
autorizar uma conexão usando o nível <emphasis>user</emphasis> (retirado da
documentação do SAMBA):
</para>
<itemizedlist>
<listitem>
<para>
É tentada a validação usando o nome/senha passados pelo cliente.  Se tudo
estiver OK, a conexão é permitida.
</para>
</listitem>
<listitem>
<para>
Caso já tenha se autenticado anteriormente para acessar o recurso e forneceu a
senha correta, o acesso é permitido.
</para>
</listitem>
<listitem>
<para>
O nome NetBIOS da máquina do cliente e qualquer nome de usuário que foi usado é
novamente tentado junto com a senha para tentar permitir o acesso ao recurso
compartilhado.
</para>
</listitem>
<listitem>
<para>
Caso o cliente tenha validado o nome/senha com o servidor e o cliente enviou
novamente o token de validação, este nome de usuário é usado.
</para>
</listitem>
<listitem>
<para>
É tentada a checagem com o parâmetro <emphasis>user</emphasis> no
compartilhamento (veja <xref linkend="s-samba-s-a-param"/>.
</para>
</listitem>
<listitem>
<para>
É verificado se o serviço é público, então a conexão é feita usando o usuário
<literal>guest account</literal> e ignorando a senha (veja <xref
linkend="s-samba-a-publico"/>).
</para>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<para>
<literal>domain</literal> - Neste nível, o acesso só será permitido quando a
máquina for adicionada ao domínio com o <command>smbpasswd</command> (<xref
linkend="s-samba-c-dominio-linux"/>).  Neste nível de acesso, a conta de
usuário será validada em um servidor PDC (controlador de domínio) e o acesso
aos recursos das máquinas que fazem parte do domínio será feito a partir do
PDC.  Veja <xref linkend="s-samba-c-dominio-linux"/> para detalhes.
</para>
</listitem>
<listitem>
<para>
<literal>server</literal> - A máquina samba tentara autenticar o usuário em
outro servidor NT (ou samba).  No caso da autenticação falhar, será usado o
nível de acesso <emphasis>user</emphasis> na base de usuários local (será
necessário o arquivo de senhas criptografado do samba para que a autenticação
local funcione, veja <xref linkend="s-samba-senhas-crypto"/>).  Este nível é
bastante usado quando configuramos um servidor de perfis de usuários ou logon
separado do PDC.
</para>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
</section>

<section id="s-samba-s-global-log"><title>Log de acessos/serviços</title>
<variablelist>
<varlistentry>
<term>log file= [arquivo]</term>
<listitem>
<para>
Define a localização e nome do arquivo de log gerado pelo samba.  As variáveis
de expansão podem ser usadas caso o administrador queira ter um melhor controle
dos logs gerados (veja <xref linkend="s-samba-s-varsubst"/>).
</para>
<para>
Ex.: <literal>/var/log/samba/samba-log-%m</literal>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Se possível coloque uma extensão no
arquivo de log gerado pelo <command>SAMBA</command> (como
<filename>.log</filename>).  O motivo disto é porque se estes logs forem
rotacionados pelo <command>logrotate</command> você terá problemas de
recompactação múltiplas caso utilize um coringa
<filename>samba-log-*</filename>, gerando arquivos como
<filename>.gz.gz.gz..</filename>, lotando a tabela de arquivos do diretório e
deixando sua máquina em um loop de compactação.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>max log size = [tamanho]</term>
<listitem>
<para>
Especifica o tamanho máximo em Kb do arquivo de log gerado pelo samba.  O valor
padrão é 5000Kb (5MB).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>debug pid = [valor]</term>
<listitem>
<para>
Este processo adiciona a pid aos logs gerados pelo processo
<command>smbd</command> Isto é útil para depuração caso existam múltiplos
processos rodando.  O valor padrão é <emphasis>no</emphasis> e a opção
<emphasis>debug timestamp</emphasis> deve ser <literal>yes</literal> para esta
opção ter efeito.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>debug timestamp = [valor]</term>
<listitem>
<para>
Ativa ou desativa a gravação de data/hora nos arquivos de log gerados pelo
samba.  O valor padrão é <literal>yes</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>debug level = [valor]</term>
<listitem>
<para>
Aumenta o nível de depuração dos daemons do SAMBA de <literal>0</literal> a
<literal>9</literal>.  Um nível de depuração interessante e que produz uma
quantidade razoável de dados para configuração de um
<command>logrotate</command> só para o SAMBA é o <literal>2</literal>,
produzindo a lista de todos os compartilhamentos acessados, quem acessou,
data/hora (dependendo das outras opções de depuração).  Isto permite ao
administrador saber exatamente o que está sendo acessado e por quem, quais as
tentativas de acesso.  Assim terá certeza que o conteúdo não está sendo
acessado indevidamente.  O nível de depuração <literal>0</literal> é o padrão.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>debug uid = [valor]</term>
<listitem>
<para>
Este parâmetro inclui o euid, egid, uid, gid nos arquivos de log.  O valor
padrão é <literal>no</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>lock directory = [diretório]</term>
<listitem>
<para>
Define onde serão gravados os arquivos de lock gerados pelo samba.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section id="s-samba-s-global-browsing"><title>Navegação no servidor/tipo de servidor</title>
<variablelist>
<varlistentry>
<term>os level=[num]</term>
<listitem>
<para>
Especifica o nível do sistema operacional.  Este número é usado para as
eleições netbios para definir o navegador de grupo local e controlador de
domínio (veja <xref linkend="s-samba-s-oslevel"/> para detalhes).  O valor pode
ser de 0 a 255, o padrão é 32.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>announce as = [sistema]</term>
<listitem>
<para>
Selecione o nome que o <command>samba</command> (<command>nmbd</command>) se
anunciará na lista de pesquisa de rede.  Os seguintes nomes podem ser usados:
</para>
<itemizedlist>
<listitem>
<para>
<literal>NT Server (ou NT)</literal> - Anuncia como <emphasis>Windows NT
Server</emphasis>.  Este é o padrão.
</para>
</listitem>
<listitem>
<para>
<literal>NT Workstation</literal> - Anuncia-se como um <emphasis>NT
Workstation</emphasis>.
</para>
</listitem>
<listitem>
<para>
<literal>Win95 ou WfW</literal> - Anuncia-se na rede como uma estação
<emphasis>Windows 9x</emphasis>, <emphasis>Windows for Workgroups</emphasis>,
<emphasis>Windows NT Server</emphasis> e <emphasis>Windows NT
Workstation</emphasis> de uma só vez.
</para>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>domain master = [valor]</term>
<listitem>
<para>
Diz se o servidor tentará se tornar o navegador principal de domínio.  Os
valores que podem ser especificados são: <literal>yes, no e auto</literal>.  O
valor padrão é <literal>auto</literal>.  Veja <xref
linkend="s-samba-dom-dmbrowser"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>local master = [valor]</term>
<listitem>
<para>
Diz se o servidor participará ou não das eleições para navegador local do grupo
de trabalho (workgroup).  Os valores que podem ser especificados são:
<literal>yes, no</literal>.  O valor padrão é <literal>yes</literal>.  Para
vencer a eleição, o samba precisa ter o valor de <literal>os level</literal>
maior que os demais.
</para>
<para>
Note também que o Windows NT não aceita perder as eleições e convoca uma nova
eleição caso ele perca.  Como esta eleição é feita via broadcasting, isso gera
um tráfego grande na rede.  Desta forma, se tiver um computador NT na rede
configure este valor para "no".  Veja <xref linkend="s-samba-dom-lmbrowser"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>preferred master = [valor]</term>
<listitem>
<para>
Diz se o servidor samba terá ou não vantagens de ganhar uma eleição local.  Se
estiver configurado para "yes", o servidor samba pedirá uma eleição e terá
vantagens para ganha-la.  O servidor poderá se tornar garantidamente o
<emphasis>navegador principal do domínio</emphasis> se esta opção for usada em
conjunto com <emphasis>domain master = 1</emphasis>.  Os valores especificados
podem ser <literal>yes, no e auto</literal>, o padrão é
<literal>auto</literal>.
</para>
<para>
Antes de ajustar este valor para <literal>yes</literal>, verifique se existem
outros servidores NetBIOS em sua rede que tem preferência para se tornar o
master principal, pois poderá ocorrer um tráfego alto de broadcasting causado
pelas eleições solicitadas pelas outras máquinas.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section id="s-samba-s-global-outras"><title>Outros parâmetros de configuração</title>
<variablelist>
<varlistentry>
<term><literal>include</literal></term>
<listitem>
<para>
Inclui um outro arquivo de configuração na porção atual do arquivo de
configuração.  Você pode utilizar variáveis de substituição, exceto
<literal>%u</literal>, <literal>%P</literal> e <literal>%S</literal> (veja
<xref linkend="s-samba-s-varsubst"/>).
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

</section>

<section id="s-samba-s-homes"><title>Seção <literal>[homes]</literal></title>
<para>
Esta seção tem a função especial de disponibilizar o diretório home do usuário.
Quando o usuário envia seu nome de login como compartilhamento é feita uma
busca no arquivo <filename>smb.conf</filename> procurando por um nome de
compartilhamento que confira.  Caso nenhum seja encontrado, é feita uma busca
por um nome de usuário correspondente no arquivo
<filename>/etc/passwd</filename>, se um nome conferir e a senha enviada também,
o diretório de usuário é disponibilizado como um compartilhamento com o mesmo
nome do usuário local.  O diretório home do usuário poderá ser modificado com o
uso de mapeamento de nomes, veja <xref linkend="s-samba-a-usernamemap"/>.
Quando o caminho do compartilhamento não for especificado, o SAMBA utilizará o
diretório home do usuário (no <filename>/etc/passwd</filename>).
</para>
<para>
Para maior segurança da instalação, principalmente porque o diretório home do
usuário não é um requerimento para a autenticação de usuário, recomendo usar a
variável de substituição <literal>%S</literal> apontando para um diretório com
as permissões apropriadas configuradas em seu sistema, por exemplo:
</para>
<screen>
 [homes]
  comment = Diretórios de Usuários
  path=/pub/usuarios/%S
</screen>
<para>
Você apenas terá o trabalho extra de criar os diretórios de usuários que farão
acesso ao sistema.  Isto não será nenhum problema após você programar um shell
script simples que verifique os nomes de contas em
<filename>/etc/passwd</filename> e crie os diretórios com as permissões/grupos
adequados (isso não será abordado por este capítulo do guia, embora não seja
complicado).  Se deseja, existem exemplos em <xref linkend="s-samba-exemplos"/>
sobre a seção <emphasis>[homes]</emphasis> no arquivo de configuração.
</para>
<para>
Os parâmetros aceitos em <emphasis>[homes]</emphasis> aqui são os mesmos usados
para compartilhamentos normais (veja <xref linkend="s-samba-s-a-param"/>).
Abaixo segue mais um exemplo de seção <emphasis>[homes]</emphasis>:
</para>
<screen>
[homes] 
comment = Diretório home de usuários
writable = yes
public = no
invalid users = root nobody @adm
follow symlinks = no
create mode = 0640
directory mode = 0750
</screen>
<para>
A explicação de cada um dos parâmetros podem ser encontradas em <xref
linkend="s-samba-s-a-param"/>.  O guia está com os parâmetros bem organizados
em seções específicas, apenas de uma olhada para entender com o capítulo do
SAMBA foi organizado e não terá dificuldades de se localizar.
</para>
<para>
<emphasis role="strong">OBS1:</emphasis>Caso nenhum caminho de compartilhamento
seja utilizado, o diretório home do usuário será compartilhado.
</para>
<para>
<emphasis role="strong">OBS2:</emphasis>Não utilize o parâmetro
<emphasis>public yes</emphasis> na seção guest, caso contrário todos os
diretórios de usuários serão lidos por todos.  Veja <xref
linkend="s-samba-a-public-access"/> para maiores detalhes.
</para>
</section>

<section id="s-samba-s-printers"><title>Seção <literal>[printers]</literal></title>
<para>
Esta seção tem a função de disponibilizar as impressoras existentes no sistema
(lp, lp1, lp2, etc) existentes no <filename>/etc/printcap</filename> como
compartilhamento de sistemas Windows.  O método que os nomes de impressoras são
pesquisados é idêntico a forma feita para a seção <emphasis>[homes]</emphasis>:
Primeiro o nome do compartilhamento é pesquisado como um nome de serviço,
depois se ele é um nome de usuário (tentando mapear o serviço disponibilizado
em [homes]), depois será verificado a seção <emphasis>[printers]</emphasis>.
</para>
<para>
Ao invés de usar este recurso, se preferir você poderá compartilhar as
impressoras individualmente.  Para detalhes, veja <xref
linkend="s-samba-i-win-linux"/>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis>É importante lembrar que a seção
<emphasis>[printers]</emphasis> <emphasis role="strong">DEVE</emphasis> ser
definida como <literal>printable</literal> usando o parâmetro
<emphasis>printable = yes</emphasis> para funcionar.  O utilitário
<command>testparm</command> poderá ser usado para verificar problemas no
arquivo cd configuração do SAMBA (veja <xref linkend="s-samba-s-testparm"/>).
</para>
</section>

<section id="s-samba-s-testparm"><title>Buscando problemas na configuração</title>
<para>
Durante o processo de configuração do SAMBA, é comum cometer erros de
digitação, usar parâmetros em lugares indevidos, etc.  É recomendável o uso do
<command>testparm</command> para checar a configuração do SAMBA sempre que
houver modificações para ter certeza nada comprometa o funcionamento que
planejou para sua máquina.
</para>
<para>
Para usar o <command>testparm</command> é só digitar
<literal>testparm</literal>.  Logo após executa-lo, analise se existem erros
nas seções de configuração e te pedirá para pressionar &lt;ENTER&gt; para ver
um dump do arquivo:
</para>
<screen>
Load smb config files from /etc/samba/smb.conf
Processing section "[homes]"
Processing section "[printers]"
Processing section "[tmp]"
Processing section "[cdrom]"
Loaded services file OK.
Press enter to see a dump of your service definitions
</screen>
<para>
A saída acima indica que está tudo OK com todas as configurações que foram
realizadas no servidor.  É possível especificar um outro arquivo de
configuração do SAMBA usando <literal>testparm /etc/samba/smb2.conf</literal>.
</para>
<para>
Também é permitido simular o nome NetBIOS que fará acesso a máquina usando o
parâmetro <literal>-L nome</literal> (que será substituído na variável
<replaceable>%L</replaceable>).
</para>
</section>

<section id="s-samba-s-oslevel"><title>Níveis de sistema para eleição de rede</title>
<para>
Para selecionar qual sistema NetBIOS será o local master browse ou domain
master browse, é usado um método bastante interessante: o de eleições.
</para>
<para>
Quando uma nova máquina entra na rede NetBIOS, ela solicita quem é o Local
Master Browser, caso nenhuma responda, ela força uma eleição na rede através de
uma requisição Broadcasting especial.  Vence a eleição quem tiver o ***maior
número***, chamado de OS Level (nível de sistema operacional).  Caso duas
máquinas empatem, o desempate é feito usando outros critérios.
</para>
<para>
Se você for a única máquina de um workgroup, automaticamente você será o Local
Master Browser.  De meia em meia hora uma nova eleição é feita, forçando mais
tráfego broadcasting na rede.  Durante este novo processo de eleição, a lista
de computadores é atualizada; as novas máquinas são adicionadas e as desligadas
saem da lista após 36 minutos.  Este é o motivo porque as máquinas Windows
continuam aparecendo no ambiente de rede por algum tempo mesmo depois que
desligadas ou porque elas não aparecem de imediato.
</para>
<para>
O OS Level é um número que é característico de cada sistema operacional ficando
entre 0 (mais baixo) e 255.  Os níveis de acessos dos sistemas operacionais são
os seguintes:
</para>
<screen>
Windows for Workgroups                         1
Windows 95                                     1
Windows 98                                     2
Windows 98 Second Edition                      2


Windows 2000 Server (standalone)               16
Windows 2000 Professional                      16
Windows NT 4.0 Wks                             17
Windows NT 3.51 Wks                            16


Windows NT 3.51 Server                         32
Windows NT 4.0 Server                          33
Windows 2000 Server (Domain Controller)        32

SAMBA                                          32
</screen>
<para>
O valor padrão do OS Level do SAMBA é 32, entretanto ele é bastante flexível
para permitir sua mudança através do parâmetro "os level" (veja <xref
linkend="s-samba-s-global-browsing"/>), isto garante que o SAMBA sempre vença
as eleições da rede sobre qualquer outro sistema operacional.
</para>
<para>
No caso de um servidor que estiver configurado para ser o navegador de rede,
assim que for iniciado ele solicitará uma eleição de rede.  As regras são as
mesmas, vence o que tiver o *maior* número.  Este número pode ser configurado
facilmente no SAMBA para que ele sempre vença as eleições de rede, tomando
conta da lista de máquinas.  Isto é especialmente interessante por causa da
estabilidade do servidor <command>Linux</command>, quando migramos de servidor
NT ou para fornecer mais serviços de navegação, como servidor WINS.
</para>
<para>
<emphasis role="strong">OBS</emphasis>: Nunca deixe um servidor NT configurado
para ser o Local Browser ou Domain Master Browser competir com o SAMBA.  Mesmo
que o SAMBA ganhe, o NT é um péssimo perdedor e convoca uma nova eleição para
tentar novamente se eleger, gerando um *extremo* tráfego broadcasting em redes
grandes.
</para>
</section>

<section id="s-samba-s-varsubst"><title>Variáveis de substituição</title>
<para>
Esta seção foi baseada nos dados da página de manual do samba, com adições que
não estavam presentes na versão original e exemplos.  Existem variáveis
especiais que podem ser usadas no arquivo de configuração do samba e são
substituídas por parâmetros especiais no momento da conexão do usuário.  Um
exemplo de utilização de variáveis de substituição seria mudar a localização do
diretório home do usuário:
</para>
<screen>
[homes]
 comment = Diretório home do usuário
 path = /home/usuarios/%u
</screen>
<para>
Cada uma das variáveis são descritas em detalhes abaixo:
</para>
<variablelist>
<varlistentry>
<term>%S</term>
<listitem>
<para>
O nome do serviço atual, se existir.  Seu uso é interessante, principalmente no
uso de diretórios homes.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%P</term>
<listitem>
<para>
O diretório raíz do serviço atual, se existir.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%u</term>
<listitem>
<para>
O nome de usuário do serviço atual, se aplicável.  Esta variável é bastante
útil para programação de scripts e também para criar arquivos de log
personalizados, etc.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%g</term>
<listitem>
<para>
O grupo primário do usuário %u.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%U</term>
<listitem>
<para>
O nome de usuário da seção (o nome de usuário solicitado pelo cliente, não é
uma regra que ele será sempre o mesmo que ele recebeu).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%G</term>
<listitem>
<para>
O nome do grupo primário de %U.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%H</term>
<listitem>
<para>
O diretório home do usuário, de acordo com %u.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%v</term>
<listitem>
<para>
A versão do Samba.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%h</term>
<listitem>
<para>
O nome DNS da máquina que está executando o Samba.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%m</term>
<listitem>
<para>
O nome NetBIOS da máquina do cliente.  Isto é muito útil para log de conexões
personalizados e outras coisas úteis.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%L</term>
<listitem>
<para>
O nome NetBIOS do servidor.  Como o servidor pode usar mais de um nome no samba
(aliases), você poderá saber com qual nome o seu servidor está sendo acessado e
possivelmente torna-lo o nome primário de sua máquina.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%M</term>
<listitem>
<para>
O nome DNS da máquina cliente.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%N</term>
<listitem>
<para>
O nome do seu servidor de diretórios home NIS.  Este parâmetro é obtido de uma
entrada no seu arquivo auto.map.  Se não tiver compilado o SAMBA com a opção
<literal>--with-automount</literal> então este valor será o mesmo de %L.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%p</term>
<listitem>
<para>
O caminho do diretório home do serviço, obtido de uma entrada mapeada no
arquivo <filename>auto.map</filename> do NIS.  A entrada NIS do arquivo
<filename>auto.map</filename> é dividida na forma "%N:%p".
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%R</term>
<listitem>
<para>
O nível de protocolo selecionado após a negociação.  O valor retornado pode ser
CORE, COREPLUS, LANMAN1, LANMAN2 ou NT1.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%d</term>
<listitem>
<para>
A identificação de processo do processo atual do servidor.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%a</term>
<listitem>
<para>
A arquitetura da máquina remota.  Somente algumas são reconhecidas e a resposta
pode não ser totalmente confiável.  O <command>samba</command> atualmente
reconhece <emphasis>Samba</emphasis>, <emphasis>Windows for
Workgroups</emphasis>, <emphasis>Windows 95</emphasis>, <emphasis>Windows
NT</emphasis> e <emphasis>Windows 2000</emphasis>.  Qualquer outra coisa será
mostrado como "UNKNOWN" (<emphasis>desconhecido</emphasis>).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%I</term>
<listitem>
<para>
O endereço IP da máquina do cliente.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%T</term>
<listitem>
<para>
A data e hora atual.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>%$(var_ambiente)</term>
<listitem>
<para>
Retorna o valor da <emphasis>variável de ambiente</emphasis> especificada.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

</section>

<section id="s-samba-s-a"><title>Compartilhamento de arquivos e diretórios</title>
<para>
Esta seção documenta como disponibilizar arquivos e impressoras com o SAMBA e
os parâmetros usados para realizar restrições de compartilhamento, modo que os
dados serão disponibilizados e ítens de performance.  A maior parte destes
parâmetros são empregados em serviços do SAMBA, mas nada impede que também
sejam colocado na seção <emphasis>[global]</emphasis> do arquivo de
configuração, principalmente quando isto é válido para diversos serviços
compartilhados (veja <xref linkend="s-samba-s-global"/>).
</para>
<section id="s-samba-s-a-param"><title>Descrição de parâmetros usados em compartilhamento</title>
<para>
Abaixo o guia traz algumas das opções que podem ser usadas para controlar o
comportamento do compartilhamento de arquivos por <emphasis>serviços</emphasis>
no servidor SAMBA:
</para>
<variablelist>
<varlistentry>
<term>path</term>
<listitem>
<para>
Indica o diretório que será compartilhado.  Lembre-se que o usuário terá as
permissões de acesso que ele teria caso estivesse logado no sistema como um
usuário UNIX normal, exceto se estiver fazendo mapeamento para outros nomes de
usuários (veja <xref linkend="s-samba-a-usernamemap"/>).
</para>
<para>
Ex: <literal>path=/pub</literal> - Compartilha o diretório local
<filename>/pub</filename>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Quando não é definido um
<literal>path</literal>, o diretório <filename>/tmp</filename> é usado como
padrão.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>comment</term>
<listitem>
<para>
Descrição do compartilhamento que será mostrada na janela de procura de rede ou
no <literal>smbclient -L maquina</literal>.
</para>
<para>
Ex: <literal>comment=Pasta de conteúdo público do sistema</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>browseable</term>
<listitem>
<para>
Define se o compartilhamento será ou não exibido na janela de procura de rede.
Mesmo não sendo exibido, o compartilhamento poderá ser acessado.  Veja <xref
linkend="s-samba-a-invisivel"/> para uma explicação mais detalhada.
</para>
<para>
Ex: <literal>browseable=yes</literal> - Lista o compartilhamento na janela de
pesquisa de servidores.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>guest account</term>
<listitem>
<para>
Conta que será usada para fazer acesso sem senha (convidado) quando o parâmetro
<literal>guest ok</literal> ou <literal>public</literal> forem usados em um
compartilhamento.  Por padrão ela é mapeada para o usuário
<literal>nobody</literal>.  É importante especificar uma nome de usuário
<emphasis>guest</emphasis> (convidado), principalmente porque seu UID será
usado para fazer várias operações no SAMBA, como exibir os recursos disponíveis
na máquina para a rede.  Por motivos claros, é recomendável que este usuário
<emphasis role="strong">não</emphasis> tenha acesso login ao sistema.
</para>
<para>
Caso não tenha a intenção de ocultar o SAMBA na lista de máquinas da rede
(fazendo apenas acesso direto aos recursos), especifique um valor para esta
opção.
</para>
<para>
Ex: <literal>guest account = sambausr</literal> - Mapeia os usuário se
conectando sem senha para o usuário <literal>sambausr</literal>, desde que o
acesso guest seja permitido pela opção <literal>public</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>public</term>
<listitem>
<para>
Permitem aos usuários usuários se conectarem ao compartilhamento sem fornecer
uma senha usando o usuário guest.  O UID que o usuário guest será mapeado é
especificado pelo parâmetro <literal>guest account</literal>).  Veja <xref
linkend="s-samba-a-publico"/>.  O parâmetro <literal>guest ok</literal> é
equivalente a <literal>public</literal>.
</para>
<para>
Ex: <literal>public = no</literal> - Não permite
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>guest only</term>
<listitem>
<para>
Permite somente conexões guest ao recurso.  O UID do usuário é mapeado para
guest, mesmo que forneça uma senha correta.  O valor padrão é
<literal>no</literal>.
</para>
<para>
Ex: <literal>guest only = no</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>write list</term>
<listitem>
<para>
Lista de usuários separados por espaço ou vírgula que poderão ler e gravar no
compartilhamento.  Caso o nome for iniciado por "@", o nome especificado será
tratado como um grupo UNIX (<filename>/etc/group</filename>) e todos os
usuários daquele grupo terão acesso de gravação.  O uso deste parâmetro ignora
o <literal>read only = yes</literal>.  Veja <xref linkend="s-samba-a-restr"/>
para mais detalhes.
</para>
<para>
Ex: <literal>write list = gleydson, @usuarios</literal> - Permite acesso
gravação somente do usuário <literal>gleydson</literal> e todos os usuários
pertencentes ao grupo <literal>@usuarios</literal>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> - O significado de "@" nos parâmetros
"invalid users"/"valid users" é diferente das opções <literal>write
list</literal> e <literal>read list</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>read list</term>
<listitem>
<para>
Lista de usuários separados por espaço ou vírgula que poderão apenas ler o
compartilhamento.  O caracter "@" pode ser especificado para fazer referência a
grupos, como no <literal>write list</literal>.  O uso deste parâmetro ignora o
<literal>read only = no</literal>.  Veja <xref linkend="s-samba-a-restr"/> para
mais detalhes.
</para>
<para>
Ex: <literal>read list = nobody, system, operador, @usuarios</literal> -
Permite acesso de leitura somente do usuário <literal>nobody, system,
operador</literal> e todos os usuários pertencentes ao grupo
<literal>@usuarios</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>user</term>
<listitem>
<para>
Especifica um ou mais nomes de usuários ou grupos (caso o nome seja seguido de
"@") para checagem de senha.  Quando o cliente somente fornece uma senha
(especialmente na rede <command>Lan Manager</command>, <command>Windows for
Workgroups</command> e primeira versão do <command>Windows 95</command>) ela
será validada no banco de dados de senhas usando o usuário especificado nesta
opção.
</para>
<para>
Ex: <literal>user = john @usuariosrede</literal>
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>only user</term>
<listitem>
<para>
Especifica se somente serão permitidas conexões vindas de usuários da diretiva
<literal>user</literal>.  O padrão é <literal>no</literal>.  Caso deseje
restringir o acesso a determinados usuários, o certo é faze-lo usando
<literal>valid users</literal> e <literal>invalid users</literal> (veja <xref
linkend="s-samba-a-restrusu"/>).  O uso de <literal>only user</literal> é
apropriado quando é necessário um controle específico de acesso sobre a
diretiva <literal>user</literal>.
</para>
<para>
Ex: <literal>only user = no</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>locking</term>
<listitem>
<para>
Permite ao SAMBA fazer um lock real de arquivo ou apenas simular.  Caso seja
especificado como "0", o arquivo não é bloqueado para acesso exclusivo no
servidor mas uma resposta positiva de lock é retornada ao cliente.  Se definido
como "1", um lock real é feito.  O padrão é <literal>yes</literal>.
</para>
<para>
Ex: <literal>locking = yes</literal>
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>available</term>
<listitem>
<para>
Faz o SAMBA ignorar o compartilhamento (como se tivesse retirado do servidor).
O valor padrão é "no".
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>follow symlinks</term>
<listitem>
<para>
Permite o uso de links simbólicos no compartilhamento (veja também a opção
<literal>wide links</literal>).  A desativação desta opção diminui um pouco a
performance de acesso aos arquivos.  Como é restrita a compartilhamento, o
impacto de segurança depende dos dados sendo compartilhados.  O valor padrão
desta opção é "YES".
</para>
<para>
Ex: <literal>follow symlinks = yes</literal>
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>wide links</term>
<listitem>
<para>
Permite apontar para links simbólicos para fora do compartilhamento exportada
pelo SAMBA.  O valor padrão esta opção é "YES".
</para>
<para>
Ex: <literal>wide links = yes</literal>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> - A desativação desta opção causa um
aumento na performance do servidor SAMBA, evitando a chamada de funções do
sistema para resolver os links.  Entretanto, diminui a segurança do seu
servidor, pois facilita a ocorrência de ataques usando links simbólicos.
</para>
<para>
Lembre-se mais uma vez que a segurança do seu sistema começa pela política e
uma instalação bem configurada, isso já implica desde a escolha de sua
distribuição até o conhecimento de permissões e planejamento na implantação do
servidor de arquivos.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>dont descend</term>
<listitem>
<para>
Não mostra o conteúdo de diretórios especificados.
</para>
<para>
Ex: <literal>dont descend = /root, /proc, /win/windows, "/win/Arquivos de
Programas", "/win/program files"</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>printable</term>
<listitem>
<para>
Especifica se o compartilhamento é uma impressora (yes) ou um compartilhamento
de arquivo/diretório (no).  O padrão é "no".
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>read only</term>
<listitem>
<para>
Especifica se o compartilhamento é somente para leitura (yes) ou não (no) para
todos os usuários.  O parâmetro <literal>writable</literal> é um antônimo
equivalente a este parâmetro, só que utiliza as opções invertidas.  Por
segurança, o valor padrão é somente leitura.  Veja uma explicação mais
detalhada em <xref linkend="s-samba-a-ro"/>.
</para>
<para>
Ex: <literal>read only = yes</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>create mask</term>
<listitem>
<para>
Modo padrão para criação de arquivos no compartilhamento.  O parâmetro "create
mode" é um sinônimo para este.  O modo de arquivos deve ser especificado em
formato octal.  Veja <xref linkend="perm-octal"/>).
</para>
<para>
Ex: <literal>create mask = 0600</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>directory mask</term>
<listitem>
<para>
Modo padrão para a criação de diretórios no compartilhamento.  O parâmetro
"directory mode" é um sinônimo para este.  O modo de diretório deve ser
especificado em formato octal.
</para>
<para>
Ex: <literal>directory mask = 0700</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>getwd cache</term>
<listitem>
<para>
Permite utilizar um cache para acesso as requisições getwd, diminuindo o número
de ciclos de processamento para acesso a arquivos/diretórios.  O valor padrão é
"Yes".
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>write cache size</term>
<listitem>
<para>
Tamanho do cache de leitura/gravação do compartilhamento.  Este valor é
especificado em bytes e o padrão é "0".  Veja <xref linkend="s-samba-perf"/>
para detalhes sobre seu uso.
</para>
<para>
Ex: <literal>write cache size = 384000</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>inherit permissions</term>
<listitem>
<para>
Permite herdar permissões de arquivos/diretórios do diretório pai quando novos
arquivos/diretórios são criados, isto inclui bits SGID (set group ID).  O
padrão é <literal>NÃO</literal> herdar permissões.  O uso desta opção substitui
as opções fornecidas por <literal>create mask</literal>, <literal>directory
mask</literal>, <literal>force create mask</literal> e <literal>force directory
mask</literal>.
</para>
<para>
Ex: <literal>inherit permissions</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>preexec</term>
<listitem>
<para>
Executa um comando antes a abertura de um compartilhamento.  O parâmetro
<literal>exec</literal> é um sinônimo para este.  Veja <xref
linkend="s-samba-a-comandos"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>postexec</term>
<listitem>
<para>
Executa um comando depois da utilização do compartilhamento.  Veja <xref
linkend="s-samba-a-comandos"/>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>preexec close</term>
<listitem>
<para>
Fecha imediatamente o compartilhamento caso o valor do comando executado pela
opção <literal>preexec</literal> seja diferente de 0.  O uso desta opção só faz
sentido em conjunto com <literal>preexec</literal>.  O valor padrão é "no".
Veja <xref linkend="s-samba-a-comandos"/>.
</para>
<para>
Exemplo: <literal>preexec close = yes</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>volume = nome</term>
<listitem>
<para>
Retorna o nome de volume especificado quando é feito o acesso ao
compartilhamento.  Isto é muito útil para instalações onde o serial do CD,
disquete ou HD é verificado durante o acesso.  Isto acontece com freqüência em
produtos de fabricantes proprietários como forma de evitar a execução ilegal do
programa.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

</section>

<section id="s-samba-wrkgrp"><title>Configuração em <literal>Grupo de Trabalho</literal></title>
<para>
A configuração <emphasis>grupo de trabalho</emphasis> é o método mais simples
para compartilhar recursos em uma rede e também é indicado quando se possui uma
rede pequena (até 30 máquinas) pois o gerenciamento não é tão complicado.
Acima deste número, é recomendada a utilização da configuração de domínio para
definição de políticas de acesso mais precisas pelo administrador e para manter
o controle sobre os recursos da rede (veja <xref
linkend="s-samba-dom-config"/>).
</para>
<para>
A configuração do nível de acesso por grupo de trabalho tem como
características principais essa simplicidade na configuração e o controle de
acesso aos recursos sendo feito pela máquina local através de senhas e controle
de IP.
</para>
<para>
Quanto ao método de senhas, você pode optar tanto por usar senhas
criptografadas (<xref linkend="s-samba-senhas-crypto"/>) ou senhas em texto
limpo (<xref linkend="s-samba-senhas-plano"/>).
</para>
<para>
Veja abaixo um exemplo explicado de configuração do <command>SAMBA</command>
para grupo de trabalho:
</para>
<screen>
 [global]
  netbios name = servidor
  workgroup = focalinux
  security = user
  obey pam restrictions = yes
  encrypt passwords = no
  os level = 30
  guest account = nobody
  server string = servidor da rede
  local master = true
  domain master = false

 [homes]
  comment = Diretórios de usuários
  create mask= 0700
  directory mask = 0700
  browseable = no
  
 [tmp]
  path = /tmp
  comment = Diretório temporário do sistema
  read only = yes
  valid users = gleydson
  public = no
</screen>
<para>
Agora, verifique se existem erros na configuração com o comando
<command>testparm</command> (<xref linkend="s-samba-s-testparm"/>) e reinicie o
<command>SAMBA</command> (<xref linkend="s-samba-rodando"/>).  O nome do grupo
de trabalho que a máquina pertencerá é <literal>focalinux</literal>
(<literal>workgroup = focalinux</literal>).  O nível de acesso usado neste
exemplo é de usuário (<literal>security = user</literal>), para mais detalhes
sobre este método, veja <xref linkend="s-samba-s-global-nivelauth"/>.  O
parâmetro <literal>local master</literal> foi definido para
<literal>yes</literal> para o <command>SAMBA</command> tentar ser o navegador
local do grupo de trabalho (veja <xref linkend="s-samba-dom-lmbrowser"/>).
</para>
<para>
Para testar se o servidor está funcionando, digite o seguinte comando:
</para>
<screen>
smbclient -L servidor -U usuario
</screen>
<para>
Digite a senha de usuário quando solicitado.  O comando deverá listar os
recuros da máquina, indicando que a configuração está funcionando corretamente.
Se você é paranóico e está preocupado com a segurança da máquina, recomendo ler
a <xref linkend="s-samba-a"/>.
</para>
</section>

<section id="s-samba-s-nameresolv"><title>Resolução de nomes de máquinas no samba</title>
<para>
O Samba pode utiliza os seguintes métodos para resolução de nomes de máquinas
na rede (<xref linkend="s-samba-nome"/>).  Eles estão listados em ordem de
prioridade do mais para o menos recomendável:
</para>
<itemizedlist>
<listitem>
<para>
<literal>lmhosts</literal> - Pesquisa primeiro o arquivo
<filename>/etc/samba/lmhosts</filename> (veja <xref
linkend="s-samba-s-nameresolv-lmhosts"/> para detalhes sobre este arquivo).
</para>
</listitem>
<listitem>
<para>
<literal>host</literal> - Faz a pesquisa no arquivo
<filename>/etc/hosts</filename> e no DNS em busca do nome da máquina.
</para>
</listitem>
<listitem>
<para>
<literal>wins</literal> - Pesquisa no servidor WINS especificado pelo parâmetro
<emphasis>wins server</emphasis> do <filename>smb.conf</filename> (veja <xref
linkend="s-samba-s-nameresolv-wins"/>).
</para>
</listitem>
<listitem>
<para>
<literal>bcast</literal> - Envia um pacote para o endereço de broadcast de sua
configuração de rede.  Este geralmente deve ser o último método por gerar
tráfego excessivo em uma rede com um considerável número de computadores.
</para>
</listitem>
</itemizedlist>
<para>
A ordem que a resolução de nomes é feita pelo samba, pode ser modificada usando
o parâmetro "name resolve order = [ordem]" no arquivo de configuração do samba
(ex.  <literal>name resolve order = lmhosts host wins bcast</literal>).
</para>
<section id="s-samba-s-nameresolv-lmhosts"><title>Arquivo <filename>/etc/samba/lmhosts</filename></title>
<para>
Este arquivo é um banco de dados que mapeia o endereço IP com o nome NetBIOS de
uma máquina, semelhante ao formato do <filename>/etc/hosts</filename>.  Este
arquivo é útil quando temos servidores que são acessados com freqüência, quando
servidores de rede estão em segmentos separados e não temos um servidor WINS
entre os dois pontos para resolução de nomes, para definir máquinas WINS que
serão acessados pela internet, etc.  Para ter certeza da localização do arquivo
<filename>lmhosts</filename> em sua máquina, digite <literal>smbclient -d 3 -L
localhost</literal> e veja o diretório de pesquisa deste arquivo.  Veja um
exemplo de arquivo <filename>lmhosts</filename> em <xref
linkend="s-samba-s-nameresolv-lmhosts-unix-ex"/>.
</para>
<para>
O uso do arquivo <filename>lmhosts</filename> evita o excesso de broadcasting
na rede, pois a ordem padrão usada para a resolução de nomes do
<command>samba</command>, procura primeiro resolver o nome procurando em
arquivos lmhosts, depois usando <emphasis>dns</emphasis>,
<emphasis>wins</emphasis> e <emphasis>broadcast</emphasis>.  Dependendo do
projeto de sua rede e como as máquinas resolvem os nomes, ele pode ser uma
camada a mais de segurança contra um simples hijacking de servidor através de
NetBEUI ou WINS (isso é evitado com o uso de domínios, veja <xref
linkend="s-samba-dom-config"/>).
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Note que em clientes
<command>Windows</command> que estejam em outra subrede, é necessário o arquivo
<filename>\windows\lmhosts</filename> apontando para um servidor PDC mesmo que
ele esteja apontando para o servidor WINS, caso contrário, a máquina não
efetuará o logon.
</para>
<para>
O formato do arquivo <filename>lmhosts</filename> do <command>Windows</command>
é mais complexo do que o do <command>Linux</command> pois o sistema precisa de
mais detalhes para resolver os nomes e tipos de máquinas no domínio.  Veja o
modelo <filename>lmhosts.sam</filename> em seu sistema
<command>Windows</command> para compreender seu funcionamento.
</para>
<section id="s-samba-s-nameresolv-lmhosts-unix-ex"><title>Exemplo de <filename>lmhosts</filename> do UNIX</title>
<para>
O exemplo abaixo mapeia o endereço IP das máquinas (primeira coluna) com o
respectivo nome de máquina (segunda coluna):
</para>
<screen>
172.16.0.34 servarq
172.16.0.30 serverdom
192.168.5.2 servwins
172.16.0.3 servpdc
172.16.0.1 gateway
</screen>
</section>

<section id="s-samba-s-nameresolve-lmhosts-windows-ex"><title>Exemplo de <filename>lmhosts</filename> do Windows</title>
<para>
O arquivo possui uma sintaxe idêntica a do <filename>lmhosts</filename> do
UNIX, mas alguns parâmetros especiais são especificados para ajudar o
<command>Windows</command> resolver algumas coisas que não consegue fazer
sozinho (principalmente com relação a identificação de função de máquinas em
redes segmentadas):
</para>
<screen>
192.168.0.5 servarq
192.168.0.1 serverpdc #PRE #DOM:dominio
192.168.0.2 "serverwins    \0x1e" #PRE
#INCLUDE \\serverpdc\lmhosts
</screen>
<para>
A primeira entrada do arquivo é a tradicional, onde o nome da máquina NetBIOS é
associada ao IP.  A segunda utiliza dois parâmetros adicionais:
</para>
<itemizedlist>
<listitem>
<para>
<literal>#PRE</literal> - Faz a entrada ser carregada logo na inicialização e
se tornando uma entrada permanente no cache NetBIOS.
</para>
</listitem>
<listitem>
<para>
<literal>#DOM</literal> - Especifica que a máquina é um controlador de domínio.
A máquina deverá ter sido configurada para a função de domínio, pois caso
contrário isso simplesmente não funcionará.
</para>
</listitem>
</itemizedlist>
<para>
Note que ambos <literal>#PRE</literal> e <literal>#DOM</literal> devem ser
especificados em maiúsculas.  O terceiro exemplo faz uma referência permanente
(#PRE) a máquina servidora WINS <emphasis>serverwins</emphasis>.  Neste exemplo
é usada uma característica especial para especificar a ID hexadecimal da
máquina na rede <emphasis>1e</emphasis>.  O quarto utiliza um include para
associar outro arquivo ao atual, útil quando temos um compartilhamento que
distribui um arquivo <filename>lmhosts</filename> para diversas máquinas na
rede.  De preferência, utilize sempre uma diretiva <emphasis>#PRE</emphasis>
para todas as máquinas especificadas na diretiva <emphasis>#INCLUDE</emphasis>
em seu arquivo de configuração.
</para>
<para>
Para a especificação de ID de serviço manual, é necessário manter os 15
caracteres no nome da máquina (preenchendo os restantes com espaços, caso seja
preciso).  O último caracter é o código hexadecimal que identifica o serviço de
rede (veja <xref linkend="s-samba-c-workgroup-linux-nmblookup"/> para ver a
lista de serviços e sua respectiva função).
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Caso crie este arquivo em um editor de
textos do <command>Linux</command>, não se esqueça de converter o arquivo para
que contenha o CR+LF no final das linhas.
</para>
</section>

</section>

<section id="s-samba-s-nameresolv-wins"><title>WINS</title>
<para>
Este é um serviço de resolução de nomes que funciona de forma semelhante ao
DNS, só que voltado para o NetBIOS.  Quando uma máquina cliente NetBIOS entra
na rede, o servidor WINS pega seu nome e IP e inclui em uma tabela para futura
consulta pelos clientes da rede.
</para>
<para>
Esta tabela consultada toda vez que um cliente NetBIOS solicita um nome de
máquina, componentes do grupo de trabalho ou domínio na rede.  Uma outra
aplicação importante de um servidor WINS é permitir a resolução de nomes em
pontos de redes que requerem roteamento, a simplicidade de um protocolo não
roteável como o NetBIOS fica limitada a simplicidade das instalações de rede.
Um servidor WINS pode ser instalado em cada ponta da rede e eles trocarem dados
entre si e atualizar suas tabelas de nomes/grupos de trabalhos/IPs.
</para>
<para>
A resolução de nomes de máquinas será feita consultando diretamente a máquina
WINS ao invés de broadcasting (que geram um tráfego alto na rede).
</para>
<section id="s-samba-s-nameresolv-wins-s"><title>Configurando o servidor WINS</title>
<para>
Para ativar o servidor WINS no <command>samba</command>, inclua as seguinte
linha na seção <literal>[global]</literal> do seu arquivo
<filename>/etc/samba/smb.conf</filename>:
</para>
<screen>
[global]
wins support = yes
wins proxy = no
dns proxy = no
max wins ttl = 518400
</screen>
<para>
O parâmetro <literal>wins proxy</literal> pode ser necessário para alguns
clientes antigos que tenham problemas no envio de suas requisições WINS.  O
<literal>dns proxy</literal> permite que o servidor WINS faça a pesquisa no DNS
para localização de nomes de máquinas caso não exista no cache.  Ambas as
opções <literal>wins support</literal>, <literal>wins proxy</literal> e
<literal>dns proxy</literal> tem como valor padrão <literal>não</literal>.
Pronto, seu servidor samba agora suporta WINS.  Fácil, prático e rápido :-)
</para>
<para>
Se estiver configurando uma subrede com masquerade para acesso a um PDC ou um
servidor WINS, você terá que mexer no gateway central para apontar uma rota
para o gateway masquerade.  O motivo disto é porque o masquerade do
<command>Linux</command> atua somente nos cabeçalhos, mas o IP da estação é
enviada e processada pelo PDC para retornar uma resposta.  Da mesma forma, este
IP é registrado no servidor WINS para uso das estações de trabalho.  Isto só
vai ser resolvido quando for escrito um módulo de conntrack para conexões SAMBA
(até o lançamento do kernel <literal>2.4.22</literal>, isso ainda não ocorreu).
</para>
<para>
<emphasis role="strong">OBS1:</emphasis> NUNCA configure mais de um servidor
WINS em uma mesma rede.
</para>
<para>
<emphasis role="strong">OBS2:</emphasis> NÃO especifique o parâmetro
<literal>wins server</literal> caso esteja usando o suporte a WINS.
</para>
</section>

<section id="s-samba-s-nameresolv-wins-c"><title>Configurando o Cliente WINS</title>
<para>
Para os clientes da rede (<command>Linux, Windows, OS/2, etc.</command>) fazer
uso das vantagens da resolução de nomes usando o WINS, é necessário configurar
para que eles o utilizem para resolver os nomes de máquinas.  Isto é feito da
seguinte forma em cada um dos sistemas operacionais:
</para>
<variablelist>
<varlistentry>
<term>Linux</term>
<listitem>
<para>
Adicione a linha <literal>wins server = ip_do_servidor_WINS</literal> na seção
global do arquivo <filename>/etc/samba/smb.conf</filename>:
</para>
<screen>
[global]
wins server = 192.168.1.1
</screen>
<para>
Após isto, reinicie o servidor <command>samba</command>.  Caso esteja
executando o servidor via <literal>inetd</literal>, digite: <literal>killall
-HUP nmbd</literal>.  Se estiver rodando através de daemons:
<literal>/etc/init.d/samba restart</literal>.  Não é necessário reiniciar o
computador!
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>Windows 9x</term>
<listitem>
<para>
Clique com o botão direito sobre o ícone <emphasis>Ambiente de Rede</emphasis>
e selecione propriedades.  Na janela de configuração de rede clique na aba
<emphasis>Configuração</emphasis>.  Na lista que aparece selecione o protocolo
TCP/IP equivalente a sua placa de rede local e clique em
<emphasis>Propriedades</emphasis>.
</para>
<para>
Na tela de <emphasis>Propriedades TCP/IP</emphasis> clique em
<emphasis>Configurações WINS</emphasis> e marque a opção <emphasis>Ativar
resolução WINS</emphasis>.  Digite o endereço do servidor WINS e clique em
<emphasis>Adicionar</emphasis>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Se utilizar um servidor DHCP em sua
rede local e o endereço do servidor WINS também é oferecido através dele, você
poderá marcar a opção <emphasis>Usar DHCP para resolução WINS</emphasis>.  Note
que esta opção somente estará disponível se escolher a opção <emphasis>Obter um
endereço IP automaticamente</emphasis> na tab <emphasis>Endereços
IP</emphasis>.  Clique em OK até fechar todas as telas e reinicie quando o
computador perguntar :-)
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

</section>

</section>

<section id="s-samba-s-timeserver"><title>Servidor de data/hora</title>
<para>
O samba pode atuar como um servidor de data/hora ajustando o horário de suas
estações de trabalho com o servidor da rede.
</para>
<para>
As estações clientes poderão executar o comando <command>net</command> para
sincronizar seu relógio durante a inicialização do Windows, ou durante o logon
da rede através do script de logon, caso tenha configurado o servidor
<command>samba</command> para logon em domínios NT.
</para>
<section id="s-samba-s-timeserver-s"><title>Configuração do serviço de data/hora no SAMBA</title>
<para>
Para configurar o samba para atuar como servidor de data/hora de sua rede,
adicione o seguinte parâmetro na seção global do arquivo de configuração
<filename>/etc/samba/smb.conf</filename>:
</para>
<screen>
[global]
time server = yes
</screen>
<para>
Para sincronizar a data/hora das estações de trabalho usando o servidor samba,
veja <xref linkend="s-samba-s-timeserver-c"/>.  Caso o seu servidor SAMBA
também seja o servidor de autenticação PDC da rede, a melhor forma de se fazer
isto é colocar o comando <literal>net time \\servidor_SAMBA /set /yes</literal>
em um script que será executado pela estação.
</para>
<para>
<emphasis role="strong">OBS</emphasis> É recomendável instalar um cliente ntp
para manter o relógio do servidor sempre atualizado, conseqüentemente mantendo
a data/hora das estações também em sincronismo .  .
</para>
</section>

<section id="s-samba-s-timeserver-c"><title>Sincronizando a data/hora no Cliente</title>
<para>
Na estação cliente Windows, use o seguinte comando:
</para>
<screen>
NET TIME \\SERVIDOR /WORKGROUP:GRUPO /SET /YES
</screen>
<para>
Um local interessante para colocação deste comando é na pasta Iniciar da
estação Windows, pois todos os comandos que estejam nesta pasta são executados
quando o sistema é iniciado.
</para>
<para>
Exemplos:
</para>
<itemizedlist>
<listitem>
<para>
<literal>net time \\linux /set /yes</literal> - Sincroniza a hora com o
servidor "\\linux" e não pede confirmação (/yes).
</para>
</listitem>
<listitem>
<para>
<literal>net time \\linux /WORKGROUP:pinguim /set /yes</literal> - Sincroniza a
hora com o servidor "\\linux" do grupo de trabalho pinguim (/WORKGROUP:pinguim)
e não pede confirmação (/yes).
</para>
</listitem>
</itemizedlist>
</section>

</section>

<section id="s-samba-dom"><title>Configuração em <literal>Domínio</literal></title>
<para>
Esta seção descreve todos os passos necessários para configurar um servidor de
domínio PDC (<emphasis>Primary Domain Control</emphasis>) com perfis móveis e
outros recursos que tornam úteis e seguras a administração de uma rede NetBEUI.
</para>
<section id="s-samba-dom-intro"><title>Uma breve introdução a um Domínio de rede</title>
<para>
Um domínio de rede consiste em uma máquina central chamada de PDC, que mantém o
controle de todas as contas de usuários/grupos e permissões para acesso a rede
NetBEUI.  O acesso desta forma é centralizado, como vantagem disto você pode
usar o nível de acesso por usuários nas máquinas, definindo quais usuários ou
grupos terão acesso de leitura/gravação.
</para>
<para>
É permitido criar scripts de logon, assim comandos programados pelo
administrador serão executados nas máquinas clientes durante o logon no domínio
(veja <xref linkend="s-samba-dom-logonscripts"/>).
</para>
<para>
O nome da máquina é protegido contra hijacking através de contas de máquinas
que fazem parte do domínio (veja <xref linkend="s-samba-dom-contasmac"/>).
Isto só é possível em clientes <command>Linux</command>, <command>Windows
NT</command>, <command>Windows 2000</command> e <command>Windows XP</command>.
</para>
<para>
Você poderá usar perfis móveis, copiando todas as personalizações do seu
desktop para qualquer máquina na rede que você faça o logon.  Para o
administrador, ele poderá definir políticas com o <command>Poledit</command> e
outros programas que serão salvas junto com o perfil do usuário, valendo para
qualquer máquina que ele se autentique na rede (veja <xref
linkend="s-samba-dom-logonscripts"/>).
</para>
<para>
Se você deseja iniciar logo a configuração do seu domínio, siga até <xref
linkend="s-samba-dom-config"/>.
</para>
</section>

<section id="s-samba-dom-lmbrowser"><title>Local Master Browser</title>
<para>
É a máquina que ganhou a eleição no segmento local de rede (veja <xref
linkend="s-samba-s-oslevel"/>).  Logo que é declarada o <emphasis>local master
browser</emphasis>, ela começa a receber via broadcasting a lista de recursos
compartilhados por cada máquina para montar a lista principal que será
retornada para outras máquinas do grupo de trabalho ou outras subredes que
solicite os recursos compartilhados por aquele grupo.
</para>
<para>
Uma nova eleição é feita a cada 36 minutos ou quando a máquina escolhida é
desligada.
</para>
</section>

<section id="s-samba-dom-dmbrowser"><title>Domain Master Browser</title>
<para>
Quando o local master browse é eleito no segmento de rede, uma consulta é feita
ao servidor WINS para saber quem é o Domain Master Browse da rede para enviar a
lista de compartilhamentos.  A máquina escolhida como Local Master Browse envia
pacotes para a porta UDP 138 do Domain Master e este responde pedindo a lista
de todos os nomes de máquinas que o local master conhece, e também o registra
como local master para aquele segmento de rede.
</para>
<para>
Caso tenha configurado sua máquina para ser o domain master browser da rede
(também chamado de <emphasis>controlador principal de domínio</emphasis> ou
PDC), ela tentará se tornar a máquina que terá a lista completa de recursos
enviados pelos locais master browsers de cada segmento de rede.  Um PDC também
é o local master browse de seu próprio segmento de rede.
</para>
<para>
É possível ter mais de um domain master browse, desde que cada um controle seu
próprio domínio, mas não é possível ter 2 domain master browsers em um mesmo
domínio.  Caso utilize um servidor <literal>WINS</literal> em sua rede, o PDC
fará consultas constantes em sua base de dados para obter a lista de domínios
registrados.  O domínio é identificado pelo caracter <emphasis>1b</emphasis> na
rede (veja <xref linkend="s-samba-c-workgroup-linux-nmblookup"/>).
</para>
<para>
<emphasis role="strong">OBS:</emphasis> O Windows NT configurado como PDC
sempre tenta se tornar o domain master browser em seu grupo de trabalho.  Não
sendo possível retirar o Windows NT configurado como PDC do domínio (por alguma
outra razão), a única forma será deixar ele ser o domain master browser.  Se
este for o caso, você poderá continuar lendo este documento para aprender mais
sobre NetBIOS e talvez ainda mudar de idéia sobre manter o NT na rede após ver
as características do SAMBA ;-)
</para>
</section>

<section id="s-samba-dom-config"><title>Configurando um servidor PDC no SAMBA</title>
<para>
Esta é a parte interessante do guia, a prática.  Para os administradores que
conhecem através da experiência própria os problemas e definições do SAMBA,
grande parte do guia foi apenas uma revisão (por favor, se faltou algo que acha
interessante, me notifiquem que incluirei na próxima versão e colocarei uma
nota no lançamento e na página com os devidos créditos :-))
</para>
<para>
Para configurar uma máquina para ser o PDC (<emphasis>Controladora Principal de
Domínio</emphasis> ou <emphasis>Primary Domain Control</emphasis>), siga esta
seqüência:
</para>
<itemizedlist>
<listitem>
<para>
Habilite o suporte a senhas criptografadas.  Caso ainda não tenha feito isso,
leia a seção <xref linkend="s-samba-senhas-crypto"/>.
</para>
</listitem>
<listitem>
<para>
Na seção <emphasis>[global]</emphasis>, insira/modifique os seguintes
parâmetros:
</para>
<screen>
; Identificação da máquina e domínio
netbios name = gleydson
workgroup = focalinux

;níveis de acesso e funções do servidor
security = user
domain master = yes
prefered master = yes
local master = yes

; senhas criptografadas
encrypt passwords = yes
smb passwd file = /etc/samba/smbpasswd.db
</screen>
<para>
Onde os parâmetros significam:
</para>
<itemizedlist>
<listitem>
<para>
<literal>netbios name = gleydson</literal> - Nome do computador.  Este também
será o nome usado pelas outras máquinas clientes quando for configurar o PDC
(<emphasis>controlador de domínio</emphasis>).
</para>
</listitem>
<listitem>
<para>
<literal>workgroup = focalinux</literal> - Nome do domínio que está criando.
Todas as máquinas que pertencerem a este domínio, terão o nível de acesso
definido pelo PDC.  Note que o parâmetro <literal>workgroup</literal> também é
usado ao especificar o nome do grupo de trabalho quando se é usado a
configuração <emphasis>grupo de trabalho</emphasis> (<xref
linkend="s-samba-wrkgrp"/>).
</para>
</listitem>
<listitem>
<para>
<literal>security = user</literal> - Requerido para controle de acesso por
domínio, já que é utilizado o controle de acesso local usando usuários e grupos
locais.
</para>
</listitem>
<listitem>
<para>
<literal>domain master = yes</literal> - Especifica se está máquina está sendo
configurada para ser o PDC da rede.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Por favor, certifique-se que não existe
outro PDC no domínio.  Veja <xref linkend="s-samba-dom-dmbrowser"/>.
<literal>prefered master = yes</literal> - Força uma eleição com algumas
vantagens para seu servidor ser eleito sempre como o controlador de domínio.
Isto garante que a máquina <command>SAMBA</command> sempre seja o PDC.  Veja
<xref linkend="s-samba-s-global-browsing"/>.  <literal>local master =
yes</literal> - Define se a máquina será o controlador principal do grupo de
trabalho local que ela pertence.
</para>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<para>
Pronto, agora teste se existem erros em sua configuração executando o comando
<command>testparm</command> (<xref linkend="s-samba-s-testparm"/>) e corrija-os
se existir.  Resta agora reiniciar o servidor <command>nmbd</command> para que
todas as suas alterações tenham efeito.  Para adicionar seus clientes a um
domínio, veja <xref linkend="s-samba-dom-contasmac"/> e <xref
linkend="s-samba-c-dominio"/>.
</para>
</section>

<section id="s-samba-dom-contasmac"><title>Contas de máquinas de domínio</title>
<para>
Uma conta de máquina de domínio garante que nenhum outro computador possa
utilizar o mesmo nome de uma máquina confiável e assim utilizar os
compartilhamentos que ela tem permissão.  Os clientes <command>Windows
NT</command>, <command>Windows XP</command> e <command>Windows 2000</command>
precisam de uma conta de máquina para ter acesso ao domínio e seus recursos.  A
criação de uma conta de máquina é bastante semelhante a criação da conta de um
usuário normal no domínio.
</para>
<para>
Existe uma coisa que precisa sempre ter em mente quando estiver configurando
uma conta de máquina de domínio: Quando você cria uma conta para a máquina, ela
entra e altera sua senha no próximo logon usando um "segredo" entre ela e o
PDC, este segredo a identifica sempre como dona daquele nome NetBIOS, ou seja,
até o primeiro logon no NT, outra máquina com o mesmo nome NetBIOS poderá ser a
dona do netbios naquele domínio caso faça o logon no domínio.  A única forma de
se evitar isto é logar imediatamente no domínio NT assim que criar as contas de
máquinas.
</para>
<para>
Existem duas formas para criação de contas de máquinas: manual e automática.
</para>
<section id="s-samba-dom-contasmac-dom-m"><title>Criando contas de máquinas manualmente</title>
<para>
Para criar uma conta de domínio para a máquina <literal>master</literal>, siga
estes 2 passos:
</para>
<orderedlist numeration="arabic">
<listitem>
<para>
Crie uma conta de máquina no arquivo <filename>/etc/passwd</filename>:
</para>
<screen>
useradd -g domainmac -c "Maquina de Dominio" -s /bin/false -d /dev/null master$
</screen>
<para>
O comando acima cria uma conta para a máquina <literal>master$</literal> e
torna ela parte do grupo <literal>domainmac</literal>.  É necessário
especificar o caracter <literal>$</literal> após o nome da máquina para criar
uma conta de máquina no domínio, caso contrário o próximo passo irá falhar.
Acredito que nas próximas versões do SAMBA seja desnecessário o uso do arquivo
<filename>/etc/passwd</filename> para a criação de contas de máquina.
</para>
</listitem>
<listitem>
<para>
Crie uma conta de máquina no arquivo <filename>/etc/samba/smbpasswd</filename>:
</para>
<screen>
smbpasswd -m -a master
</screen>
<para>
Isto cria uma conta de máquina para o computador <literal>master</literal> no
arquivo <filename>/etc/samba/smbpasswd</filename>.  Note que a criação de uma
conta de máquina é muito semelhante a criação de um usuário apenas precisa
adicionar a opção <literal>-m</literal>.  Quando for criar uma conta com o
<command>smbpasswd</command> Não é necessário especificar <literal>$</literal>
no final do nome da máquina.
</para>
<para>
O mais importante: Entre <emphasis role="strong">IMEDIATAMENTE</emphasis> no
domínio após criar a conta de máquina usando a conta de administrador de
domínio criada no SAMBA (veja <xref linkend="s-samba-dom-admin"/>)!  como a
máquina ainda não se autenticou pela primeira vez, qualquer máquina que tenha o
mesmo nome e entre no domínio, poderá alocar o nome recém criado.  A única
forma de resolver este problema, é apagando a conta de máquina e criando-a
novamente no domínio.  Siga os passos de acordo com o sistema operacional em
<xref linkend="s-samba-c-dominio"/> para colocar seus clientes em domínio.
</para>
</listitem>
</orderedlist>
<para>
<emphasis role="strong">OBS1:</emphasis> Como segurança, recomendo desativar a
conta de máquina no <filename>/etc/passwd</filename> usando o comando
<literal>passwd -l conta</literal>.  Esta conta NUNCA deverá ser usada para
login, isto deixa nossa configuração um pouco mais restrita.
</para>
<para>
<emphasis role="strong">OBS2:</emphasis> A localização do arquivo de senhas
criptografadas do SAMBA pode ser modificado através da opção <literal>smb
passwd file</literal> na seção <literal>[global]</literal> do arquivo
<filename>smb.conf</filename>.
</para>
<para>
<emphasis role="strong">OBS3:</emphasis> Os que tem experiência com NT e
Windows 2000 devem ter notado que este método é semelhante ao do
<emphasis>Server Manager</emphasis> das ferramentas de gerenciamentos de
servidores existentes no Windows.
</para>
</section>

<section id="s-samba-dom-contasmac-dom-a"><title>Criando contas de máquinas automaticamente</title>
<para>
Através deste método, as máquinas clientes terão sua conta criada
automaticamente assim que seja feita a entrada no domínio usando a conta do
administrador de domínio no SAMBA.  Este é o método recomendável de colocação
de máquinas no domínio por ser mais prática ao invés do método manual.  Note
que normalmente isto funciona para o WinXP e Win2000 mas não funciona em redes
com o NT4, devendo ser criadas contas de máquinas usando o método manual.
</para>
<para>
Para fazer a configuração automática, coloque a seguinte linha no arquivo
<filename>smb.conf</filename> na seção <literal>[global]</literal>:
</para>
<screen>
add user script = useradd -g domainmac -c "Maquina de Dominio" -s /bin/false -d /dev/null %u
</screen>
<para>
Assim, a conta de máquina será automaticamente criada quando o administrador
fizer sua configuração no domínio (veja <xref linkend="s-samba-dom-admin"/>).
No SAMBA 3.0, a opção <literal>add machine script</literal> deverá ser usada no
lugar de <literal>add user script</literal> para adicionar uma máquina no
domínio.
</para>
</section>

</section>

<section id="s-samba-dom-admin"><title>Criando uma conta de administrador de domínio</title>
<para>
A conta de administrador do domínio é a conta que tem permissões para realizar
operações de manutenção e administração de máquinas que compõem o domínio de
rede.  Com ela é possível, entre outras coisas, adicionar e remover máquina que
compõem o domínio.  Para especificar que contas de usuários do arquivo
<filename>/etc/samba/smbpasswd</filename> que terão poderes administrativos,
utilize a opção <literal>domain admin group</literal> ou <literal>admin
users</literal> na seção <literal>[global]</literal> do arquivo
<filename>/etc/samba/smb.conf</filename>.
</para>
<para>
O parâmetro <literal>admin users</literal> permite que todas as operações
realizadas pelo usuário sejam feitas com poderes de usuário
<literal>root</literal>.  Isto é necessário porque o arquivo
<filename>smbpasswd</filename> (usado para ajustar as contas de máquinas)
normalmente tem permissões de leitura/gravação somente para root.  O
<emphasis>domain admin group</emphasis> permite que usuários específicos ou
usuários do grupo especificado sejam parte do grupo de administradores do
domínio para adicionar máquinas, etc.  Por exemplo, para tornar o usuário
<literal>gleydson</literal> com privilégios para adicionar/remover máquinas no
domínio:
</para>
<screen>
[global]
...
admin users = gleydson
ou
domain admin group = @admins gleydson
</screen>
<para>
Isto permite que o usuário <literal>gleydson</literal> possa adicionar/remover
máquinas do domínio NT (veja <xref linkend="s-samba-c-dominio"/>) entre outras
tarefas.  Por segurança, recomendo que coloque esta conta no <literal>invalid
users</literal> de cada compartilhamento para que seja utilizada somente para
fins de gerenciamento de máquinas no domínio, a menos que deseje ter acesso
total aos compartilhamentos do servidor (nesse caso, tenha consciência do nível
de acesso que esta conta possui e dos problemas que pode causar caso caia em
mãos erradas).
</para>
<para>
<emphasis role="strong">OBS1:</emphasis> Tenha SEMPRE bastante cuidado com quem
dará poderes de administrador de domínio, pois toda sua rede poderá ficar
vulnerável caso os cuidados de administração não estejam em boas mãos.
</para>
<para>
<emphasis role="strong">OBS2:</emphasis> Em versões antigas do SAMBA, somente o
usuário <literal>root</literal> tem poderes para adicionar máquinas no domínio
usando o parâmetro <emphasis>domain admins group</emphasis>, devendo ser também
adicionado no arquivo <filename>smbpasswd</filename> para que possa fazer isto
e obviamente não deverá estar listado em <literal>invalid users</literal>.
Mesmo assim, existem outras formas explicadas no guia de se contornar o risco
causado pela liberação de acesso do usuário <literal>root</literal>.
</para>
</section>

<section id="s-samba-dom-logonscripts"><title>Criando Scripts de logon</title>
<para>
Uma dos recursos mais úteis em um domínio é a possibilidade de se executar
comandos nas máquinas cliente quando fazem o logon no domínio.  Desta forma, é
possível instalar programas, executar anti-vírus, mapear compartilhamentos
automaticamente no clientes, etc.  A programação de scripts de logon é feita
usando a linguagem em lote do DOS, com possibilidades de usar variáveis de
ambiente, cópia de arquivos entre servidores, etc.  O guia não irá abordar a
programação em linguagem de lote, mas isto é simples de se encontrar na
internet e mesmo a documentação que acompanha o próprio
<command>Windows</command> é útil.
</para>
<para>
Para habilitar o recurso de scripts de logon na máquina, adicione os seguintes
parâmetros no arquivo <filename>smb.conf</filename>:
</para>
<screen>
[global]
domain logons = yes
logon script = logon.cmd

[netlogon]
    path = /pub/samba/netlogon
    read only = yes
    write list = ntadmin
</screen>
<para>
Segue a descrição de cada parâmetro com detalhes importantes para a
configuração e funcionamento do recurso de logon:
</para>
<itemizedlist>
<listitem>
<para>
<literal>domain logons</literal> - Deve ser definido para
<literal>yes</literal> para ativar o recurso de logon scripts do SAMBA.
</para>
</listitem>
<listitem>
<para>
<literal>logon drive</literal> é a unidade de disco que terá o homedir do
usuário mapeado.  Isto somente é usado por máquinas NT/2000/XP.
</para>
</listitem>
<listitem>
<para>
<literal>logon script</literal> - Define qual é o script que será executado na
máquina cliente quando fizer o logon.  Ele deve ser gravado no diretório
especificado pela opção <literal>path</literal> do compartilhamento
<literal>[netlogon]</literal> (<filename>/pub/samba/netlogon</filename> no
exemplo).  Os scripts de logon podem ser tanto em formato
<filename>.bat</filename> ou <filename>.cmd</filename>.  Se for programar um
script universal, é recomendável o uso do formato <filename>.bat</filename> por
ser compatível tanto com <command>Win9X</command> e <command>WinNT</command>.
</para>
</listitem>
</itemizedlist>
<para>
Um detalhe que deve ser lembrado durante a programação do script de logon é que
ele <emphasis role="strong">DEVE</emphasis> seguir o formato DOS, ou seja, ter
os caracteres <literal>CR+LF</literal> como finalizador de linhas.  Para
utilizar editores do UNIX para escrever este script, será necessário executar o
programa <command>flip</command> (<literal>flip -m -b arquivo</literal>) ou
<command>unix2dos</command> no arquivo para converte-lo em formato compatível
com o DOS.
</para>
<para>
Segue abaixo um exemplo de script de logon que detecta quando o cliente é
Windows 95/NT, ajusta a hora com o servidor e mapeia 2 unidades de disco:
</para>
<screen>
@echo off
cls
rem Logon Script desenvolvido por Gleydson Mazioli 
rem da Silva como modelo para o guia Foca GNU/Linux
rem
rem Este script pode ser utilizado para fins didáticos
rem e distribuído livremente de acordo com os termos
rem da GPL 
rem 
echo "Aguarde enquanto sua máquina efetua"
echo "o logon na rede do domínio focalinux."
rem 
if %OS%==Windows_NT goto NT-2000
rem 
echo "--------------------------------"
echo "SO: %OS%"
echo "Usuário: %USERNAME%"
echo "Grupo de Trabalho: %LANGROUP%"
echo "Servidor: %DOMINIO%"
echo "--------------------------------"
echo "Recuperando compartilhamentos"
rem mapeia o compartilhamento publico definido no servidor
net use e: \\gleydson\publico
echo "Sincronizando data/hora"
rem sincroniza a data/hora com o servidor
net time \\gleydson /set /yes
goto fim
rem
rem
:NT-2000
echo "--------------------------------"
echo "SO: %OS%"
echo "Usuário: %USERNAME%"
echo "Windows: %windir%"
echo "Logon de domínio: %LOGONSERVER%"
echo "--------------------------------"
echo "Recuperando compartilhamentos"
net use e: \\gleydson\publico /persistent:yes
echo "Sincronizando data/hora"
net time \\gleydson /set /yes
rem
rem
goto fim
rem
:fim
</screen>
<para>
Note no exemplo acima que não podem haver linhas em branco, você deverá
utilizar a palavra <replaceable>rem</replaceable> (comentário em arquivos em
lote) em seu lugar.  Note que existem diferenças entre o comando
<command>net</command> do Windows 9x/ME e do NT, as variáveis também possuem um
significado diferente entre estes 2 sistemas, isto explica a necessidade de se
incluir um bloco separado detectando a existência de qual sistema está sendo
efetuado o logon.
</para>
<para>
A lista completa de variáveis disponíveis para cada sistema operacional pode
ser obtida colocando-se <literal>set >c:\vars.txt</literal> que gravará uma
lista de variáveis disponíveis durante o logon no arquivo
<filename>c:\vars.txt</filename> da máquina cliente.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Caso especifique um computador que
contém o script de login, lembre-se de faze-lo sempre com <literal>\</literal>
ao invés de <literal>/</literal> para não ter incompatibilidade com o
<command>Windows 95/3.11</command>.
</para>
<para>
<emphasis role="strong">ATENÇÃO:</emphasis> Lembre-se que copiar e colar pode
não funcionar para este script.  Leia novamente esta seção do guia se estiver
em dúvidas.
</para>
</section>

<section id="s-samba-dom-profiles"><title>Configurando perfis de usuários</title>
<para>
Os profiles permitem que os clientes utilizem o mesmo perfil em qualquer
máquina que ele se autentique na rede.  Isto é feito após a autenticação
copiando os arquivos que contém os dados de personalização de usuários
(<filename>user.dat</filename>, <filename>NTuser.dat</filename>) para a máquina
local.  Este processo também inclui a cópia de papéis de parede, links da área
de trabalho, cache do IE, etc.  Para configurar o recurso de perfis móveis no
domínio, é necessário adicionar os seguintes parâmetros no seu arquivo
<filename>smb.conf</filename>:
</para>
<screen>
[global]
security = user
encrypt passwords = yes
domain logons = yes
logon drive = H:
logon path = \\%N\profilesNT\%u
logon home  = \\%N\profiles\%u
preserve case = yes
short preserve case = yes
case sensitive = no

[profiles]
    path = /pub/profiles
    read only = no
    create mask = 0600
    directory mask = 0700

[profilesNT]
    path = /pub/profilesNT
    read only = no
    create mask = 0600
    directory mask = 0700
</screen>
<para>
Segue a descrição dos parâmetros de detalhes para seu funcionamento:
</para>
<itemizedlist>
<listitem>
<para>
O parâmetro <literal>domain logons = yes</literal> especifica que o servidor
será usado para fazer logons no domínio.  Quando este parâmetro é definido para
<literal>yes</literal>, a máquina automaticamente tentará ser o PDC.
</para>
</listitem>
<listitem>
<para>
<literal>logon path</literal> e <literal>logon home</literal> definem
(respectivamente) o diretório de logon do
<filename>/pub/profilesNT/usuario</filename> (<command>NT</command>) e
<filename>/pub/profiles/usuario</filename> (<command>Win95</command>)
respectivamente.  Durante o logon, a variável <literal>%N</literal> será
substituída pelo nome do servidor (ou servidor de diretórios, se for o caso) e
a variável <literal>%u</literal> pelo nome do usuário.
</para>
<para>
O sistema operacional de origem é detectado no momento da conexão.  Isto
significa que o usuário poderá ter 2 profiles diferentes, de acordo com o tipo
de sistema operacional cliente que estiver conectando.
</para>
</listitem>
<listitem>
<para>
O diretório home do usuário será mapeado para a unidade <literal>H:</literal>
(<literal>logon drive = h:</literal>).  O parâmetro <literal>logon
drive</literal> somente é usado pelo NT/2000/XP.
</para>
</listitem>
<listitem>
<para>
As opções <literal>preserve case</literal>, <literal>short preserve
case</literal> e <literal>case sensitive</literal> permite que os nomes dos
arquivos/diretórios tenham as letras maiúsculas/minúsculas mantidas, isto é
requerido para os profiles.
</para>
</listitem>
</itemizedlist>
<para>
O compartilhamento dos 2 profiles pode ser feito sem tantos traumas, mas isto
não será explicado profundamente no guia pois o procedimento segue o mesmo
padrão do NT sendo bastante documentado na internet.
</para>
<para>
Note que é possível definir um servidor separado para servir os profiles para
um domínio modificando a variável <literal>%N</literal> para apontar direto
para a máquina.  Na máquina que armazenará os profiles, basta definir o nível
de segurança por <literal>servidor</literal> (<literal>security =
server</literal>) e o endereço IP do servidor de senhas (<literal>password
server = IP</literal>).
</para>
<para>
<emphasis role="strong">OBS1:</emphasis> Os perfis só funcionam caso o servidor
de profiles contenha a opção <literal>security = user</literal> e
<literal>encrypt passwords = yes</literal> ou <literal>security =
server</literal> e <literal>password server = endereço_IP</literal>.  Caso
tenha problemas, verifique se uma destas alternativas está correta.
</para>
<para>
<emphasis role="strong">OBS2:</emphasis> Quando utiliza o SAMBA com o Windows
2000 SP2, é necessário adicionar a opção <literal>nt acl support = no</literal>
no compartilhamento <literal>[profiles]</literal>, caso contrário, ele
retornará um erro de acesso ao compartilhamento.
</para>
</section>

<section id="s-samba-dom-perm-clientes"><title>Modificações de permissões de acesso pelos clientes do domínio</title>
<para>
Um usuário do Windows NT (ou versões baseadas neste) pode modificar as
permissões dos arquivos/diretórios que tem acesso através da caixa de diálogo
de listas de acesso do NT, lembrando que estas permissões nunca substituirão as
definidas pelo administrador local.
</para>
<para>
A opção "nt acl support" deverá estar definida para "yes" na seção
<literal>[global]</literal> do arquivo de configuração, caso contrário você não
terá acesso para mudar as permissões através de caixas de diálogo do NT.  \
</para>
</section>

</section>

<section id="s-samba-senhas-crypto"><title>Ativando o suporte a senhas criptografadas</title>
<para>
O uso de senhas criptografadas é um requisito quando você deseja configurar o
SAMBA para ser um servidor PDC ou um cliente de um domínio.  Quando utiliza
senhas criptografadas, elas trafegam em formato seguro através da rede,
dificultando a captura por outras pessoas.  Em versões mais recentes do Windows
(a partir da OSR/2 e NT 4 service pack3) o suporte a senhas criptografadas vem
habilitado como padrão para login e utilização de serviços da rede.  Não é
recomendável desativar o uso de senhas criptografadas, mas se mesmo assim for
necessário veja <xref linkend="s-samba-a-passwords"/>.
</para>
<para>
Quando usamos senhas criptografadas, elas são armazenadas no arquivo
<filename>/etc/samba/smbpasswd</filename> ao invés do
<filename>/etc/passwd</filename>, isto permite que possamos controlar as
permissões de usuários separadamente das do sistema e diferenciar os logins do
domínio dos logins do sistema (usuários que possuem shell).  Caso tenha um
servidor que já possua muitas contas de usuários acessando em texto plano,
recomendo ler <xref linkend="s-samba-senhas-crypto-migrando"/> para facilitar o
processo de migração de contas.
</para>
<para>
O utilitário <command>smbpasswd</command> é o programa utilizado para gerenciar
este arquivo de senhas e também o status de contas de usuários/máquinas do
domínio.  Siga estes passos para ativar o uso de senhas criptografadas no
SAMBA:
</para>
<orderedlist numeration="arabic">
<listitem>
<para>
Edite o arquivo <filename>/etc/samba/smb.conf</filename> e altere as seguintes
linhas na seção <literal>[global]</literal> para adicionar o suporte a senhas
criptografadas:
</para>
<screen>
[global]
encrypt passwords = true
smb passwd file =/etc/samba/smbpasswd
</screen>
<para>
A linha <literal>encrypt passwords = true</literal> diz para usar senhas
criptografadas e que o arquivo <filename>/etc/samba/smbpasswd</filename> contém
as senhas (<literal>smb passwd file =/etc/samba/smbpasswd</literal>).
</para>
<para>
Caso sua máquina seja apenas um cliente de rede (e não um PDC), você pode pular
para o passo onde o <command>SAMBA</command> é reiniciado (no final dessa
lista), não é necessária a criação do arquivo de senhas para autenticação pois
os usuários serão validados no servidor.
</para>
</listitem>
<listitem>
<para>
Execute o comando <literal>mksmbpasswd &lt;/etc/passwd
&gt;/etc/samba/smbpasswd</literal>.  Ele pega toda a base de usuários do
<filename>/etc/passwd</filename> e gera um arquivo
<filename>/etc/samba/smbpasswd</filename> contendo as contas destes usuários.
Por padrão, todas as contas são DESATIVADAS por segurança quando este novo
arquivo é criado.  O novo arquivo terá o seguinte formato:
</para>
<screen>
gleydson:1020:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:[U          ]:LCT-00000000:Gleydson Mazioli da Silva,,,
geovani:1004:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:[U          ]:LCT-00000000:Geovani Mazioli da Silva,,,
</screen>
<para>
Os campos são separados por ":" e cada campo possui o seguinte significado:
</para>
<orderedlist numeration="arabic">
<listitem>
<para>
O primeiro é o nome de usuário
</para>
</listitem>
<listitem>
<para>
UID do usuário no sistema UNIX que a conta será mapeada.
</para>
</listitem>
<listitem>
<para>
Senha Lan Manager codificada em hex 32 criado usando criptografia DES usada
pelo Windows 95/98/ME.
</para>
</listitem>
<listitem>
<para>
Senha hash criada em formato do NT codificada em hex 32.  Esta senha é criada
pegando a senha do usuário, convertendo-a para maiúsculas, adicionados 5 bytes
de caracteres nulos e aplicando o algoritmo md4.
</para>
</listitem>
<listitem>
<para>
Opções da conta criada no <filename>smbpasswd</filename>:
</para>
<itemizedlist>
<listitem>
<para>
<literal>U</literal> - Especifica que a conta é uma conta de usuário normal
(veja <xref linkend="s-samba-senhas-crypto-criando"/>)
</para>
</listitem>
<listitem>
<para>
<literal>D</literal> - Significa que a conta foi desativada com a opção
<literal>-d</literal> (veja <xref
linkend="s-samba-senhas-crypto-desabilitando"/>).
</para>
</listitem>
<listitem>
<para>
<literal>W</literal> - Especifica que a conta é uma conta de máquina criada com
a opção <literal>-m</literal> (veja <xref linkend="s-samba-dom-contasmac"/>).
</para>
</listitem>
<listitem>
<para>
<literal>N</literal> - A conta não possui senha (veja <xref
linkend="s-samba-senhas-crypto-nopasswd"/>).
</para>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
<para>
Os caracteres "XXXXXXXXXXXXXXX" no campo da senha, indica que a conta foi recém
criada, e portanto está desativada.  O próximo passo é ativar a conta para ser
usada pelo SAMBA.
</para>
<para>
<emphasis role="strong">ATENÇÃO:</emphasis> O método de criptografia usado
neste arquivo não é totalmente seguro.  Recomendo manter o arquivo de senhas
<filename>smbpasswd</filename> em um diretório com a permissão de leitura
somente pelo <literal>root</literal>.
</para>
</listitem>
<listitem>
<para>
Para ativar a conta do usuário <literal>gleydson</literal>, usamos o comando:
</para>
<screen>
smbpasswd -U gleydson
</screen>
<para>
Digite a senha do usuário e repita para confirmar.  Assim que a senha for
definida, a conta do usuário é ativada.  Você também pode especificar a opção
"-s" para entrar com a senha pela entrada padrão (muito útil em scripts).
Apenas tenha cuidado para que esta senha não seja divulgada em seus
arquivos/processos.
</para>
</listitem>
<listitem>
<para>
Reinicie o processo do SAMBA (veja <xref linkend="s-samba-rodando"/>).
</para>
</listitem>
<listitem>
<para>
Verifique se o suporte a senhas criptografadas está funcionando com o comando:
</para>
<screen>
 smbclient -L localhost -U gleydson
</screen>
<para>
Substitua <literal>localhost</literal> pelo IP do servidor e
<literal>gleydson</literal> pelo usuário.  Caso obtenha a mensagem
<literal>session setup failed: NT_STATUS_LOGON_FAILURE</literal> significa que
a senha informada está incorreta.
</para>
</listitem>
</orderedlist>
<section id="s-samba-senhas-crypto-migrando"><title>Migrando de senhas texto plano para criptografadas</title>
<para>
No SAMBA, é possível fazer um processo de migração de senhas em texto plano de
usuários para criptografadas sem que eles deixem de acessar o servidor durante
esta mudança.  Caso este seja seu caso, insira o parâmetro
</para>
<screen>
update encrypted = yes
</screen>
<para>
na seção <literal>[global]</literal> do seu arquivo de configuração
<filename>smb.conf</filename>.  A senha criptografada é definida assim que o
usuário se logar usando sua senha em texto plano.  Não se esqueça de desativar
esta opção ou remove-la após o prazo necessário para que todas as senhas sejam
trocadas.
</para>
</section>

<section id="s-samba-senhas-crypto-criando"><title>Adicionando usuários no <filename>smbpasswd</filename></title>
<para>
A adição de um usuário no <filename>smbpasswd</filename> segue duas etapas:
primeiro é necessário adiciona-lo no sistema com o <command>adduser</command> e
depois no samba com o <command>smbpasswd</command>.  Você deve estar se
perguntando qual a vantagem de se ter um arquivo separado de usuários se ainda
é preciso criar o login nos dois arquivos; O <command>SAMBA</command> para
fazer o controle de acesso aos arquivos utiliza além dos mecanismos
tradicionais do NT, o controle de permissões a nível UNIX para manter os
arquivos ainda mais restritos.  Além disso, será necessário usuários e grupos
para criação e acesso ao sistema.
</para>
<orderedlist numeration="arabic">
<listitem>
<para>
Adicione um usuário no sistema com o comando:
</para>
<screen>
 useradd -g grupo-dominio -c "Usuário de Domínio" -s /bin/false -d /dev/null joao
</screen>
<para>
Este comando adiciona o usuário "joao" no grupo
<literal>grupo-dominio</literal> e não define hem uma shell, diretório home nem
senha para este usuário.  Isto mantém o sistema mais seguro e não interfere no
funcionamento do SAMBA, pois somente é necessário para fazer o mapeamento de
UID/GID de usuários com as permissões do sistema UNIX.
</para>
<para>
É interessante padronizar os usuários criados no domínio para um mesmo grupo
para pesquisa e outras coisas.
</para>
</listitem>
<listitem>
<para>
Crie o usuário "joao" no SAMBA:
</para>
<screen>
smbpasswd -a joao
</screen>
<para>
Será solicitada a senha do usuário.
</para>
</listitem>
</orderedlist>
</section>

<section id="s-samba-senhas-crypto-removendo"><title>Removendo usuários do <filename>smbpasswd</filename></title>
<para>
Utilize o comando <literal>smbpasswd -x usuario</literal> para remover um
usuário do arquivo <filename>smbpasswd</filename>.  Se desejar, você pode
manter o usuário no <filename>/etc/passwd</filename> ou remove-lo com o
<command>userdel</command>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Removendo um usuário deste arquivo fará
que ele não tenha mais acesso ao SAMBA.  Utilize o comando <literal>smbpasswd
-a teste</literal>
</para>
</section>

<section id="s-samba-senhas-crypto-desabilitando"><title>Desabilitando uma conta no <filename>smbpasswd</filename></title>
<para>
Como administrador, pode ser necessário que precise desativar temporariamente
uma conta de usuário por alguma situação qualquer (má utilização de recursos,
dúvida se a conta está sendo usada, para que ele ligue reclamando de
autenticação para ter aquela desejada conversa (hehe), etc.).  Remover uma
conta e novamente adiciona-la então não é uma situação muito prática.  Utilize
então o seguinte comando para desativar uma conta de usuário:
</para>
<screen>
smbpasswd -d usuario
</screen>
<para>
Quando a conta de usuário é desativada, uma flag "D" é adicionada às opções do
usuário (junto com as opções "UX").  Veja <xref
linkend="s-samba-senhas-crypto-habilitando"/> para reativar a conta.
</para>
</section>

<section id="s-samba-senhas-crypto-habilitando"><title>Habilitando uma conta no <filename>smbpasswd</filename></title>
<para>
Uma conta desativada com o uso do comando <literal>smbpasswd -d</literal> pode
ser novamente ativada usando:
</para>
<screen>
 smbpasswd -e usuario
</screen>
</section>

<section id="s-samba-senhas-crypto-chpasswd"><title>Alterando a senha de um usuário</title>
<para>
O utilitário <command>smbpasswd</command> pode ser usado tanto para alterar a
senha de usuários locais do <command>SAMBA</command> ou de uma conta em um
servidor remoto (seja <command>SAMBA</command>, <command>NT</command>,
<command>W2K</command>).  Para alterar a senha de um usuário local, digite:
</para>
<screen>
smbpasswd -U usuario
</screen>
<para>
Lhe será pedida a antiga senha, a nova senha e a confirmação.  Caso seja o
usuário <literal>root</literal>, somente a nova senha e a confirmação.  Isto é
mecanismo de proteção para usuários que esquecem a senha ;-)
</para>
<para>
Para alterar a senha de um usuário remoto, utilize:
</para>
<screen>
smbpasswd -r servidor -U usuario
</screen>
<para>
Note que apenas foi adicionada a opção <literal>-r servidor</literal> comparado
com a opção anterior.  A diferença é que a senha antiga do usuário sempre será
solicitada para troca (pois o root das 2 máquinas pode não ser o mesmo).
</para>
</section>

<section id="s-samba-senhas-crypto-nopasswd"><title>Definindo acesso sem senha para o usuário</title>
<para>
Para fazer um usuário acessar sem senha, use o comando:
</para>
<screen>
smbpasswd -n usuario
</screen>
<para>
Isto é completamente desencorajado e necessita que a opção <literal>null
passwords</literal> da seção <literal>[global]</literal> no arquivo
<filename>smb.conf</filename> esteja ajustada para <emphasis>yes</emphasis>
(<emphasis role="strong">que NÃO é o padrão</emphasis>).
</para>
</section>

</section>

<section id="s-samba-senhas-plano"><title>Ativando o suporte a senhas em texto plano</title>
<para>
Esta forma de autenticação é enviada por implementações NetBIOS antigas, como a
encontrada no <command>Lan Manager</command>, <command>Windows for
Workgroups</command> e <command>Windows 95 OSR1</command>.  As versões mais
novas destas implementações enviam a senha em formato criptografado, sendo
necessário também usar o formato criptografado no SAMBA para que possa se
autenticar (veja <xref linkend="s-samba-senhas-crypto"/>).
</para>
<para>
Em <xref linkend="s-samba-a-passwords"/> é feita uma comparação entre o uso de
autenticação usando senhas em texto plano e senhas criptografadas.  Em geral, o
administrador prefere a utilização da autenticação usando texto plano quando
deseja usar o <filename>/etc/passwd</filename> para autenticação e está usando
grupos de trabalho é necessário usar senhas criptografadas para autenticação).
</para>
<para>
Para configurar o <command>SAMBA</command> para utilizar senhas em texto,
modifique o parâmetro <literal>encrypt passwords</literal> para
<literal>no</literal>:
</para>
<screen>
[global]
encrypt passwords = no
</screen>
<para>
Reinicie o <command>SAMBA</command> (<xref linkend="s-samba-rodando"/>) e a
partir de agora, ele usará o <filename>/etc/passwd</filename> para
autenticação.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Tenha certeza de não estar participando
de um domínio ou que sua máquina seja o PDC antes de fazer esta modificação.
</para>
<section id="s-samba-senhas-plano-c"><title>Configurando o acesso de clientes para uso de senhas em texto plano</title>
<para>
Esta seção descreve como configurar clientes para acessar o servidor
<command>SAMBA</command> usando autenticação em texto plano.  Atualmente o guia
cobre os seguintes clientes:
</para>
<itemizedlist>
<listitem>
<para>
<xref linkend="s-samba-senhas-plano-c-lanmanager"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-senhas-plano-c-wfw"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-senhas-plano-c-win95a"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-senhas-plano-c-win95b"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-senhas-plano-c-win98"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-senhas-plano-c-winME"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-senhas-plano-c-winNT"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-senhas-plano-c-win2000"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-senhas-plano-c-linux"/>
</para>
</listitem>
</itemizedlist>
<para>
Em cada seção, também é explicado como habilitar novamente a autenticação
usando senhas criptografadas (se suportado pelo cliente).
</para>
<section id="s-samba-senhas-plano-c-lanmanager"><title>Lan Manager</title>
<para>
Cliente NetBIOS para DOS.  Ele trabalha somente com senhas em texto plano.
</para>
</section>

<section id="s-samba-senhas-plano-c-wfw"><title>Windows for Workgroups</title>
<para>
Este é o padrão de autenticação do <command>Windows for Workgroups</command>
caso não tenha feito nenhuma alteração específica (mas desconheço algo que
faça-o trabalhar com senhas criptografadas).
</para>
</section>

<section id="s-samba-senhas-plano-c-win95a"><title>Windows 95 / Windows 95A</title>
<para>
O <command>Windows 95</command> até a release "A", utiliza texto plano como
padrão para autenticação (veja qual a release clicando com o botão direito em
<emphasis>Meu Computador</emphasis> e <emphasis>Propriedades</emphasis>.
</para>
</section>

<section id="s-samba-senhas-plano-c-win95b"><title>Windows 95B</title>
<para>
Copie o seguinte conteúdo para um arquivo chamado
<filename>win95-textoplano.reg</filename>:
</para>
<screen>
REGEDIT4

[HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\VxD\VNETSUP]
"EnablePlainTextPassword"=dword:00000001
</screen>
<para>
Após isto, execute no <command>Windows 95</command> o seguinte comando:
<literal>regedit win95-textoplano.reg</literal> e reinicie o computador para
fazer efeito.
</para>
<para>
Para voltar a utilizar criptografia, apenas altere o valor
<literal>dword</literal> para <literal>00000000</literal> no arquivo e executa
novamente o <command>regedit</command>.
</para>
</section>

<section id="s-samba-senhas-plano-c-win98"><title>Windows 98/98SE</title>
<para>
O procedimento é idêntico ao <xref linkend="s-samba-senhas-plano-c-win95b"/>.
</para>
</section>

<section id="s-samba-senhas-plano-c-winME"><title>Windows ME</title>
<para>
O procedimento é idêntico ao <xref linkend="s-samba-senhas-plano-c-win95b"/>.
</para>
</section>

<section id="s-samba-senhas-plano-c-winNT"><title>Windows NT Server/WorkStation</title>
<para>
Copie o seguinte conteúdo para um arquivo chamado
<filename>winNT-textoplano.reg</filename>:
</para>
<screen>
REGEDIT4

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Rdr\Parameters]
"EnablePlainTextPassword"=dword:00000001
</screen>
<para>
Após isto, execute no <command>Windows NT</command> o seguinte comando:
<literal>regedit winNT-textoplano.reg</literal> e reinicie o computador para
fazer efeito.
</para>
<para>
Para voltar a utilizar criptografia, apenas altere o valor
<literal>dword</literal> para <literal>00000000</literal> no arquivo e execute
novamente o <command>regedit</command>.
</para>
</section>

<section id="s-samba-senhas-plano-c-win2000"><title>Windows 2000</title>
<para>
Copie o seguinte conteúdo para um arquivo chamado
<filename>win2000-textoplano.reg</filename>:
</para>
<screen>
REGEDIT4

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanWorkStation\Parameters]
"EnablePlainTextPassword"=dword:00000001
</screen>
<para>
Após isto, execute no <command>Windows 2000</command> o seguinte comando:
<literal>regedit win2000-textoplano.reg</literal> e reinicie o computador para
fazer efeito.
</para>
<para>
Para voltar a utilizar criptografia, apenas altere o valor
<literal>dword</literal> para <literal>00000000</literal> no arquivo e execute
novamente o <command>regedit</command>.
</para>
</section>

<section id="s-samba-senhas-plano-c-linux"><title>Linux</title>
<para>
Inclua/modifique a linha <literal>encrypt passwords = no</literal> no arquivo
<filename>smb.conf</filename> e reinicie o <command>SAMBA</command>.  Para
voltar a utilizar criptografia, veja <xref linkend="s-samba-senhas-crypto"/>.
</para>
</section>

</section>

</section>

<section id="s-samba-usermap"><title>Mapeamento de usuários/grupos em clientes</title>
<para>
O mapeamento de usuários do servidor remoto com a máquina local é usado quando
você deseja controlar o acesso aos arquivos/diretórios a nível de usuário.  No
<command>Windows</command> isto permite que cada arquivo/diretório tenha o
acesso leitura/gravação somente para os usuários definidos e autenticados no
controlador de domínio.  No <command>Linux</command> as permissões de arquivos
e diretórios podem ser definidas para o usuário do PDC, garantindo o mesmo
nível de controle de acesso.
</para>
<para>
Esta seção explica como configurar o mapeamento de UID/GID entre o servidor PDC
SAMBA e seus clientes NetBIOS Windows e Linux.
</para>
<section id="s-samba-usermap-w"><title>Mapeamento de usuários/grupos domínio em Windows</title>
<para>
Para o <command>Windows</command> utilizar os usuários remotos do servidor para
fazer seu controle de acesso por nível de usuário, siga os seguintes passos:
</para>
<variablelist>
<varlistentry>
<term>Windows 9X</term>
<listitem>
<para>
Entre no <emphasis>Painel de Controle</emphasis>/<emphasis>Propriedades de
Rede</emphasis> e clique na tab <emphasis>Controle de Acesso</emphasis>.
Marque a opção <emphasis>Controle de acesso a nível de usuário</emphasis> e
coloque o nome da máquina PDC na caixa de diálogo de onde os usuários/grupos
serão obtidos.  Você também pode colocar o nome do grupo de trabalho, neste
caso a máquina fará uma busca pelo PDC ou outra máquina de onde pode obter os
nomes de usuários/grupos.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Para fazer isto, você deverá estar
autenticado no domínio.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section id="s-samba-usermap-l"><title>Mapeamento de usuários/grupos domínio em Linux</title>
<para>
A associação de UIDs de usuários de um domínio com usuários locais no
<command>Linux</command> é feita pelo programa <command>winbind</command>.  Ele
utiliza o mecanismo <command>nsswitch</command> para obter outras fontes de
dados de usuários e os associa nas ferramentas de gerenciamento de contas
existentes no sistema.  Siga estes passos para fazer sua instalação e
configuração do <command>Winbind</command> em um servidor
<command>Linux</command>:
</para>
<itemizedlist>
<listitem>
<para>
Instale o programa <command>winbind</command>: <literal>apt-get install
winbind</literal>.
</para>
</listitem>
<listitem>
<para>
Modifique o arquivo <filename>smb.conf</filename> adicionando as seguintes
linhas na seção <literal>[global]</literal>:
</para>
<screen>
winbind separator = +
winbind cache time = 30
winbind uid = 10000-15000
winbind gid = 10000-12000
winbind enum users = yes
winbind enum groups = yes
template homedir = /home/winbind/%D/%U
template shell = /bin/false
</screen>
<para>
Onde
</para>
<variablelist>
<varlistentry>
<term>winbind separator</term>
<listitem>
<para>
Separador usado para separar o nome dos grupos do nome de domínio.  Este
parâmetro somente tem sentido quando usado em conjunto com um PDC Windows ou
quando os módulos <filename>pam_winbind.so</filename> e
<filename>nss_winbind.so</filename> estão sendo utilizados.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>winbind cache time</term>
<listitem>
<para>
Define a quantidade de tempo em segundos que um nome/grupo permanecerá no cache
local para não ser feita uma nova consulta no servidor PDC.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>winbind uid</term>
<listitem>
<para>
Especifica o intervalo que será usado para mapear os nomes de usuários remotos
como UIDs locais.  Você precisará ter certeza que nenhum UID nesse intervalo é
usado no sistema, como pelo LDAP, NIS ou usuários normais.  Por padrão, os IDS
de usuários normais na maioria dos sistemas Linux, começam por 1000.  No
exemplo serão usados os UIDs de 10000 a 15000 para mapeamento e UIDs dos
usuários do domínio para usuários locais.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>winbind gid</term>
<listitem>
<para>
Especifica o intervalo de GIDs que será usado para mapear os nomes de grupos
remotos do domínio como GIDs locais.  Como no parâmetro <literal>winbind
uid</literal>, você deverá ter certeza que esta faixa de GIDs não está sendo
usada em seu sistema.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Atualmente <command>SAMBA</command> não
possui suporte a grupos globais, apenas para usuários globais, desta forma os
grupos da máquina remota não serão trazidos para o sistema.  Uma forma de
contornar isto, é utilizando o LDAP ou o NIS no PDC e nos clientes
<command>Linux</command>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>winbind enum users</term>
<listitem>
<para>
Permite enumerar usuários do winbind para retornarem dados quando solicitados.
A não ser que possua uma instalação parecida em todas as máquinas (como com o
uso de LDAP e NIS) responda "yes" para não ter problemas.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>winbind enum groups</term>
<listitem>
<para>
Permite enumerar grupos do winbind para retornarem dados quando solicitados.  A
não ser que possua uma instalação parecida em todas as máquinas (como com o uso
de LDAP e NIS) responda "yes" para não ter problemas.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>template homedir</term>
<listitem>
<para>
Quando o sistema cliente for um Windows NT ou baseado, este diretório será
retornado como diretório de usuário para o sistema.  O parâmetro %D será
substituído pelo nome do domínio e %U pelo nome de usuário durante a conexão.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>template shell</term>
<listitem>
<para>
Este será o shell enviado para máquinas NT ou baseadas nele como shell usado
para login.  O valor usado foi <filename>/bin/false</filename> pois desabilita
os logons, mas você poderá usar <filename>/bin/sh</filename> (ou algum outro
shell) para efetuar conexões do comando <command>net</command> ou outras
ferramentas NetBEUI ao servidor.
</para>
</listitem>
</varlistentry>
</variablelist>
</listitem>
<listitem>
<para>
Reinicie o servidor <command>SAMBA</command>
</para>
</listitem>
<listitem>
<para>
Edite o arquivo <filename>/etc/nsswitch.conf</filename> alterando a ordem de
pesquisa de nomes de usuários e grupos do sistema local para a seguinte:
</para>
<screen>
passwd:         files winbind
group:          files winbind
shadow:         compat
</screen>
</listitem>
<listitem>
<para>
Agora, inicie o daemon <command>winbind</command> local com o comando:
<literal>/etc/init.d/winbind restart</literal>.
</para>
</listitem>
<listitem>
<para>
Entre no domínio com o comando: <literal>smbpasswd -j domínio -r nome_do_PDC -U
usuario</literal> (veja <xref linkend="s-samba-c-dominio-linux"/> para aprender
como entrar no domínio em caso de dúvidas).
</para>
</listitem>
<listitem>
<para>
Agora faça o teste para obter a listagem dos grupos e usuários do domínio do
PDC digitando:
</para>
<screen>
wbinfo -u
wbinfo -g
getent passwd
getent group
</screen>
<para>
Caso isto não aconteça, revise suas configurações e veja os logs procurando por
erros quando o <command>winbind</command> tenta obter a lista de
usuários/grupos do domínio.
</para>
</listitem>
</itemizedlist>
<para>
Agora você deve ser capaz de criar diretórios/arquivos locais usando os nomes
de usuários/grupos do domínio.  Lembre-se de reiniciar sempre o
<command>winbind</command> quando reiniciar o SAMBA por alguma modificação for
feita (ao mesmo que saiba que não afeta o <command>winbind</command>), assim
como entrar novamente no domínio, caso contrário o mapeamento deixará de
funcionar.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Atualmente, o
<command>winbind</command> não oferece suporte a restrições por data/hora de
logon para estações de trabalho.  Isto deverá ser implementado em uma futura
versão
</para>
</section>

</section>

<section id="s-samba-i"><title>Compartilhamento de impressão no servidor SAMBA</title>
<para>
Este capítulo documenta como configurar o seu servidor samba para permitir o
acesso a compartilhamento de arquivos e impressão no sistema.
</para>
<section id="s-samba-i-win-linux"><title>Configurando o Linux como um servidor de impressão Windows</title>
<para>
Será necessário ter o pacote <systemitem role="package">samba</systemitem>
instalado e adicionar as seguintes linhas no seu arquivo
<filename>/etc/samba/smb.conf</filename>:
</para>
<screen>
[hp-printer]
 path = /tmp
 printer name=HP DeskJet 690C
 printable = yes
 print command = lpr -r -h -P %p %s
 valid users = winuser winuser2
 create mode = 0700
</screen>
<para>
O compartilhamento acima tornará disponível a impressora local "lp" as máquinas
Windows com o nome "HP DeskJet 690C".  Uma impressora alternativa pode ser
especificada modificando a opção <emphasis>-P</emphasis> da linha de comando do
<command>lpr</command>.  Note que somente os usuários "winuser" e "winuser2"
poderão usar esta impressora.  Os arquivos de spool (para gerenciar a fila de
impressão) serão gravador em <filename>/tmp</filename> (<literal>path =
/tmp</literal>) e o compartilhamento <literal>[hp-printer]</literal> será
mostrado como uma impressora (<literal>printable = yes</literal>).
</para>
<para>
Agora será necessário instalar o driver desta impressora no Windows (HP 690C) e
escolher impressora instalada via rede e seguir os demais passos de
configuração.
</para>
</section>

</section>

<section id="s-samba-a"><title>Controle de acesso ao servidor SAMBA</title>
<para>
Este capítulo documenta o controle de acesso ao servidor samba e restrições.
</para>
<section id="s-samba-a-compart"><title>Nível de acesso de usuários conectados ao SAMBA</title>
<para>
Quando acessa um compartilhamento, o usuário do samba é mapeado com o UID
respectivo de usuário do sistema ou o usuário guest (especificado pela opção
"guest account") no caso de um acesso público.  Quando isto ocorre, um processo
filho do <command>smbd</command> é executado sobre o UID e GID deste usuário.
Isto significa que em nenhuma ocasião o <command>SAMBA</command> dará mais
permissões que as necessárias para o usuário (com excessão de quando é usado o
parâmetro <literal>admin users</literal>, veja <xref
linkend="s-samba-dom-admin"/>).
</para>
</section>

<section id="s-samba-a-restrip"><title>Restringindo o acesso por IP/rede</title>
<para>
Esta restrição pode ser feita pelos parâmetros <emphasis>allow hosts</emphasis>
e <emphasis>deny hosts</emphasis> tanto em serviços individuais ou em todo o
servidor.  Os parâmetros <emphasis>hosts allow</emphasis> e <emphasis>hosts
deny</emphasis> são equivalentes a estes acima.  O <emphasis>allow
hosts</emphasis> permite o acesso a máquina especificadas como argumento.  São
permitidos os seguintes métodos para permitir o acesso a uma máquina/rede:
</para>
<itemizedlist>
<listitem>
<para>
<literal>192.168.1.1</literal> - IP da máquina
</para>
</listitem>
<listitem>
<para>
<literal>servidor</literal> - Nome da máquina
</para>
</listitem>
<listitem>
<para>
<literal>192.168.1.0/255.255.255.0</literal> - IP com máscara de rede
</para>
</listitem>
<listitem>
<para>
<literal>192.168.1.0/24</literal> - IP com máscara de rede octal
</para>
</listitem>
<listitem>
<para>
<literal>192.168.1.</literal> - Porção de rede sem o host (como no
<filename>hosts.allow</filename> e <filename>hosts.deny</filename>.
</para>
</listitem>
<listitem>
<para>
<literal>@nome</literal> - Pesquisa por máquinas no grupo NIS.
</para>
</listitem>
</itemizedlist>
<para>
É permitido usar mais de um endereço IP separando-os por vírgulas ou espaços.
A palavra chave <emphasis>EXCEPT</emphasis> pode ser usada para fazer excessão
de um ou mais endereços IPs, por exemplo:
</para>
<screen>
hosts allow = 192.168.1. EXCEPT 192.168.1.20
</screen>
<para>
Que permite o acesso a toda as máquinas da faixa de rede
<literal>192.168.1.0/24</literal> exceto para a
<literal>192.168.1.20</literal>.
</para>
<para>
O <emphasis>deny hosts</emphasis> possui a mesma sintaxe do <emphasis>allow
hosts</emphasis> mas bloqueia o acesso das máquinas especificadas como
argumento.  Quando o <emphasis>allow hosts</emphasis> e <emphasis>deny
hosts</emphasis> são usados juntos, as máquinas em <emphasis>allow
hosts</emphasis> terão prioridade (processa primeiro as diretivas em
<emphasis>allow hosts</emphasis> e depois em <emphasis>deny hosts</emphasis>).
</para>
<para>
<emphasis role="strong">OBS:</emphasis> O endereço de loopback (127.0.0.1)
nunca é bloqueado pelas diretivas de acesso.  Provavelmente deve ter notado
porque o endereço de loopback não pode ser bloqueado e as conseqüências disto
para o SAMBA.
</para>
<para>
Se você está executando o SAMBA via <emphasis>inetd</emphasis>, os arquivos
<filename>hosts.allow</filename> e <filename>hosts.deny</filename> são
verificados antes do controle e acesso <emphasis>allow hosts</emphasis> e
<emphasis>deny hosts</emphasis> para controle de acesso ao
<command>smbd</command>.  Caso estiver usando o SAMBA
via<emphasis>inetd</emphasis> e deseja restringir o acesso usando TCP Wrappers,
veja <xref linkend="rede-seg-tcpd"/>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Lembre-se de usar o
<command>testparm</command> para verificar a sintaxe do arquivo
<filename>smb.conf</filename> sempre que desconfiar de problemas (veja <xref
linkend="s-samba-s-testparm"/>).
</para>
<section id="s-samba-a-restrip-test"><title>Testando a restrição de Acesso por IP/Redes</title>
<para>
Um método interessante e útil para testar se a nossa configuração vai bloquear
o acesso a serviços é usando o <command>testparm</command> da seguinte forma:
</para>
<screen>
testparm /etc/samba/smb.conf IP/host
</screen>
<para>
Você precisará dizer para o <command>testparm</command> qual é o arquivo de
configuração que está usando e o endereço IP/nome de host que fará a
<literal>simulação</literal> de acesso.  Este método não falsifica o endereço
IP para testes, apenas usa os valores em <emphasis>allow hosts</emphasis> e
<emphasis>deny hosts</emphasis> para checagem.  Por exemplo, para verificar o
acesso vindo do IP <filename>192.168.1.50</filename>:
</para>
<screen>
testparm /etc/samba/smb.conf 192.168.1.50
Load smb config files from /etc/samba/smb.conf
Processing section "[homes]"
Processing section "[printers]"
Processing section "[tmp]"
Processing section "[cdrom]"
Loaded services file OK.
Allow connection from /etc/samba/smb.conf (focalinux) to homes
Allow connection from /etc/samba/smb.conf (focalinux) to printers
Allow connection from /etc/samba/smb.conf (focalinux) to tmp
Allow connection from /etc/samba/smb.conf (focalinux) to cdrom
</screen>
</section>

</section>

<section id="s-samba-a-restrif"><title>Restringindo o acesso por interface de rede</title>
<para>
Esta restrição de acesso permite que façamos o SAMBA responder requisições
somente para a interfaces indicadas.  O método de segurança descrito em <xref
linkend="s-samba-a-restrip"/> serão analisadas logo após esta checagem.
</para>
<para>
Para restringir o serviço SAMBA a interfaces, primeiro será necessário ativar o
parâmetro <literal>bind interfaces only</literal> usando <literal>1</literal>,
<literal>yes</literal> ou <literal>true</literal> (o padrão é desativado).
Depois, definir que interfaces serão servidas pelo samba com o parâmetro
<emphasis>interfaces</emphasis>.  Os seguintes formatos de interfaces são
permitidos:
</para>
<itemizedlist>
<listitem>
<para>
<literal>eth0, sl0, plip0, etc</literal> - Um nome de interface local.  É
permitido o uso de <literal>*</literal> para fazer o SAMBA monitorar todas as
interfaces que iniciam com aquele nome (por exemplo,
<filename>eth*</filename>).
</para>
</listitem>
<listitem>
<para>
<literal>192.168.1.1, 192.168.1.2, etc</literal> - Um endereço IP de interface
local.
</para>
</listitem>
<listitem>
<para>
<literal>192.168.1.2/24, 192.168.1.2/255.255.255.0</literal> - Um par de
endereço/máscara de rede.
</para>
</listitem>
</itemizedlist>
<para>
Mais de uma interface pode ser usada separando-as com vírgula ou espaços.  A
escolha do uso de nome da interface ou do IP é feita de acordo com a
configuração da máquina.  Em uma máquina DHCP por exemplo, é recomendado o uso
do nome da interface.  Quando <emphasis>bind interfaces only</emphasis> estiver
ativado, o padrão é esperar conexões em todas as interfaces que permitem
broadcast exceto a loopback.
</para>
<para>
Exemplo:
</para>
<screen>
bind interfaces only = 1
interfaces = loopback eth0
</screen>
<para>
Permite o recebimento de requisições de acesso ao <command>SAMBA</command>
somente da interface <filename>loopback</filename> (desnecessário, pois como
notou durante a leitura, sempre é permitida a conexão) e
<filename>eth0</filename>.
</para>
</section>

<section id="s-samba-a-restrusu"><title>Restringindo o acesso por usuários</title>
<para>
Permite que você controle quem poderá ou não acessar o compartilhamento da
máquina.  Este controle é feito pelos parâmetros <emphasis>valid
users</emphasis> e <emphasis>invalid users</emphasis>.
</para>
<para>
O <emphasis>invalid users</emphasis> lista de usuário que <emphasis
role="strong">NÃO</emphasis> terão acesso ao compartilhamento.  Se o nome for
iniciado por "+" o parâmetro será tratado como um nome de grupo UNIX
(<filename>/etc/group</filename>).  O caracter "&" faz ele pesquisar o nome de
grupo no banco de dados NIS.  O caracter "@" permite fazer a busca do grupo
primeiro no banco de dados NIS e caso ele não seja encontrado, no arquivo de
grupos do sistema (<filename>/etc/group</filename>).
</para>
<para>
É possível usar a combinação de caracteres "+&" e "&+" para alternar a ordem de
busca enter o <filename>/etc/group</filename> e o <emphasis>NIS</emphasis>.
</para>
<para>
Exemplos:
</para>
<variablelist>
<varlistentry>
<term>invalid users = junior, marcio, +badusers</term>
<listitem>
<para>
Não permite que os usuários especificados e os usuários do grupo
<literal>+badusers</literal> tenham acesso ao compartilhamento.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>invalid users = &;semacesso</term>
<listitem>
<para>
Bloqueia o acesso de todos os usuários NIS que pertençam ao grupo
<literal>semacesso</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>invalid users = bruno, henrique, +@users,</term>
<listitem>
<para>
Bloqueia o acesso dos usuários bruno, henrique e de todos os usuários que
pertençam ao grupo <literal>users</literal>.  A pesquisa de grupo é feita
primeiro no <filename>/etc/group</filename> e em seguida no NIS.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>invalid users = @semacesso</term>
<listitem>
<para>
Bloqueia o acesso dos usuários que pertencem ao grupo "semacesso".  A pesquisa
é feita primeiro no NIS e depois no <filename>/etc/group</filename>
(equivalente ao uso de "&+").
</para>
</listitem>
</varlistentry>
</variablelist>
<para>
O <emphasis>valid users</emphasis> possui a mesma sintaxe de funcionamento do
<literal>invalid users</literal>, mas permite somente o acesso para os
usuários/grupos listados.  Caso a opção <literal>valid users</literal> não seja
especificada ou a lista esteja vazia, o acesso é permitido.  Se um mesmo nome
de usuário estiver na lista <literal>valid users</literal> e <literal>invalid
users</literal>, o padrão é ser mais restritivo, negando o acesso.
</para>
<screen>
 valid users = gleydson, michelle, geo
</screen>
<para>
A segurança deste método de acesso depende muito da forma de autenticação dos
nomes antes de passar o controle para o SAMBA, pois uma autenticação fraca põe
em risco a segurança da sua máquina.
</para>
</section>

<section id="s-samba-a-hostsequiv"><title>Evite o uso do parâmetro <emphasis>hosts equiv</emphasis>!</title>
<para>
Este parâmetro permite que máquinas tenham acesso sem senha a um servidor.
Isto pode se tornar um *ENORME* buraco na segurança do seu sistema, pois mesmo
usando uma senha inválida, a máquina poderá ter acesso a todos os recursos do
compartilhamento e não é complicado fazer um ataque usando DNS spoofing.
</para>
<para>
Se realmente deseja fazer isto, tenha em mente os dados que poderão ser
acessados daquela máquina, se realmente não existe nenhuma outra forma de
disponibilizar o acesso de forma que mantenha o controle de restrições (usando
todos os outros métodos), restrinja o acesso usando MAC Address com o
<command>iptables</command> ou o <command>arp</command> (veja <xref
linkend="d-restr-ipmac"/>).  O padrão é não usar nenhum arquivo
<filename>hosts.equiv</filename>.
</para>
</section>

<section id="s-asmba-a-nullpasswd"><title>Evite o uso de senhas em branco!</title>
<para>
O parâmetro <literal>null passwords</literal> é usado na seção
<emphasis>[global]</emphasis> permitindo que contas de usuários sem senha
tenham acesso permitido ao servidor.  <emphasis role="strong">ISTO É TOTALMENTE
INSEGURO</emphasis> e deve ser sempre evitado.  Caso você tenha feito uma bela
restrição em sua máquina e deseja que o seu shell script de cópia de arquivos
funcione usando este método, você está jogando toda a segurança do seu sistema
por ralo abaixo.
</para>
<para>
Não existe motivo para usar senhas em branco em um controle de acesso por
usuário, a não ser que precise testar algo realmente temporário e que depurando
algo no SAMBA.
</para>
</section>

<section id="s-samba-a-publico"><title>Criando um compartilhamento para acesso sem senha</title>
<para>
Em algumas situações (mesmo em instalações seguras) é preciso tornar um
compartilhamento acessível publicamente, exemplos disto incluem um diretório
que contém drivers de impressoras, arquivos comuns, um diretório temporário,
etc.
</para>
<para>
Para configurar um acesso público utilizamos a opção <literal>public =
yes</literal> ou <literal>guest ok = yes</literal> (que é um sinônimo para o
último comando).  O UID utilizado no acesso público é especificado pelo
parâmetro <literal>guest account</literal>, portanto ele deverá ser um usuário
válido do sistema.  Caso você queira somente definir acesso guest a um
compartilhamento, especifique a opção <literal>guest only</literal> para o
serviço, desta forma, mesmo que o usuário tenha acesso, ele será mapeado para o
usuário guest.
</para>
<para>
Uma boa medida de segurança é usar o usuário <literal>nobody</literal> pois a
maioria das distribuições de <command>Linux</command> seguras adotam-o como
padrão como usuário que não é dono de quaisquer arquivos/diretórios no sistema,
não possui login, senha ou sequer um diretório home.
</para>
<para>
Veja um exemplo disponibilizando o compartilhamento
<literal>[download]</literal> para acesso público com acesso a gravação:
</para>
<screen>
[global] 
guest account = nobody
..
..

[download]
 path = /downloads
 comment = Espaço público para abrigar downloads de Usuários
 guest ok = yes (aqui poderá ser também "public = yes").
 writable = yes
 follow symlinks = false
</screen>
<para>
O parâmetro <literal>guest account</literal> também poderá ser especificado no
compartilhamento, isto é útil quando não quiser que o usuário que acesse o
compartilhamento não seja o mesmo usado na diretiva [global].
</para>
<para>
Caso seu servidor somente disponibiliza compartilhamentos para acesso público,
é mais recomendado utilizar o nível <literal>security = share</literal> pra
diminuir a carga máquina, pois o usuário <emphasis>guest</emphasis> será o
primeiro a ser checado pelas regras de acesso (ao contrário do nível
<emphasis>user</emphasis>, onde o acesso guest é o último checado).
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Lembre-se que o compartilhamento
funciona de modo recursivo, ou seja, todos os arquivos e subdiretórios dentro
do diretório que compartilhou serão disponibilizados, portanto tenha certeza da
importância dos dados que existem no diretório, verifique se existem links
simbólicos que apontam para ele, etc.  Recomendo dar uma olhada rápida em <xref
linkend="s-samba-a-public-access"/>.
</para>
</section>

<section id="s-samba-a-ro"><title>Criando um compartilhamento com acesso somente leitura</title>
<para>
Esta proteção é útil quando não desejamos que pessoas alterem o conteúdo de um
compartilhamento.  Isto pode ser feito de duas formas: negando o acesso de
gravação para todo o compartilhamento ou permitindo leitura somente para
algumas pessoas.  O parâmetro usado para fazer a restrição de acesso somente
leitura é o <literal>read only = yes</literal> ou seu antônimo
<literal>writable = no</literal>.  Abaixo seguem os dois exemplos comentados:
</para>
<screen>
[teste]
 comment = Acesso a leitura para todos
 path = /tmp
 read only = yes
 public = yes
</screen>
<para>
No exemplo acima, o diretório <filename>/tmp</filename> (<emphasis>path =
/tmp</emphasis>) foi compartilhado com o nome <literal>teste</literal>
(<emphasis>[teste]</emphasis>), de forma pública (acesso sem senha -
<emphasis>public = yes</emphasis>), e todos podem apenas ler seu conteúdo
<emphasis>read only = yes</emphasis>).
</para>
<screen>
[teste]
 comment = Acesso a gravação para todos com excessões
 path = /tmp
 read only = no
 read list = @users, gleydson
 invalid users = root
</screen>
<para>
Neste, o mesmo compartilhamento <literal>teste</literal>
(<emphasis>[teste]</emphasis>) foi definido como acesso leitura/gravação para
todos (<emphasis>read only = no</emphasis>), mas os usuários do grupo
<emphasis>@users</emphasis> e o usuário <emphasis>gleydson</emphasis> terão
sempre acesso leitura (<emphasis>read list = @users, gleydson</emphasis>).
Adicionalmente foi colocada uma proteção para que o superusuário não tenha
acesso a ele (<emphasis>invalid users = root</emphasis>).  Esta forma de
restrição é explicada melhor em <xref linkend="s-samba-a-restr"/>).
</para>
</section>

<section id="s-samba-a-rw"><title>Criando um compartilhamento com acesso leitura/gravação</title>
<para>
Esta forma de compartilhamento permite a alteração do conteúdo do
compartilhamento dos usuários que possuem as permissões de acesso apropriadas.
Este controle pode ser feito de duas formas: Acesso total de gravação para os
usuários e acesso de gravação apenas para determinados usuários.  Este controle
é feito pela opção <literal>read only = no</literal> e seu antônimo equivalente
<literal>writable = yes</literal>.  Abaixo dois exemplos:
</para>
<screen>
[teste]
 comment = Acesso de gravação para todos.
 path = /tmp
 writable = yes
 public = yes
</screen>
<para>
No exemplo acima, o diretório <filename>/tmp</filename> (path = /tmp) foi
compartilhado com o nome <literal>teste</literal> ([teste]), de forma pública
(acesso sem senha - public = yes) e todos podem ler/gravar dentro dele
(writable = yes).
</para>
<screen>
[teste]
 comment = Acesso a leitura para todos com excessões
 path = /tmp
 writable = no
 write list = @users, gleydson
</screen>
<para>
Neste, o mesmo compartilhamento <literal>teste</literal>
(<emphasis>[teste]</emphasis>) foi definido como acesso de leitura para todos
(<emphasis>writable = no</emphasis>), mas os usuários do grupo
<emphasis>@users</emphasis> e o usuário <emphasis>gleydson</emphasis> serão os
únicos que terão também acesso a gravação (<emphasis>write list = @users,
gleydson</emphasis>).  Esta forma de restrição é explicada melhor em <xref
linkend="s-samba-a-restr"/>).
</para>
</section>

<section id="s-samba-a-restr"><title>Excessão de acesso na permissão padrão de compartilhamento</title>
<para>
É possível alterar o nível de acesso para determinados usuários/grupos em um
compartilhamento, para entender melhor: Caso tenha criado um compartilhamento
somente leitura e queira permitir que apenas alguns usuários ou grupos tenham
acesso a gravação, isto é possível e será explicado nesta seção.  Este
comportamento é controlado por duas opções: <literal>read list</literal> e
<literal>write list</literal>.  Veja alguns exemplos:
</para>
<screen>
[temporario] 
 comment = Diretório temporário
 path = /tmp
 writable = yes
 read list = gleydson, root
 browseable = no
 available = yes
</screen>
<para>
Neste exemplo, disponibilizamos o diretório <filename>/tmp</filename>
(<emphasis>path = /tmp</emphasis>) como compartilhamento de nome
<literal>temporario</literal> (<emphasis>[temporario]</emphasis>), seu acesso
padrão é leitura/gravação para todos (<emphasis>writable = yes</emphasis>),
exceto para os usuários <literal>root</literal> e <literal>gleydson</literal>
(<emphasis>read list = root, gleydson</emphasis>).  Em adição, tornamos o
compartilhamento <emphasis>invisível</emphasis> (veja <xref
linkend="s-samba-a-invisivel"/>) no "Ambiente de Rede" do Windows
(<emphasis>browseable = no</emphasis>) e ele será lido e disponibilizado pelo
SAMBA (<emphasis>available = yes</emphasis>).
</para>
<screen>
[temporario] 
 comment = Diretório temporário
 path = /tmp
 writable = no
 write list = gleydson, @operadores
 browseable = yes
</screen>
<para>
Neste exemplo, disponibilizamos o diretório <filename>/tmp</filename>
(<emphasis>path = /tmp</emphasis>) como compartilhamento de nome
<literal>temporario</literal> (<emphasis>[temporario]</emphasis>), seu acesso
padrão é apenas leitura para todos (<emphasis>writable = no</emphasis>), exceto
para o usuário <literal>gleydson</literal> e usuários do grupo Unix
<literal>operadores</literal>, que tem acesso a leitura/gravação
(<emphasis>write list = gleydson, @operadores</emphasis>).  Tornamos o
compartilhamento <emphasis>visível</emphasis> no "Ambiente de Rede" do Windows
(<emphasis>browseable = yes</emphasis> - que é o padrão).
</para>
</section>

<section id="s-samba-a-ipc-admin"><title>Restringindo o IPC$ e ADMIN$</title>
<para>
É seguro restringir os serviços <filename>IPC$</filename> e
<filename>ADMIN$</filename> para acesso somente pelas faixas de rede de
confiança.  Isto pode ser feito através da mesma forma que a restrição em
outros compartilhamentos.  Os efeitos desta restrição serão que somente as
redes autorizadas possam obter a lista de máquinas, se autenticar no domínio e
realizar tarefas administrativas gerais:
</para>
<screen>
[IPC$]
read only = yes
allow from 192.168.1.0/24

[ADMIN$]
read only = yes
allow from 192.168.1.0/24
</screen>
<para>
O exemplo acima permite que os serviços <literal>IPC$</literal> e
<literal>ADMIN$</literal> sejam acessados de qualquer máquina na faixa de rede
<literal>192.168.1.0/24</literal>.  Para forçar a autenticação para acesso a
estes serviços:
</para>
<screen>
[IPC$]
invalid users = nobody
valid users = gleydson michelle
read only = yes
allow from 192.168.1.0/24

[ADMIN$]
invalid users = nobody
valid users = gleydson michelle
read only = yes
allow from 192.168.1.0/24
</screen>
<para>
Os exemplos acima são similares ao de antes, mas o acesso a listagem dos
compartilhamentos é restringida (<emphasis>invalid users = nobody</emphasis>),
pois o usuário <emphasis>nobody</emphasis> (usado para mostrar o
compartilhamento) tem o acesso negado.  Somente os usuários
<literal>gleydson</literal> e <literal>michelle</literal> (<emphasis>valid
users = gleydson michelle</emphasis>) podem listar seu conteúdo.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Mesmo que estejam restritos, os
serviços <literal>IPC$</literal> e <literal>ADMIN$</literal> sempre poderão ser
acessados de 127.0.0.1, ou teríamos problemas com o funcionamento do SAMBA.
Assim não é necessário colocar 127.0.0.1 na lista de IPs autorizados.
</para>
</section>

<section id="s-samba-a-invisivel"><title>Criando um compartilhamento invisível</title>
<para>
Para não exibir um compartilhamento da lista de compartilhamentos das máquinas,
utilize o parâmetro <literal>browseable = no</literal>.  Por exemplo:
</para>
<screen>
[teste]
 path = /tmp
 comment = Diretório temporário
 read only = yes
 browseable = no
</screen>
<para>
Neste exemplo, o diretório <filename>/tmp</filename> (<emphasis>path =
/tmp</emphasis>) foi compartilhado através de <literal>teste</literal>
(<emphasis>[teste]</emphasis>) com acesso somente leitura (<emphasis>read only
= yes</emphasis>) e ele não será mostrado na listagem de compartilhamentos do
ambiente de rede do Windows (<emphasis>browseable = no</emphasis>).
</para>
<para>
Note que o compartilhamento continua disponível, porém ele poderá ser acessado
da estação Windows, especificando a \\maquina\compartilhamento.  Para acessar o
compartilhamento do exemplo acima:
</para>
<screen>
# Clique em Iniciar/Executar e digite:
\\nome_do_servidor_samba\teste
</screen>
<para>
Ao contrário das máquinas <command>Windows</command> onde é necessário
adicionar um "$" do nome de compartilhamento para criar um compartilhamento
oculto (como <literal>teste$</literal>) o SAMBA cria um compartilhamento
<emphasis role="strong">realmente</emphasis> oculto, não aparecendo mesmo na
listagem do <command>smbclient</command>.
</para>
</section>

<section id="s-samba-a-comandos"><title>Executando comandos antes e após o acesso ao compartilhamento</title>
<para>
Este recurso oferece uma infinidade de soluções que podem resolver desde
problemas de praticidade até segurança usando as opções
<literal>preexec</literal> e <literal>postexec</literal>.  Por exemplo, imagine
que esteja compartilhando 4 unidades de CD-Rom de um servidor na rede, e deseje
que estes CDs estejam sempre disponíveis mesmo que algum operador engraçadinho
tenha ejetado as gavetas de propósito, podemos fazer a seguinte configuração:
</para>
<screen>
[cdrom]
 path = /cdrom
 comment = Unidade de CD-ROM 1
 read only = yes
 preexec = /bin/mount /cdrom
 preexec close = yes
 postexec = /bin/umount /cdrom
</screen>
<para>
Na configuração acima, o CD-ROM será compartilhado como
<literal>cdrom</literal> (<emphasis>[cdrom]</emphasis>), somente leitura
(<emphasis>red only = yes</emphasis>), quando o usuário acessar o
compartilhamento ele "fechará" a gaveta do CD (<emphasis>preexec = /bin/mount
/cdrom</emphasis>) e desmontará o drive de CD assim que o compartilhamento for
fechado (<emphasis>postexec = /bin/umount /cdrom</emphasis>).  Adicionalmente,
caso o comando <command>mount</command> da opção <literal>preexec</literal>
tenha retornado um valor diferente de 0, a conexão do compartilhamento é
fechada (<emphasis>preexec close = yes</emphasis>).
</para>
<para>
A UID do processo do <literal>preexec</literal> e <literal>postexec</literal>
será o mesmo do usuário que está acessando o compartilhamento, por este motivo
ele deverá ter permissões para montar/desmontar o CD-ROM no sistema.  Caso
precise executar comandos como usuário <literal>root</literal>, utilize a
variante <literal>root preexec</literal> e <literal>root postexec</literal>.
Apenas tenha consciência que os programas sendo executados são seguros o
bastante para não comprometer o seu sistema.
</para>
<para>
Usando a mesma técnica, é possível que o sistema lhe envie e-mails alertando
sobre acesso a compartilhamentos que em conjunto com um debug level 2 e logs
configurados independentes por máquina, você possa ver o que a máquina tentou
acessar (e foi negado) e o que ela conseguiu acesso.
</para>
<para>
Como bom administrador, você poderá criar scripts que façam uma checagem de
segurança no compartilhamento e encerre automaticamente a conexão caso seja
necessário, montar um "honney pot" para trojans, etc.
</para>
<para>
Como deve estar notando, as possibilidades do SAMBA se extendem além do simples
compartilhamento de arquivos, se integrando com o potencial dos recursos do
sistema UNIX.
</para>
</section>

<section id="s-samba-a-public-access"><title>Considerações de segurança com o uso do parâmetro "public = yes"</title>
<para>
Este parâmetro permite que você acesso um compartilhamento sem fornecer uma
senha, ou seja, que o usuário não esteja autenticado.  NÃO utilize o parâmetro
"public = yes" (ou um de seus sinônimos) no compartilhamento
<literal>[homes]</literal>, pois abrirá brechas para que possa acessar o
diretório home de qualquer usuário e com acesso a gravação (que é o padrão
adotado pelos administradores para permitir o acesso ao seu diretório home
remoto).
</para>
<para>
Recomendo utilizar o parâmetro <literal>public = yes</literal> somente em
compartilhamentos onde é realmente necessário, como o [netlogon] ou outras
áreas de acesso público onde as permissões do sistema de arquivos local estejam
devidamente restritas.  Outra medida é não utilizar a opção <literal>follow
symlinks</literal>, que poderá lhe causar problemas com usuários mal
intencionados que tenham acesso shell.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Tenha em mente todas as considerações
de segurança abordadas neste capítulo, bem como as permissões de acesso ao
sistema Unix e como elas funcionam.  A disponibilidade de arquivos em uma rede
é simples, simples também pode ser o acesso indevido a eles caso não saiba o
que está fazendo.
</para>
</section>

<section id="s-samba-a-passwords"><title>Senhas criptografadas ou em texto puro?</title>
<para>
Como regra geral, prefira sempre utilizar senhas criptografadas.  Aqui alguns
motivos:
</para>
<itemizedlist>
<listitem>
<para>
A senha é enviada de uma forma que dificulta sua captura por pessoas
maliciosas.
</para>
</listitem>
<listitem>
<para>
O NT não permite que você navegue no ambiente de rede em um sistema SAMBA com
nível de acesso por usuário autenticando usando senhas em texto plano.
</para>
</listitem>
<listitem>
<para>
Será solicitada sempre a senha para reconexão em cada compartilhamento da
máquina.
</para>
</listitem>
<listitem>
<para>
Todas as versões de Windows NT 4 a partir SP3 e Windows 95 OSR/2 utilizam
senhas criptografadas como padrão.  É possível faze-lo utilizar senhas em texto
plano modificando chaves no registro das máquinas clientes (veja <xref
linkend="s-samba-senhas-plano"/> para detalhes).
</para>
</listitem>
</itemizedlist>
<para>
As vantagens da utilização da autenticação usando texto plano:
</para>
<itemizedlist>
<listitem>
<para>
A senha utilizada será a mesma do <filename>/etc/passwd</filename> (servindo
para ftp, login, etc)
</para>
</listitem>
<listitem>
<para>
O servidor PDC pode ser usado para logon desde que os clientes estejam usando
senhas em texto plano.
</para>
</listitem>
<listitem>
<para>
Elas não são armazenadas no disco da estação cliente.
</para>
</listitem>
<listitem>
<para>
Você não será perguntado por uma senha durante cada reconexão de recurso.
</para>
</listitem>
</itemizedlist>
<para>
Antes de optar por utilizar um sistema de senhas em texto plano, leve em
consideração estes pontos.  Se você já utiliza telnet ou ftp, provavelmente a
utilização de autenticação usando texto plano no SAMBA não trará problemas mais
graves para você.
</para>
<para>
<emphasis role="strong">OBS</emphasis>: Caso seu NT ou versão derivada não
navegue no ambiente de rede (só aceitando conexões especificando diretamente o
"\\servidor\compartilhamento") modifique sua configuração do SAMBA para
autenticar usando senhas criptografadas (veja <xref
linkend="s-samba-senhas-crypto"/>) para detalhes de como fazer isto.
</para>
</section>

<section id="s-samba-a-usernamemap"><title>Mapeamento de nomes de usuários</title>
<para>
Este recurso faz a mapeamento (tradução) de nomes de usuários usados no momento
do acesso para contas de acesso locais, bastante útil quando o nome de usuário
enviado pela máquina não confere com NENHUMA conta local do sistema (um exemplo
é quando o login do usuário no <command>Windows</command> é diferente de seu
Login no <command>Linux</command>).  Outro vantagem de seu uso é permitir que
uma categoria de usuários utilizem um mesmo nível de acesso no sistema.
</para>
<para>
Seu formato é o seguinte: <literal>username map = arquivo</literal>.
</para>
<para>
As seguintes regras são usadas para construir o arquivo de mapeamento de nomes:
</para>
<itemizedlist>
<listitem>
<para>
Um arquivo de múltiplas linhas onde o sinal de "=" separa os dois parâmetros
principais.  O arquivo é processado linha por linha da forma tradicional, a
diferença é o que o processamento do arquivo continua mesmo que uma condição
confira.  Para que o processamento do resto do arquivo seja interrompido quando
um mapeamento confira, coloque o sinal "!"  na frente do nome local.
</para>
</listitem>
<listitem>
<para>
O parâmetro da esquerda é a conta Unix local que será usada para fazer acesso
ao compartilhamento.  Somente uma conta Unix poderá ser utilizada.
</para>
</listitem>
<listitem>
<para>
O parâmetro da direita do sinal de "=" pode conter um ou mais nomes de usuários
separados por espaços que serão mapeados para a conta Unix local.
</para>
<para>
O parâmetro "@grupo" permite que usuários pertencentes ao grupo Unix local
sejam mapeados para a conta de usuário do lado esquerdo.  Outro caracter
especial é o "*" e indica que qualquer usuário será mapeado.
</para>
</listitem>
</itemizedlist>
<para>
Você pode utilizar comentários na mesma forma que no arquivo de configuração
<filename>smb.conf</filename>.  Alguns exemplos:
</para>
<screen>
# Mapeia o usuário "gleydson mazioli" com o usuário local gleydson
gleydson = gleydson mazioli

# Mapeia o usuário root e adm para o usuário nobody
nobody = root adm

# Mapeia qualquer nome de usuário que pertença ao grupo smb-users para o usuário
# samba. 
samba = @smb-users

# Utiliza todos os exemplos anteriores, se nenhum usuário conferir, ele será 
# mapeado para o usuário nobody (como o usuário root e adm já são mapeados
# para "nobody", este exemplo terá o mesmo efeito).
!gleydson = gleydson mazioli
!samba = @smb-users
nobody = *
</screen>
</section>

</section>

<section id="s-samba-perf"><title>Melhorando a performance do compartilhamento/servidor</title>
<para>
Esta seção trará algumas formas de otimização do servidor SAMBA que fazem
diferença quando os valores adequados são utilizados: A primeira é a ativação
de um cache de gravação/leitura de arquivos.  Este cache é feito pela opção
<literal>write cache size</literal> e funciona fazendo o cache dos arquivos que
serão lidos/gravados.  Ele é esvaziado assim que o arquivo for fechado ou
quando estiver cheio.  O valor especificado nesta opção é em bytes e o padrão é
"0" para não causar impacto em sistemas com pouca memória (ou centenas de
compartilhamentos).  Exemplo:
</para>
<screen>
[publico]
 path = /pub
 comment = Diretório de acesso público
 read only = yes
 public = yes
 write cache size = 384000
</screen>
<para>
Compartilha o diretório <filename>/pub</filename> (<emphasis>path =
/pub</emphasis>) como compartilhamento de nome <literal>publico</literal>
(<emphasis>[publico]</emphasis>), seu acesso será feito como somente leitura
(<emphasis>read only = yes</emphasis>) e o tamanho do cache de leitura/gravação
reservado de 384Kb (<emphasis>write cache size = 384000</emphasis>).
</para>
<para>
Deixar a opção para seguir links simbólicos ativada (<literal>follow
symlinks</literal>) garante mais performance de acesso a arquivos no
compartilhamento.  A desativação da opção <literal>wide links</literal> em
conjunto com o uso de cache nas chamadas getwd (<literal>getwd cache</literal>)
permite aumentar a segurança e tem um impacto perceptível na performance dos
dados.
</para>
<para>
A desativação da opção global <emphasis>nt smb support</emphasis> também
melhora a performance de acesso dos compartilhamentos.  Esta é uma opção útil
para detectar problemas de negociação de protocolo e por padrão, ela é ativada.
</para>
<para>
Caso utiliza um valor de depuração de log muito alto (<emphasis>debug
level</emphasis>), o sistema ficará mais lento pois o servidor sincroniza o
arquivo após cada operação.  Em uso excessivo do servidor de arquivos, isso
apresenta uma degradação perceptível de performance.
</para>
<para>
A opção <literal>prediction</literal> permite que o SAMBA faça uma leitura
adiante no arquivo abertos como somente-leitura enquanto aguarda por próximos
comandos.  Esta opção associada com bons valores de <emphasis>write cache
size</emphasis> pode fazer alguma diferença.  Note que o valor de leitura nunca
ultrapassa o valor de "read size".
</para>
<para>
A opção <emphasis>read size</emphasis> permite obter um sincronismo fino entre
a leitura e gravação do disco com o envio/recebimento de dados da rede.  O
valor é dependente da instalação local, levando em consideração a velocidade de
disco rígido, rede, etc.  O valor padrão é 16384.
</para>
<para>
Em casos onde um NFS montado ou até mesmo leitura em discos locais é
compartilhada, o parâmetro <emphasis>strict locking</emphasis> definido para
<literal>yes</literal> pode fazer alguma diferença de performance.  Note que
nem todos os sistemas ganham performance com o uso desta opção e não deve ser
usada em aplicativos que não requisitam o estado do lock de arquivo ao
servidor.
</para>
<para>
Caso você possua aplicativos que fazem o lock corretamente de arquivos, você
poderá usar o <emphasis>share modes = no</emphasis>, isto significa que futuras
aberturas de arquivo podem ser feitas em em modo leitura/gravação.  Caso
utiliza um aplicativo muito bem programado que implementa de forma eficiente de
lock, você poderá desativar esta opção.
</para>
<para>
O uso de <emphasis>oplocks yes</emphasis> em compartilhamentos aumenta a
performance de acesso a arquivos em até 30%, pois utiliza um código de cache no
cliente.  Tenha certeza do que está fazendo antes de sair usando
<emphasis>oplocks</emphasis> em tudo que é lugar.  A desativação de
<emphasis>kernel oplocks</emphasis> é necessária para que isto funcione.
</para>
<para>
A opção <emphasis>read raw</emphasis> e <emphasis>write raw</emphasis> devem
ter seus valores experimentados para ver se faz diferença na performance da sua
rede, pois é diretamente dependente do tipo de cliente que sua rede possui.
Alguns clientes podem ficar mais lentos em modo de leitura raw.
</para>
<para>
O tipo de sistema de arquivos adotado na máquina e suas opções de montagem tem
um impacto direto na performance do servidor, principalmente com relação a
atualização de status dos arquivos no sistema de arquivos (hora de acesso,
data, etc).
</para>
<para>
O cache de leitura adiante de abertura de arquivos em modo somente leitura
aumenta a performance com o uso do oplocks nível 2.  Para isto, ajuste a opção
<literal>level2 oplocks</literal> para <literal>yes</literal>.  A recomendação
deste tipo de oplock é o mesmo do nível 1.
</para>
<para>
Como o SAMBA faz o transporte NetBEUI via TCP/IP, ajustes no socket fazem
diferença nos dados que trafegam na rede.  Como isso é dependente de rede você
precisará usar técnicas de leitura/gravação para determinar quais são as
melhores que se encaixam em seu caso.  A opção <emphasis>socket
options</emphasis> é usada para fazer tais ajustes, por exemplo:
</para>
<screen>
socket options = SO_SNDBUF=2048 IPTOS_THROUGHPUT=1
</screen>
<para>
Em especial, a opção <literal>TCP_NODELAY</literal> apresenta uma perceptível
melhoria de performance no acesso a arquivos locais.
</para>
<para>
<emphasis role="strong">OBS:</emphasis>: Não use espaços entre o sinal de "="
quando especificar as opções do parâmetro <literal>socket options</literal>.
</para>
</section>

<section id="s-samba-c"><title>Configuração de Clientes NetBEUI</title>
<para>
Este capítulo documenta a configuração de máquinas clientes NetBEUI,
requerimentos de cada configuração e documenta os passos necessários para ter o
cliente se comunicando perfeitamente com o seu servidor.  Serão explicadas
tanto a configuração de <emphasis>grupo de trabalho</emphasis> como de
<emphasis>domínio</emphasis> e como a configuração é compatível entre
<command>Linux</command> e <command>Windows</command>, estas explicações são
perfeitamente válidas para configurar clientes que acessem servidores
<command>Windows</command>.
</para>
<section id="s-samba-c-wfw-lman"><title>Considerações sobre o Windows for Workgroups e LanManager</title>
<para>
Sistemas com implementações NetBIOS mais antigos, como o <command>Windows for
Workgroups</command> (Windows 3.11) e o <command>Lan Manager</command> (DOS),
enviam somente a senha para acesso ao compartilhamento, desta forma, para o
acesso ser autorizado pelo <command>samba</command>, você deverá especificar a
diretiva <emphasis>user = usuario</emphasis> para que a senha confira com o
usuário local do sistema.  A senha enviada também é em formato texto plano.
Este problema não ocorre no Windows 95 e superiores, que enviam o nome de
usuário que efetuou o logon junto com a respectiva senha.
</para>
<para>
Se a segurança do seu samba depende de senhas criptografadas, será necessário
utilizar a diretiva <literal>"include =
outro_arquivo_de_configuração.%m</literal> para definir configurações
específicas de acesso para estas máquinas.
</para>
<para>
Outro detalhe que deve ser lembrado é que o <command>Windows for
Workgroups</command> envia sempre a senha em MAIÚSCULAS, então é preciso
configurar o SAMBA para tentar combinações de maiúsculas/minúsculas usando o
parâmetro <emphasis>mangle case</emphasis> e <emphasis>default case</emphasis>
na seção global do <filename>smb.conf</filename>.
</para>
</section>

<section id="s-samba-c-workgroup"><title>Configurando clientes em Grupo de Trabalho</title>
<para>
Para configurar o cliente para fazer parte de um <emphasis>grupo de
trabalho</emphasis>, é necessário apenas que tenha em mãos o <literal>nome do
grupo de trabalho</literal> (workgroup) que os clientes farão parte e o nome de
uma outra máquina que faz parte do mesmo grupo (para testes iniciais).  Com
estes dados em mãos, selecione na lista abaixo o nome do cliente que deseja
configurar para incluir no grupo de trabalho:
</para>
<itemizedlist>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-w9x"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-wXPHome"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-wXPprofessional"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-wXPServer"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-NTWorkstation"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-NTServer"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-w2kProfessional"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-w2kServer"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-linux"/>
</para>
</listitem>
</itemizedlist>
<section id="s-samba-c-workgroup-w9x"><title>Windows 9X</title>
<para>
Estas configurações são válidas para clientes Windows 95, Windows 95OSR/2,
Windows 98.  Caso utilize o <command>Windows 95</command> (qualquer uma das
séries) é aconselhável atualizar a stack TCP/IP e NetBEUI para corrigir alguns
problemas que podem deixar sua máquina vulnerável na versão que acompanha o
WinSock do Windows 95.
</para>
<para>
Para tornar uma máquina parte do grupo de trabalho, siga os seguintes passos:
</para>
<itemizedlist>
<listitem>
<para>
Entre nas propriedades de rede no Painel de Controle
</para>
</listitem>
<listitem>
<para>
Instale o Cliente para redes Microsoft (caso não esteja instalado).
</para>
</listitem>
<listitem>
<para>
Instale o Protocolo TCP/IP.  Você também pode instalar o protocolo NetBIOS, mas
utilizaremos o suporte NetBIOS sobre TCP/IP que é o usado pelo
<command>SAMBA</command> além de ter um melhor desempenho, permitir integração
com servidores WINS, etc.
</para>
</listitem>
<listitem>
<para>
Clique em "Protocolo TCP/IP" e em Propriedades.  Clique na tab "NetBIOS" e
marque a opção "Desejo ativar o NetBIOS através do TCP/IP".  Caso esta caixa
esteja em cinza, então está tudo certo também.
</para>
</listitem>
<listitem>
<para>
Clique na tab "Identificação" e coloque lá o nome que identificará o computador
(até 15 caracteres) e o nome do grupo de trabalho que ele fará parte(por
exemplo "workgroup", "suporte", etc) .  No campo "Descrição do Computador",
coloque algo que identifique a máquina na rede (por exemplo, "Computador da
área de suporte").
</para>
</listitem>
<listitem>
<para>
Clique na tab "Controle de Acesso" e marque o "Controle de acesso a nível de
compartilhamento" (a não ser que tenha configurado um servidor que mantenha um
controle de nível de usuário na rede para as máquinas fora do domínio).
</para>
</listitem>
<listitem>
<para>
Clique em OK até reiniciar o computador.
</para>
</listitem>
</itemizedlist>
<para>
A máquina cliente agora faz parte do grupo de trabalho!  Tente acessar um outro
computador da rede e navegar através do ambiente de rede.  Caso a lista de
máquinas demore em aparecer, tente acessar diretamente pelo nome do computador,
usando o seguinte formato: "\\computador"
</para>
</section>

<section id="s-samba-c-workgroup-wXPHome"><title>Windows XP Home Edition</title>
<para>
Siga as instruções de <xref linkend="s-samba-c-workgroup-wXPprofessional"/>.
</para>
</section>

<section id="s-samba-c-workgroup-wXPprofessional"><title>Windows XP Professional Edition</title>
<itemizedlist>
<listitem>
<para>
Logue como administrador do sistemas local.
</para>
</listitem>
<listitem>
<para>
Entre no item <emphasis>Sistema</emphasis> dentro do painel de controle.  A
tela propriedades de sistema será aberta.
</para>
</listitem>
<listitem>
<para>
No campo <emphasis>Descrição do Computador</emphasis>, coloque algo que
descreva a máquina (opcional).
</para>
</listitem>
<listitem>
<para>
Clique na TAB <emphasis>Nome do Computador</emphasis> e no botão
<emphasis>Alterar</emphasis> na parte de baixo da janela.
</para>
</listitem>
<listitem>
<para>
No campo <emphasis>nome do computador</emphasis>, coloque um nome de no máximo
15 caracteres para identificar a máquina na rede.
</para>
</listitem>
<listitem>
<para>
Clique em <emphasis>grupo de trabalho</emphasis> e digite o nome do
<emphasis>grupo de trabalho</emphasis> na caixa de diálogo.
</para>
</listitem>
<listitem>
<para>
Clique em OK e aguarde a mensagem confirmando sua entrada no grupo de trabalho.
Será necessário reiniciar a máquina.
</para>
</listitem>
</itemizedlist>
</section>

<section id="s-samba-c-workgroup-wXPServer"><title>Windows XP Server Edition</title>
<para>
Siga as instruções de <xref linkend="s-samba-c-workgroup-wXPprofessional"/>.
</para>
</section>

<section id="s-samba-c-workgroup-NTWorkstation"><title>Windows NT WorkStation</title>
<para>
Veja <xref linkend="s-samba-c-dominio-NTServer"/>.
</para>
</section>

<section id="s-samba-c-workgroup-NTServer"><title>Windows NT Server</title>
<itemizedlist>
<listitem>
<para>
Clique no item <literal>Rede</literal> do painel de controle.
</para>
</listitem>
<listitem>
<para>
Na tab <literal>Serviços</literal>, confira se os serviços <literal>Estação de
trabalho</literal>, <literal>Interface de NetBIOS</literal> e <literal>Serviços
TCP/IP simples</literal> estão instalados.  Caso não estejam, faça sua
instalação usando o botão <literal>Adicionar</literal> nesta mesma janela.
</para>
</listitem>
<listitem>
<para>
Na tab <literal>Protocolos</literal>, verifique se os protocolos
<emphasis>NetBEUI</emphasis> e <emphasis>TCP/IP</emphasis> estão instalados.
Caso não estejam, faça sua instalação clicando no botão
<literal>Adicionar</literal> nesta mesma janela.
</para>
</listitem>
<listitem>
<para>
Na tab identificação, clique no botão <literal>Alterar</literal>
</para>
</listitem>
<listitem>
<para>
Na janela que se abrirá, coloque o nome do computador no campo <literal>Nome do
Computador</literal>
</para>
</listitem>
<listitem>
<para>
Clique em <literal>Grupo de trabalho</literal> e escreva o nome do grupo de
trabalho em frente.
</para>
</listitem>
<listitem>
<para>
Clique em <literal>OK</literal> até voltar.
</para>
</listitem>
<listitem>
<para>
Pronto, seu computador agora faz parte do grupo de trabalho.
</para>
</listitem>
</itemizedlist>
</section>

<section id="s-samba-c-workgroup-w2kProfessional"><title>Windows 2000 Professional</title>
<itemizedlist>
<listitem>
<para>
Logue como administrador do sistemas local.
</para>
</listitem>
<listitem>
<para>
Entre no item <emphasis>Sistema</emphasis> dentro do painel de controle.  A
tela propriedades de sistema será aberta.  Clique em "Computador" e então no
botão "Propriedades".
</para>
</listitem>
<listitem>
<para>
No campo <emphasis>nome do computador</emphasis>, coloque um nome de no máximo
15 caracteres para identificar a máquina na rede.
</para>
</listitem>
<listitem>
<para>
Clique em <emphasis>grupo de trabalho</emphasis> e digite o nome do
<emphasis>grupo de trabalho</emphasis> na caixa de diálogo.
</para>
</listitem>
<listitem>
<para>
Clique em OK e aguarde a mensagem confirmando sua entrada no grupo de trabalho.
Será necessário reiniciar a máquina.
</para>
</listitem>
</itemizedlist>
</section>

<section id="s-samba-c-workgroup-w2kServer"><title>Windows 2000 Server</title>
<itemizedlist>
<listitem>
<para>
Logue como administrador do sistemas local.
</para>
</listitem>
<listitem>
<para>
Entre no item <emphasis>Sistema</emphasis> dentro do painel de controle.  A
tela propriedades de sistema será aberta.  Clique em "Descrição de rede" e
então no botão "Propriedades".
</para>
</listitem>
<listitem>
<para>
No campo <emphasis>nome do computador</emphasis>, coloque um nome de no máximo
15 caracteres para identificar a máquina na rede.
</para>
</listitem>
<listitem>
<para>
Clique em <emphasis>grupo de trabalho</emphasis> e digite o nome do
<emphasis>grupo de trabalho</emphasis> na caixa de diálogo.
</para>
</listitem>
<listitem>
<para>
Clique em OK e aguarde a mensagem confirmando sua entrada no grupo de trabalho.
Será necessário reiniciar a máquina.
</para>
</listitem>
</itemizedlist>
</section>

<section id="s-samba-c-workgroup-linux"><title>Linux</title>
<para>
Os aplicativos <command>smbclient</command> e <command>smbmount</command> são
usados para navegação e montagem dos discos e impressoras compartilhadas em
máquinas <command>Linux</command>.  Se você procura programas de navegação
gráficos, como o <emphasis>Ambiente de Rede</emphasis> do
<command>Windows</command> ou mais poderosos, veja <xref
linkend="s-samba-c-graficos"/>.  Como complemento, também é explicado o
programa <command>nmblookup</command> para resolução de endereços NetBIOS em IP
e vice-versa e a forma que as funções de máquinas são definidas em uma rede
NetBEUI.
</para>
<section id="s-samba-c-workgroup-linux-smbmount"><title>smbmount</title>
<para>
O <command>smbmount</command> é uma ferramenta que permite a montagem de um
disco compartilhado por uma máquina NetBEUI remota como uma partição.  Veja
alguns exemplos:
</para>
<variablelist>
<varlistentry>
<term>smbmount //servidor/discoc /mnt/discoc</term>
<listitem>
<para>
Monta o compartilhamento de <emphasis>//servidor/discoc</emphasis> em
<filename>/mnt/discoc</filename> usando o nome de usuário atual.  Será pedido
uma senha para acessar o conteúdo do compartilhamento, caso ele seja público,
você pode digitar qualquer senha ou simplesmente pressionar enter.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>smbmount //servidor/discoc /mnt/discoc -N</term>
<listitem>
<para>
Semelhante ao comando cima, com a diferença que o parâmetro
<literal>-N</literal> não pergunta por uma senha.  Isto é ideal para acessar
compartilhamentos anônimos.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>smbmount //servidor/discoc /mnt/discoc -o username=gleydson,workgroup=teste</term>
<listitem>
<para>
Semelhante aos anteriores, mas acessa o compartilhamento usando
<emphasis>gleydson</emphasis> como nome de usuário e <emphasis>teste</emphasis>
como grupo de trabalho.  Este método é ideal para redes que tem o nível de
acesso por usuário ou para acessar recursos compartilhados em um domínio.
</para>
</listitem>
</varlistentry>
</variablelist>
</section>

<section id="s-samba-c-workgroup-linux-smbclient"><title>smbclient</title>
<para>
O <command>smbclient</command> é uma ferramenta de navegação em servidores
SAMBA.  Ao invés dela montar o compartilhamento como um disco local, você
poderá navegar na estrutura do servidor de forma semelhante a um cliente FTP e
executar comandos como <literal>ls</literal>, <literal>get</literal>,
<literal>put</literal> para fazer a transferência de arquivos entre a máquina
remota e a máquina local.  Também é através dele que é feita a interface com
impressoras compartilhadas remotamente.  Veja exemplos do uso do
<command>smbclient</command>:
</para>
<variablelist>
<varlistentry>
<term>smbclient -L samba1</term>
<listitem>
<para>
Lista todos os compartilhamentos existentes (<literal>-L</literal>) no servidor
<filename>samba1</filename>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>smbclient //samba1/discoc</term>
<listitem>
<para>
Acessa o conteúdo do compartilhamento <literal>discoc</literal> no servidor
<literal>samba1</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>smbclient //samba1/discoc -N</term>
<listitem>
<para>
Idêntico ao acima, mas não utiliza senha (ideal para compartilhamentos com
acesso anônimo).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>smbclient //samba1/discoc -I 192.168.1.2</term>
<listitem>
<para>
Se conecta ao compartilhamento usando o endereço IP
<filename>192.168.1.2</filename> ao invés da resolução de nomes.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>smbclient //samba1/discoc -U gleydson -W teste</term>
<listitem>
<para>
Se conecta ao compartilhamento como usuário <literal>gleydson</literal> usando
o grupo de trabalho <literal>teste</literal>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>smbclient //samba1/discoc -U gleydson%teste1 -W teste</term>
<listitem>
<para>
Idêntico ao acima, mas também envia a senha <literal>teste1</literal> para
fazer a conexão diretamente.
</para>
</listitem>
</varlistentry>
</variablelist>
<para>
Caso receba a mensagem <literal>NT Status Access Denied</literal>, isto quer
dizer que não possui direitos de acesso adequados para listas ou acessar os
compartilhamentos da máquina.  Nesse caso, utilize as opções <literal>-U
usuário</literal> e <literal>-W grupo/domínio</literal> para fazer acesso com
uma conta válida de usuário existente na máquina.
</para>
<para>
<emphasis role="strong">OBS:</emphasis>Note que a ordem das opções faz
diferença no <command>smbmount</command>.
</para>
</section>

<section id="s-samba-c-workgroup-linux-nmblookup"><title>nmblookup</title>
<para>
Esta é uma ferramenta usada para procurar nomes de cliente usando o endereço
IP, procurar um IP usando o nome e listar as características de cada cliente.
Veja alguns exemplos:
</para>
<variablelist>
<varlistentry>
<term>nmblookup -A 127.0.0.1</term>
<listitem>
<para>
Lista o nome e as opções usadas pelo servidor <filename>127.0.0.1</filename>
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>nmblookup servidor</term>
<listitem>
<para>
Resolve o endereço IP da máquina <literal>servidor</literal>.
</para>
</listitem>
</varlistentry>
</variablelist>
<para>
A listagem exibida pela procura de IP do <command>nmblookup</command> possui
códigos hexadecimais e cada um deles possui um significado especial no
protocolo NetBEUI.  Segue a explicação de cada um:
</para>
<variablelist>
<varlistentry>
<term>Identificação da máquina</term>
<listitem>
<itemizedlist>
<listitem>
<para>
COMPUTADOR&lt;00&gt;= O serviço NetBEUI está sendo executado na máquina.
</para>
</listitem>
<listitem>
<para>
COMPUTADOR&lt;03&gt; = Nome genérico da máquina (nome NetBIOS).
</para>
</listitem>
<listitem>
<para>
COMPUTADOR&lt;20&gt; = Serviço LanManager está sendo executado na máquina.
</para>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>Identificação de grupos/domínio</term>
<listitem>
<itemizedlist>
<listitem>
<para>
GRUPO_TRABALHO&lt;1d&gt; - &lt;GRUPO&gt; = Navegador Local de Domínio/Grupo.
</para>
</listitem>
<listitem>
<para>
GRUPO_TRABALHO&lt;1b&gt; = Navegador Principal de Domínio.
</para>
</listitem>
<listitem>
<para>
GRUPO_TRABALHO&lt;03&gt; - &lt;GRUPO&gt; = Nome Genérico registrado por todos
os membros do grupo de trabalho.
</para>
</listitem>
<listitem>
<para>
GRUPO_TRABALHO&lt;1c&gt; - &lt;GRUPO&gt; = Controladores de Domínio /
Servidores de logon na rede.
</para>
</listitem>
<listitem>
<para>
GRUPO_TRABALHO&lt;1e&gt; - &lt;GRUPO&gt; = Resolvedores de Nomes Internet
(<literal>WINS</literal>).
</para>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<para>
Estes códigos podem lhe ser úteis para localizar problemas mais complicados que
possam ocorrer durante a configuração de um servidor.
</para>
</section>

</section>

</section>

<section id="s-samba-c-dominio"><title>Configurando clientes em Domínio</title>
<para>
Para configurar qualquer um dos cliente abaixo para fazer parte de um domínio
de rede, é necessário apenas que tenha em mãos os seguintes dados:
</para>
<itemizedlist>
<listitem>
<para>
Nome do controlador de domínio PDC
</para>
</listitem>
<listitem>
<para>
Nome do domínio
</para>
</listitem>
<listitem>
<para>
Nome de usuário e senha que foram cadastrados no servidor.
</para>
</listitem>
<listitem>
<para>
Acesso administrador no SERVIDOR PDC (SAMBA, NT, etc).
</para>
</listitem>
<listitem>
<para>
Cria uma conta de máquina no domínio (no caso da máquina ser um Windows NT,
Windows XP, Windows 2k ou Linux).  Veja <xref linkend="s-samba-dom-contasmac"/>
para maiores detalhes.
</para>
</listitem>
</itemizedlist>
<para>
Como o Windows 3.11, Windows 95, Windows 98, Windows ME não possuem uma conta
de máquina, eles nunca serão um membro real de um domínio, podendo sofrer um
name spoofing e terem a identidade roubada.  Mesmo assim, eles terão pleno
acesso aos recursos do domínio e uma configuração mais fácil que os demais
clientes.  Com estes dados em mãos, selecione na lista abaixo o nome do cliente
que deseja integrar no grupo de trabalho:
</para>
<itemizedlist>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-w9x"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-wXPHome"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-wXPprofessional"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-wXPServer"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-NTWorkstation"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-NTServer"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-w2kProfessional"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-w2kServer"/>
</para>
</listitem>
<listitem>
<para>
<xref linkend="s-samba-c-workgroup-linux"/>
</para>
</listitem>
</itemizedlist>
<para>
<emphasis role="strong">OBS:</emphasis> O Windows 2000 apresenta algumas
dificuldades em entrar na rede do SAMBA 2.2, sendo necessário o uso do SAMBA
TNG 2.2.x para aceitar o logon de estações Windows 2000.
</para>
<section id="s-samba-c-dominio-w9x"><title>Windows 9X</title>
<para>
Estas configurações são válidas para clientes Windows 95, Windows 95OSR/2,
Windows 98.  Caso utilize o <command>Windows 95</command> (qualquer uma das
séries) é aconselhável atualizar a stack TCP/IP e NetBEUI para corrigir alguns
problemas que podem deixar sua máquina vulnerável na versão que acompanha o
WinSock do Windows 95.
</para>
<para>
Para tornar uma máquina parte do domínio, siga os seguintes passos:
</para>
<itemizedlist>
<listitem>
<para>
Entre nas propriedades de rede no Painel de Controle
</para>
</listitem>
<listitem>
<para>
Instale o Cliente para redes Microsoft (caso não esteja instalado).
</para>
</listitem>
<listitem>
<para>
Instale o Protocolo TCP/IP.  Você também pode instalar o protocolo NetBIOS, mas
utilizaremos o suporte NetBIOS sobre TCP/IP que é o usado pelo
<command>SAMBA</command> além de ter um melhor desempenho, permitir integração
com servidores WINS, etc.
</para>
</listitem>
<listitem>
<para>
Clique em "Cliente para redes Microsoft", marque a opção "Efetuar logon no
domínio do Windows NT".  Coloque o nome do domínio que irá configurar o cliente
para fazer parte na caixa "Domínio do Windows NT" (por exemplo, "suporte").  Na
parte de baixo da caixa de diálogo, você poderá escolher como será o método
para restaurar as conexões de rede.  Inicialmente, recomendo que utilize a
"Efetuar logon e restaurar as conexões de rede" que é mais útil para depurar
problemas (possíveis erros serão mostrados logo que fizer o logon no domínio).
</para>
<para>
Adeque esta configuração as suas necessidades quando estiver funcionando :)
</para>
</listitem>
<listitem>
<para>
Clique em "Protocolo TCP/IP" e em Propriedades.  Clique na tab "NetBIOS" e
marque a opção "Desejo ativar o NetBIOS através do TCP/IP".  Caso esta caixa
esteja em cinza, então está tudo certo também.
</para>
</listitem>
<listitem>
<para>
Clique na tab "Identificação" e coloque lá o nome que identificará o computador
(até 15 caracteres).
</para>
</listitem>
<listitem>
<para>
Digite o nome de um grupo de trabalho que a máquina fará parte no campo "Grupo
de Trabalho" (por exemplo "workgroup", "suporte", etc).  Este campo somente
será usado caso o logon no domínio NT não seja feito com sucesso.  No campo
"Descrição do Computador", coloque algo que identifique a máquina na rede (por
exemplo, "Computador da área de suporte").
</para>
</listitem>
<listitem>
<para>
Clique na tab "Controle de Acesso" e marque o "Controle de acesso a nível de
usuário e especifique o nome da máquina que serve a lista de usuários, que
normalmente é a mesma do PDC.
</para>
</listitem>
<listitem>
<para>
Clique em OK até reiniciar o computador.
</para>
</listitem>
</itemizedlist>
<para>
Quando for mostrada a tela pedindo o nome/senha, preencha com os dados da conta
de usuário que criou no servidor.  No campo domínio, coloque o domínio que esta
conta de usuário pertence e tecle &lt;Enter&gt;.  Você verá o script de logon
em ação (caso esteja configurado) e a máquina cliente agora faz parte do
domínio!  Tente acessar um outro computador da rede e navegar através do
ambiente de rede.  Caso a lista de máquinas demore em aparecer, tente acessar
diretamente pelo nome do computador, usando o seguinte formato: "\\computador"
</para>
</section>

<section id="s-samba-c-dominio-wXPHome"><title>Windows XP Home Edition</title>
<para>
Não é possível fazer o <command>Windows XP Home Edition</command> ser parte de
um domínio, por causa de limitações desta versão.
</para>
</section>

<section id="s-samba-c-dominio-wXPprofessional"><title>Windows XP Professional Edition</title>
<itemizedlist>
<listitem>
<para>
Primeiro, siga todos os passos para ingressar a máquina em um grupo de trabalho
como documentado em <xref linkend="s-samba-c-workgroup-wXPprofessional"/>.
</para>
</listitem>
<listitem>
<para>
Atualize o registro para permitir a entrada no domínio:
</para>
<orderedlist numeration="arabic">
<listitem>
<para>
Copie o seguinte conteúdo para o arquivo <filename>WinXP-Dom.reg</filename>:
</para>
<screen>
REGEDIT4

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\netlogon\parameters
"RequireSignOrSeal"=dword:00000000
"SignSecureChannel"=dword:00000000
</screen>
</listitem>
<listitem>
<para>
Execute o comando <literal>regedit WinXP-Dom.reg</literal> no cliente XP.
</para>
</listitem>
</orderedlist>
</listitem>
<listitem>
<para>
Entre nos ítens (em seqüencia) Painel de controle/Ferramentas Administrativas/
Política de segurança local/políticas locais e depois em "opções de segurança".
Na janela de opções de segurança, desative as opções "Encriptar digitalmente ou
assinar um canal seguro (sempre)", "Desativar modificações de senha na conta de
máquina" e "Requer chave de seção forte (Windows 2000 ou superior)."
</para>
</listitem>
<listitem>
<para>
Reinicie a máquina.
</para>
</listitem>
<listitem>
<para>
Após reiniciar a máquina, volte na tela de alteração de identificação de
máquina na rede.
</para>
</listitem>
<listitem>
<para>
Clique com o mouse em "Domínio" e digite o nome do domínio na caixa de diálogo.
</para>
</listitem>
<listitem>
<para>
Na tela seguinte, será lhe pedido o nome de usuário e senha com poderes
administrativos que podem inserir/remover máquinas do domínio.
</para>
</listitem>
<listitem>
<para>
Clique em OK e aguarde a mensagem confirmando sua entrada no domínio.  Será
necessário reiniciar a máquina após concluir este passo.
</para>
</listitem>
</itemizedlist>
</section>

<section id="s-samba-c-dominio-wXPServer"><title>Windows XP Server Edition</title>
<para>
Siga os procedimentos documentados em <xref
linkend="s-samba-c-dominio-wXPprofessional"/>
</para>
</section>

<section id="s-samba-c-dominio-NTWorkstation"><title>Windows NT WorkStation</title>
<para>
Veja os passos em <xref linkend="s-samba-c-dominio-NTServer"/>.
</para>
</section>

<section id="s-samba-c-dominio-NTServer"><title>Windows NT Server</title>
<itemizedlist>
<listitem>
<para>
Clique no item <literal>Rede</literal> do painel de controle.
</para>
</listitem>
<listitem>
<para>
Na tab <literal>Serviços</literal>, confira se os serviços <literal>Estação de
trabalho</literal>, <literal>Interface de NetBIOS</literal> e <literal>Serviços
TCP/IP simples</literal> estão instalados.  Caso não estejam, faça sua
instalação usando o botão <literal>Adicionar</literal> nesta mesma janela.
</para>
</listitem>
<listitem>
<para>
Na tab <literal>Protocolos</literal>, verifique se os protocolos
<emphasis>NetBEUI</emphasis> e <emphasis>TCP/IP</emphasis> estão instalados.
Caso não estejam, faça sua instalação clicando no botão
<literal>Adicionar</literal> nesta mesma janela.
</para>
</listitem>
<listitem>
<para>
Na tab identificação, clique no botão <literal>Alterar</literal>
</para>
</listitem>
<listitem>
<para>
Na janela que se abrirá, coloque o nome do computador no campo <literal>Nome do
Computador</literal>
</para>
</listitem>
<listitem>
<para>
Clique em <literal>Dominio</literal> e escreva o nome do domínio que deseja
entrar.
</para>
</listitem>
<listitem>
<para>
Para criar uma <emphasis>conta de máquina</emphasis> no domínio, clique em
<literal>criar uma conta de computador no domínio</literal> e coloque na parte
de baixo o nome do usuário sua senha.  O usuário deverá ter poderes para
adicionar máquinas no domínio.  Caso a conta de máquina não seja criada, o
Windows NT será como um Windows 95/98 na rede, sem a segurança que seu nome
NetBIOS não seja usado por outros (veja <xref
linkend="s-samba-dom-contasmac"/>).
</para>
</listitem>
<listitem>
<para>
Clique em OK até voltar.
</para>
</listitem>
<listitem>
<para>
Pronto, seu computador agora faz parte do domínio.
</para>
</listitem>
</itemizedlist>
</section>

<section id="s-samba-c-dominio-w2kProfessional"><title>Windows 2000 Professional</title>
<para>
Siga os passos descritos em <xref linkend="s-samba-c-dominio-w2kServer"/>.
</para>
</section>

<section id="s-samba-c-dominio-w2kServer"><title>Windows 2000 Server</title>
<itemizedlist>
<listitem>
<para>
Primeiro, siga todos os passos para ingressar a máquina em um grupo de trabalho
como documentado em <xref linkend="s-samba-c-workgroup-w2kServer"/>.
</para>
</listitem>
<listitem>
<para>
Após reiniciar a máquina, volte na tela de alteração de identificação de
máquina na rede.
</para>
</listitem>
<listitem>
<para>
Clique com o mouse em "Domínio" e digite o nome do domínio na caixa de diálogo.
</para>
</listitem>
<listitem>
<para>
Na tela seguinte, será lhe pedido o nome de usuário e senha com poderes
administrativos que podem inserir/remover máquinas do domínio.
</para>
</listitem>
<listitem>
<para>
Clique em OK e aguarde a mensagem confirmando sua entrada no domínio.  Será
necessário reiniciar a máquina após concluir este passo.
</para>
</listitem>
</itemizedlist>
<para>
Caso não consiga trocar a senha do Windows 2000 no servidor PDC, desative a
opção <literal>unix password sync</literal>.
</para>
</section>

<section id="s-samba-c-dominio-linux"><title>Linux</title>
<itemizedlist>
<listitem>
<para>
Entre no sistema como usuário <emphasis>root</emphasis>.
</para>
</listitem>
<listitem>
<para>
Instale o <command>SAMBA</command> caso não esteja ainda instalado.
</para>
</listitem>
<listitem>
<para>
Edite o arquivo de configuração do samba
<filename>/etc/samba/smb.conf</filename>, será necessário modificar as
seguintes linhas na seção <emphasis>[global]</emphasis>:
</para>
<screen>
[global]
 workgroup = nome_domínio
 security = domain
 password server = nome_pdc nome_bdc
 encrypt passwords = true
</screen>
<para>
Onde:
</para>
<itemizedlist>
<listitem>
<para>
<literal>workgroup</literal> - Nome do domínio que deseja fazer parte.
</para>
</listitem>
<listitem>
<para>
<literal>security</literal> - Nível de segurança.  Nesta configuração, utilize
"domain".
</para>
</listitem>
<listitem>
<para>
<literal>password server</literal> - Nome da máquina PDC, BDC.  Também poderá
ser usado <literal>*</literal>, assim o <command>SAMBA</command> tentará
descobrir o servidor PDC e BDC automaticamente, da mesma forma usada pelo
<command>Windows</command>.
</para>
</listitem>
<listitem>
<para>
<literal>encrypt passwords</literal> - Diz se as senhas serão encriptadas ou
não.  Sempre utilize senhas criptografadas para colocar uma máquina em um
domínio.
</para>
</listitem>
</itemizedlist>
<para>
Reinicie o servidor <command>SAMBA</command> após estas modificações.
</para>
</listitem>
<listitem>
<para>
Execute o comando: <literal>smbpasswd -j domínio -r PDC/BDC -U
usuario_admin</literal>.  Onde:
</para>
<itemizedlist>
<listitem>
<para>
<literal>domínio</literal> - Domínio que deseja fazer o logon
</para>
</listitem>
<listitem>
<para>
<literal>PDC/BDC</literal> - Nome da máquina PDC/BDC do domínio.  Em alguns
casos, pode ser omitido.
</para>
</listitem>
<listitem>
<para>
<literal>usuario_admin</literal> - Usuário com poderes administrativos para
ingressara a máquina no domínio.
</para>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<para>
Se tudo der certo, após executar este comando, você verá a mensagem:
</para>
<screen>
Joined domain "domínio".
</screen>
</listitem>
</itemizedlist>
<para>
Se sua configuração não funcionou, revise com atenção todos os ítens acima.
Verifique se a conta de máquina foi criada no servidor e se o
<command>SAMBA</command> na máquina cliente foi reiniciado.  De também uma
olhada em <xref linkend="s-samba-c-dominio-erros"/>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis>O SAMBA envia primeiramente um
usuário/senha falso para verificar se o servidor rejeita o acesso antes de
enviar o par de nome/senha corretos.  Por este motivo, seu usuário pode ser
bloqueado após um determinado número de tentativas em alguns servidores mais
restritivos.  Para acessar os recursos compartilhados, veja <xref
linkend="s-samba-c-workgroup-linux"/>.  Note que não é obrigatório realizar as
configurações acima para acessar os recursos de uma máquina em domínio, basta
apenas que autentique com seu nome de usuário/senha no domínio e que ela seja
autorizada pelo PDC.
</para>
</section>

</section>

<section id="s-samba-c-dominio-erros"><title>Erros conhecidos durante o logon do cliente</title>
<para>
Esta seção contém os erros mais comuns e a forma de correção da maioria dos
problemas que ocorrem quando um cliente SAMBA tenta entrar em domínio.
</para>
<itemizedlist>
<listitem>
<para>
<literal>error creating domain user: NT_STATUS_ACCESS_DENIED</literal> - A
conta de máquina no domínio não foi criada.  Veja <xref
linkend="s-samba-dom-contasmac"/> para mais detalhes.
</para>
</listitem>
<listitem>
<para>
<literal>NT_STATUS_NO_TRUST_SAM_ACCOUNT</literal> - Não existe conta de máquina
no <command>Windows NT</command> para autenticar uma máquina no domínio.  Esta
mensagem é mostrada quando a máquina SAMBA é cliente de um domínio NT.
</para>
</listitem>
<listitem>
<para>
<literal>error setting trust account password:
NT_STATUS_ACCESS_DENIED</literal> - A senha para criação de conta na máquina
está incorreta ou a conta utilizada não tem permissões para ingressar uma
máquina no domínio (veja <xref linkend="s-samba-dom-admin"/>).  Caso esteja
usando um cliente SAMBA, verifique se o parâmetro <literal>encrypt
passwords</literal> está ativado.
</para>
</listitem>
<listitem>
<para>
<literal>A senha informada não está correta ou o acesso ao seu servidor de
logon foi negado</literal> - Verifique primeiro os logs de acessos do sistema.
Caso o SAMBA esteja sendo executado via <command>inetd</command>, verifique se
a configuração padrão é restritiva e se o acesso está sendo negado pelos
arquivos do tcp wrappers <filename>hosts.allow</filename> e
<filename>hosts.deny</filename>.
</para>
</listitem>
<listitem>
<para>
<literal>não existem servidores de logon no domínio</literal> - Verifique se o
parâmetro <literal>domain logons = yes</literal> foi usado para permitir o
logon em domínio.
</para>
</listitem>
</itemizedlist>
</section>

<section id="s-samba-c-graficos"><title>Programas de navegação gráficos</title>
<para>
O <command>smbclient</command>, <command>nmblookup</command> e
<command>smbmount</command> são ferramentas extremamente poderosas auxiliando
bastante o administrador na tarefa de configuração de sua rede e resolver
problemas.  Para o uso no dia a dia ou quando não é necessária a operação via
console, você pode utilizar uma das alternativas abaixo que são front-ends a
estas ferramentas e facilitam o trabalho de navegação na rede.
</para>
<section id="s-samba-c-graficos-linneighborhood"><title>linneighborhood</title>
<para>
Cliente SAMBA baseado em GTK, muito leve e possibilita a navegação entre os
grupos máquinas em forma de árvore.  Ele também permite a montagem de
compartilhamentos remotos.  Caso precise de recursos mais complexos e
autenticação, recomendo o <xref linkend="s-samba-c-graficos-tksmb"/>.
</para>
</section>

<section id="s-samba-c-graficos-tksmb"><title>TkSmb</title>
<para>
Cliente SAMBA baseado em TCL/TK.  Seu ponto forte é a navegação nos recursos da
máquina ao invés da rede completa, possibilitando autenticação em domínio/grupo
de trabalho, montagem de recursos, etc.
</para>
</section>

</section>

<section id="s-samba-c-conf"><title>Cliente de configuração gráficos</title>
<para>
São ferramentas que permitem a configuração do samba usando a interface
gráfica.  Isto facilita bastante o processo, principalmente se estiver em
dúvidas em algumas configurações, mas como todo bom administrador UNIX sabe,
isto não substitui o conhecimento sobre o funcionamento de cada opção e ajustes
e organização feita diretamente no arquivo de configuração.
</para>
<section id="s-samba-c-conf-gnosamba"><title>gnosamba</title>
<para>
Ferramenta de configuração gráfica usando o GNOME.  Com ele é possível definir
configurações localmente.  Ele ocupa pouco espaço em disco, e se você gosta de
GTK, este é o recomendado.
</para>
<para>
As opções do SAMBA são divididas em categorias facilitando sua localização e
uso.
</para>
</section>

<section id="s-samba-c-conf-swat"><title>swat</title>
<para>
Ferramenta de administração via web do samba.  Este é um daemon que opera na
porta 901 da máquina onde o servidor samba foi instalado.  A configuração é
feita através de qualquer navegador acessando
<literal>http://ip_do_servidor:901</literal> e logando-se como usuário root (o
único com poderes para escrever no arquivo de configuração).
</para>
<para>
Esta ferramenta vem evoluindo bastante ao decorrer dos meses e é a recomendada
para a configuração do servidor SAMBA remotamente.  Seu modo de operação
divide-se em <emphasis>básico</emphasis> e <emphasis>avançado</emphasis>.  No
modo <literal>básico</literal>, você terá disponível as opções mais comuns e
necessárias para compartilhar recursos na rede.  O modo
<literal>avançado</literal> apresenta praticamente todos os parâmetros aceitos
pelo servidor samba (restrições, controle de acesso, otimizações, etc.).
</para>
</section>

</section>

</section>

<section id="s-samba-exemplos"><title>Exemplos de configuração do servidor SAMBA</title>
<para>
Os exemplos existentes nesta seção cobrem diferentes tipos de configuração do
servidor, tanto em modo de compartilhamento com acesso público ou um domínio
restrito de rede.  Todos os exemplos estão bem comentados e explicativos,
apenas pegue o que se enquadre mais em sua situação para uso próprio e
adaptações.
</para>
<section id="s-samba-exemplos-workgroup-p"><title>Grupo de Trabalho com acesso público</title>
<para>
Este exemplo pode ser usado de modelo para construir uma configuração baseada
no controle de acesso usando o nível de segurança <emphasis>share</emphasis> e
quando possui compartilhamentos de acesso público.  Esta configuração é
indicada quando necessita de compatibilidade com softwares NetBIOS antigos.
</para>
<screen>
 # Arquivo de configuração do SAMBA criado por 
 # Gleydson Mazioli da Silva &lt;gleydson@debian.org&gt;
 # para o guia Foca GNU/Linux Avançado - Capítulo SAMBA
 # Este script pode ser copiado e distribuído livremente de 
 # acordo com os termos da GPL. Ele não tem a intenção de 
 # atender uma determinada finalidade, sendo usado apenas 
 # para fins didáticos, portanto fica a inteira responsabilidade
 # do usuário sua utilização.

[global]
 # nome da máquina na rede
 netbios name = teste
 # nome do grupo de trabalho que a máquina pertencerá
 workgroup = focalinux
 # nível de segurança share permite que clientes antigos mantenham a compatibilidade
 # enviando somente a senha para acesso ao recurso, determinando o nome de usuário
 # de outras formas
 security = share
 # O recurso de senhas criptografadas não funciona quando usamos o nível share 
 # de segurança. O motivo disto é porque automaticamente é assumido que você 
 # está selecionando este nível por manter compatibilidade com sistemas antigos
 # ou para disponibilizar compartilhamentos públicos, onde 
 encrypt passwords = false
 # Conta que será mapeada para o usuário guest
 guest account = nobody
 # Como todos os compartilhamentos desta configuração são de acesso público
 # coloquei este parâmetro na seção [global], assim esta opção afetará todos
 # os compartilhamentos.
 guest ok = 1
 # Conjunto de caracteres utilizados para acessar os compartilhamentos. O padrão
 # para o Brasil e países de língua latina é o ISO 8859-1
 character set = ISO8859-1
 

# Compartilha o diretório /tmp (path = /tmp) com o nome "temporario" ([temporario]),
# é adicionada a descrição "Diretório temporário" com acesso leitura/gravação 
# (read only = no) e exibido na janela de navegação da rede (browseable = yes).
[temporario]
 path = /tmp
 comment = Diretório temporário
 read only = no
 browseable = yes

# Compartilha o diretório /pub (path = /pub) com o nome "publico" ([publico]).
# A descrição "Diretório de acesso público" é associada ao compartilhamento
# com acesso somente leitura (read only = yes) e exibido na janela de navegação 
# da rede (browseable = yes).
[publico] 
 path =/pub
 comment = Diretório de acesso público
 read only = yes
 browseable = yes

# Compartilha todas as impressoras encontradas no /etc/printcap do sistema
# Uma descrição melhor do tipo especial de compartilhamento "[printers]"
# é explicado no inicio do guia Foca Linux
[printers]
 comment = All Printers
 path = /tmp
 create mask = 0700
 printable = Yes
 browseable = No
</screen>
</section>

<section id="s-samba-exemplos-workgroup-u"><title>Grupo de Trabalho com acesso por usuário</title>
<para>
O exemplo abaixo descreve uma configuração a nível de segurança por usuário
onde existem compartilhamentos que requerem login e usuários específicos, e
restrições de IPs e interface onde o servidor opera.  Esta configuração utiliza
senhas em texto claro para acesso dos usuários, mas pode ser facilmente
modificada para suportar senhas criptografadas.
</para>
<screen>
 # Arquivo de configuração do SAMBA criado por 
 # Gleydson Mazioli da Silva &gt;gleydson@debian.org&gt;
 # para o guia Foca GNU/Linux Avançado - Capítulo SAMBA
 # Este script pode ser copiado e distribuído livremente de 
 # acordo com os termos da GPL. Ele não tem a intenção de 
 # atender uma determinada finalidade, sendo usado apenas 
 # para fins didáticos, portanto fica a inteira responsabilidade
 # do usuário sua utilização.

[global]
 # nome da máquina na rede
 netbios name = teste
 # nome do grupo de trabalho que a máquina pertencerá
 workgroup = focalinux
 # nível de segurança user somente aceita usuários autenticados após o envio 
 # de login/senha
 security = user
 # É utilizada senhas em texto claro nesta configuração
 encrypt passwords = false
 # Conta que será mapeada para o usuário guest
 guest account = nobody
 # Permite restringir quais interfaces o SAMBA responderá
 bind interfaces only = yes
 # Faz o samba só responder requisições vindo de eth0
 interfaces = eth0
 # Supondo que nossa interface eth0 receba conexões roteadas de diversas 
 # outras redes, permite somente as conexões vindas da rede 192.168.1.0/24
 hosts allow = 192.168.1.0/24
 # A máquina 192.168.1.57 possui gateway para acesso interno, como medida
 # de segurança, bloqueamos o acesso desta máquina.
 hosts deny = 192.168.1.57/32
 
 # Conjunto de caracteres utilizados para acessar os compartilhamentos. O padrão
 # para o Brasil e países de língua latina é o ISO 8859-1
 character set = ISO8859-1

 # As restrições do PAM terão efeito sobre os usuários e recursos usados do SAMBA
 obey pam restriction = yes 

# Mapeia o diretório home do usuário autenticado. Este compartilhamento especial
# é descrito em mais detalhes no inicio do capítulo sobre o SAMBA no Foca Linux.
[homes]
  comment = Diretório do Usuário
  create mask = 0700
  directory mask = 0700
  browseable = No

# Compartilha o diretório win (path = /win) com o nome "win" ([win]). 
# A descrição associada ao compartilhamento será "Disco do Windows", 
# o nome de volume precisa ser especificado pois usamos programas 
# que a proteção anti cópia é o serial. Ainda fazemos uma proteção
# onde qualquer usuário existente no grupo @adm é automaticamente 
# rejeitado e o usuário "baduser" somente possui permissão de leitura
# (read list = baduser).
#
[win]
 path = /win
 comment = Disco do Windows
 volume = 3CF434C
 invalid users = @adm
 browseable = yes
 read list = baduser

# Compartilha o diretório /pub (path = /pub) com o nome "publico" ([publico]).
# A descrição "Diretório de acesso público" é associada ao compartilhamento
# com acesso somente leitura (read only = yes) e exibido na janela de navegação 
# da rede (browseable = yes). O parâmetro public = yes permite que este 
# compartilhamento seja acessado usando o usuário "nobody" sem o fornecimento
# de senha.
[publico] 
 path =/pub
 comment = Diretório de acesso público
 read only = yes
 browseable = yes
 public = yes
</screen>
</section>

<section id="s-samba-exemplos-dominio"><title>Domínio</title>
<screen>
 # Arquivo de configuração do SAMBA criado por 
 # Gleydson Mazioli da Silva &lt;gleydson@debian.org&gt;
 # para o guia Foca GNU/Linux Avançado - Capítulo SAMBA
 # Este script pode ser copiado e distribuído livremente de 
 # acordo com os termos da GPL. Ele não tem a intenção de 
 # atender uma determinada finalidade, sendo usado apenas 
 # para fins didáticos, portanto fica a inteira responsabilidade
 # do usuário sua utilização.

[global]
 # nome da máquina na rede
 netbios name = teste
 # nome do grupo de trabalho que a máquina pertencerá
 workgroup = focalinux
 # String que será mostrada junto com a descrição do servidor
 server string = servidor PDC principal de testes
 # nível de segurança user somente aceita usuários autenticados após o envio 
 # de login/senha
 security = user
 # Utilizamos senhas criptografadas nesta configuração
 encrypt passwords = true
 smb passwd file = /etc/samba/smbpasswd
 # Conta que será mapeada para o usuário guest
 guest account = nobody
 # Permite restringir quais interfaces o SAMBA responderá
 bind interfaces only = yes
 # Faz o samba só responder requisições vindo de eth0
 interfaces = eth0

 # como estamos planejando ter um grande número de usuários na rede, dividimos
 # os arquivos de log do servidor por máquina.
 log file =  /var/log/samba/samba-%m-%I.log
 # O tamanho de CADA arquivo de log criado deverá ser 1MB (1024Kb). 
 max log size = 1000 
 # Escolhemos um nível de OS com uma boa folga para vencer as eleições de 
 # controlador de domínio local
 os level = 80 
 # Dizemos que queremos ser o Domain Master Browse (o padrão é auto)
 domain master = yes
 # Damos algumas vantagens para o servidor ganhar a eleição caso 
 # aconteça desempate por critérios
 preferred master = yes
 # Também queremos ser o local master browser para nosso segmento de rede
 local master = yes
 # Este servidor suportará logon de usuários
 domain logons = yes
 # Usuários que possuem poderes para adicionar/remover máquinas no domínio
 # (terão seu nível de acesso igual a root)
 admin users = gleydson
 # Unidade que será mapeada para o usuário local durante o logon (apenas
 # sistemas baseados no NT).
 logon drive = m:
 # Nome do script que será executado pelas máquinas clientes
 logon script = logon.bat

 # Ação que será tomada durante o recebimento de mensagens do 
 # Winpopup. 
 message command = /bin/sh -c '/usr/bin/linpopup "%f" "%m" %s; rm %s' &

 # Conjunto de caracteres utilizados para acessar os compartilhamentos. O padrão
 # para o Brasil e países de língua latina é o ISO 8859-1
 character set = ISO8859-1

 # As restrições do PAM terão efeito sobre os usuários e recursos usados do SAMBA
 obey pam restriction = yes 

# Mapeia o diretório home do usuário autenticado. Este compartilhamento especial
# é descrito em mais detalhes no inicio do capítulo sobre o SAMBA no Foca Linux.
[homes]
  comment = Diretório do Usuário
  create mask = 0700
  directory mask = 0700
  browseable = No

# Compartilha o diretório win (path = /win) com o nome "win" ([win]). 
# A descrição associada ao compartilhamento será "Disco do Windows", 
# o nome de volume precisa ser especificado pois usamos programas 
# que a proteção anti cópia é o serial. Ainda fazemos uma proteção
# onde qualquer usuário existente no grupo @adm é automaticamente 
# rejeitado e o usuário "baduser" somente possui permissão de leitura
# (read list = baduser).
#
[win]
 path = /win
 comment = Disco do Windows
 volume = 3CF434C
 invalid users = @adm
 browseable = yes
 read list = baduser

# Compartilha o diretório /pub (path = /pub) com o nome "publico" ([publico]).
# A descrição "Diretório de acesso público" é associada ao compartilhamento
# com acesso somente leitura (read only = yes) e exibido na janela de navegação 
# da rede (browseable = yes). O parâmetro public = yes permite que este 
# compartilhamento seja acessado usando o usuário "nobody" sem o fornecimento
# de senha.
[publico] 
 path =/pub
 comment = Diretório de acesso público
 read only = yes
 browseable = yes
 public = yes

# Compartilhamento especial utilizado para o logon de máquinas na rede
[netlogon]
 path=/pub/samba/netlogon/logon.bat
 read only = yes
</screen>
</section>

</section>

</chapter>

