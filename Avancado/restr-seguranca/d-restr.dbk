<?xml version='1.0' encoding='utf-8'?>
<!-- -*- DocBook -*- -->
<chapter id="d-restr"><title>Restrições de acesso, recursos e serviços</title>
<para>
Este capítulo documenta diversos métodos de fazer restrições de contas,
limitação de acesso interno/externo, de recursos por usuários/grupos, login,
tempo máximo ocioso, e outros modos para limitar o uso de recursos do sistema.
Também são descritos métodos para aumentar a segurança do acesso físico a seu
servidor e maneiras de restringir o uso de serviços disponíveis no sistema.
</para>
<para>
Se você deseja restringir o acesso de máquinas na rede ou portas específicas em
sua máquina , veja também <xref linkend="fw-iptables"/> .
</para>
<section id="d-restr-bash"><title>Limitando recursos no <command>bash</command></title>
<section id="d-restr-bash-readonly"><title>Uso do comando readonly para exportar variáveis</title>
<para>
Variáveis exportadas na forma comum podem ser modificadas a qualquer momento
pelo usuário, e isso pode trazer problemas de acordo com o tipo de sistema que
administramos.  A definição da variável como somente leitura (readonly) evita a
maioria destes problemas:
</para>
<screen>
readonly TESTE="123"
</screen>
<para>
A variável <replaceable>TESTE</replaceable> não poderá ser modificada ou
excluída.  Com isto o administrador pode "bloquear" a modificação de variáveis
que controlam o funcionamento de determinados recursos do interpretador de
comandos (alguns deles serão vistos ainda nesta seção).
</para>
<para>
<emphasis role="strong">OBS1:</emphasis> Algumas variáveis de controle de
ambientes ambiente do interpretador de comandos já são iniciadas com valores
somente leitura (como as variáveis <replaceable>EUID</replaceable> e
<replaceable>PPID</replaceable>)
</para>
<para>
<emphasis role="strong">OBS2:</emphasis> Variáveis exportadas como somente
leitura em shell scripts são mantidas até a finalização do script e depois
liberadas.
</para>
</section>

<section id="d-restr-homedir"><title>Restrições nos diretórios de usuários e root</title>
<para>
O controle de acesso a diretórios de usuários é importante quando desejamos que
outras pessoas não tenham acesso ao diretório de outros usuários, violando a
privacidade do mesmo e obtendo acesso a partes indesejáveis, principalmente do
usuário <literal>root</literal>.  É recomendado restringir o acesso somente ao
<literal>dono</literal> e <literal>grupo</literal> do usuário, bloqueando o
acesso a outros tipos de usuários:
</para>
<screen>
chmod 2750 /root
chmod 2750 /home/usuario
</screen>
<para>
O exemplo acima permitirá o acesso do diretório <filename>/root</filename> e
<filename>/home/usuario</filename> somente ao usuário e grupo que pertencem.
Este processo pode ser facilitado na criação dos diretórios de usuários em
<filename>/home</filename> especificando a variável:
<replaceable>DIR_MODE=0750</replaceable> no arquivo
<filename>/etc/adduser.conf</filename>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Algumas distribuições de
<command>Linux</command> garantem o acesso livre a diretórios de usuários por
padrão pois alguns daemons que requerem acesso a diretório de usuários rodam
sob outros usuários ao invés do root.  Um bom exemplo é a utilização do recurso
"UserDir" do <command>Apache</command> para servir requisições como
<filename>http://servidor.org/~usuario</filename>.
</para>
<para>
A restrição de diretório home neste caso bloqueará o acesso do servidor web
<command>Apache</command> ao diretório
<filename>/home/usuario/public_html</filename>.  Mesmo assim, uma alternativa
para garantir a utilização da restrição é incluir o usuário do servidor web
<command>Apache</command> (<literal>www-data</literal>) no grupo "usuario" (que
possui acesso ao diretório <filename>/home/usuario</filename>):
</para>
<screen>
adduser www-data usuario
</screen>
<para>
Isto garantirá que o servidor <command>Apache</command> continue servindo as
requisições dentro do diretório <filename>/home/usuario</filename>, com acesso
garantido via grupo.  O mesmo principio pode ser aplicado em outros programas,
apenas leve em consideração que se um cracker tomar conta do processo que tem
acesso ao seu diretório home restrito, ele certamente também terá acesso.
</para>
</section>

<section id="d-restr-bash-restricted"><title>Restrições básicas do shell bash com bash -r/--restricted, rbash</title>
<para>
Quando o <command>bash</command> é iniciado com o parâmetro
<literal>-r</literal>, <literal>--restricted</literal> ou como
<command>rbash</command>, o shell restringe o uso dos seguintes recursos em sua
seção:
</para>
<itemizedlist>
<listitem>
<para>
Usar o comando <command>cd</command> para mudar de diretório.
</para>
</listitem>
<listitem>
<para>
Definindo, modificar ou apagar a variáveis <replaceable>SHELL</replaceable>,
<replaceable>PATH</replaceable>, <replaceable>ENV</replaceable>,
<replaceable>BASH_ENV</replaceable>.
</para>
</listitem>
<listitem>
<para>
Nomes de comandos que contém <filename>/</filename>
</para>
</listitem>
<listitem>
<para>
Especificar um nome de arquivo contendo uma <filename>/</filename> como
argumento para o comando <command>builtin</command> (embutido no interpretador
de comandos).
</para>
</listitem>
<listitem>
<para>
Especificar uma <filename>/</filename> como argumento a opção
<emphasis>-p</emphasis> no comando <command>hash</command> (embutido no
interpretador de comandos).
</para>
</listitem>
<listitem>
<para>
Importar a definição de funções do ambiente do shell atual.
</para>
</listitem>
<listitem>
<para>
Analisar o valor da variável <replaceable>SHELLOPTS</replaceable> do ambiente
do shell atual.
</para>
</listitem>
<listitem>
<para>
Redirecionando a saída padrão usando os operadores de redirecionamento
<literal>&gt;</literal>, <literal>&gt;|</literal>, <literal>&lt;&gt;</literal>,
<literal>&gt;&</literal>, <literal>&&gt;</literal>; e
<literal>&gt;&gt;</literal>.
</para>
</listitem>
<listitem>
<para>
Usando o comando embutido <command>exec</command> para substituir o shell por
outro comando.
</para>
</listitem>
<listitem>
<para>
Usar as opções <emphasis>-f</emphasis> ou <emphasis>-d</emphasis> com o comando
<command>enable</command> (embutido no interpretador de comandos).
</para>
</listitem>
<listitem>
<para>
Especificar a opção <emphasis>-p</emphasis> ao comando interno
<command>command</command>.
</para>
</listitem>
<listitem>
<para>
Desativar o modo restrito com <literal>set +r</literal> ou <literal>set +o
restricted</literal> *
</para>
</listitem>
</itemizedlist>
<para>
Estas restrições são ativadas após a leitura dos arquivos de inicialização do
interpretador de comandos.  O shell restrito desliga as restrições quando um
shell script é executado.
</para>
</section>

<section id="d-restr-bash-logoutocioso"><title>Finalizando consoles inativos</title>
<para>
A variável <replaceable>TMOUT</replaceable> determina o tempo de inatividade de
um shell para que ele seja terminado.
</para>
<screen>
export TMOUT=600
</screen>
<para>
Terminará o <command>bash</command> caso nenhum comando seja executado no
período de 600 segundos (5 minutos).  Veja <xref
linkend="d-restr-bash-readonly"/> como complemento.
</para>
</section>

<section id="d-restr-bash-logging"><title>Desabilitando o registro de comandos digitados</title>
<para>
Todos os comandos que digitamos em uma seção do shell são registrados no
arquivo <filename>~/.bash_history</filename>, as seguintes variáveis fazem seu
controle:
</para>
<itemizedlist>
<listitem>
<para>
<replaceable>HISTFILE</replaceable> - Nome do arquivo que armazenará o
histórico de comandos.  O padrão é <filename>~/.bash_history</filename>.  Caso
não seja especificado, os comandos não serão gravados após finalizar o shell.
</para>
</listitem>
<listitem>
<para>
<replaceable>HISTSIZE</replaceable> - Define o número de comandos que o arquivo
de histórico poderá armazenar, o padrão é 500.
</para>
</listitem>
<listitem>
<para>
<replaceable>HISTFILESIZE</replaceable> - Define o número máximo de linhas no
arquivo de histórico.
</para>
</listitem>
</itemizedlist>
<para>
Se você possui muitos usuários em seu sistema, é recomendado ajustar estas
variáveis como somente leitura para que o usuário não desative o logging por
qualquer motivo (veja <xref linkend="d-restr-bash-readonly"/>).
</para>
</section>

<section id="d-restr-bash-desshell"><title>Desabilitando serviços de shell para usuários</title>
<para>
Existem casos onde o usuário precisa estar cadastrado no sistema mas não
precisa ter acesso a uma conta de login válida (como um sistema servidor de
e-mail ou outros serviços).  Neste caso a desabilitação dos serviços de shell
aumentará um pouco a segurança do sistema, mesmo conseguindo acesso a
conta/senha estará impedido de entrar no sistema (pelo menos terá um pouco mais
dificuldade para conseguir isso).
</para>
<para>
Um programa que é muito usado para desabilitar o shell exibindo uma mensagem ao
usuário que fez a tentativa é o <command>falselogin</command>.  Ele deve ser
colocado como o "shell padrão" no arquivo <filename>/etc/passwd</filename> e
exibirá a mensagem contida no arquivo <filename>/etc/falselogin.conf</filename>
quando o login para aquele usuário for tentado.  Esta operação pode ser
facilitada usando a variável
<replaceable>DSHELL=/usr/bin/falselogin</replaceable> no arquivo
<filename>/etc/adduser.conf</filename>.
</para>
<para>
Uma forma alternativa de desativar o serviço de login de TODOS os usuários
(exceto o <literal>root</literal> e os já logados no sistema) é criar um
arquivo chamado <filename>/etc/nologin</filename> e colocando uma mensagem
dentro dele, que será exibida quando tentarem efetuar o login no sistema.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Tome cuidado ao usar esta alternativa,
este método deve ser usado somente em caso de <emphasis
role="strong">EMERGÊNCIA</emphasis>, as distribuições <command>Linux</command>
usam este método para bloquear o login de outros usuários durante o processo de
inicialização, removendo assim que o processo é terminado.  Esteja consciente
disso.
</para>
<para>
Em alguns casos, o uso do PAM pra desabilitar os serviços de login pode ser
mais adequado (veja <xref linkend="d-restr-pam-login"/>).
</para>
</section>

</section>

<section id="d-restr-pam"><title>Limitação de recursos usando PAM</title>
<para>
Plugglable Autentication Modules (Módulos de autenticação plugáveis) são um
conjunto de bibliotecas usadas para fazer autenticação, gerenciamento de
contas, controle de recursos dos usuários no sistema, em adição ao tradicional
sistema de acesso baseado em usuários/grupos.  Este recurso permite modificar a
forma que um aplicativo autentica e define recursos para o usuário sem
necessidade de recompilar o aplicativo principal.  Os recursos que desejamos
controlar restrições via PAM são especificados individualmente por serviços nos
arquivos correspondentes em <filename>/etc/pam.d</filename> e então os arquivos
correspondentes em <filename>/etc/security</filename> são usados para controlar
tais restrições.
</para>
<para>
Nesta seção assumirei explicações dirigidas aos recursos controlados pelos
arquivos em <filename>/etc/security</filename> A maioria das explicações são
baseadas em testes e nos próprios exemplos dos arquivos de configuração do PAM.
</para>
<section id="d-restr-pam-suporte"><title>Descobrindo se um determinado programa tem suporte a PAM</title>
<para>
Um método simples de se determinar se um programa binário possui suporte a PAM
é executando o comando:
</para>
<screen>
ldd [programa]
</screen>
<para>
Por exemplo:
</para>
<screen>
ldd /bin/login

libcrypt.so.1 => /lib/libcrypt.so.1 (0x4001c000)
libpam.so.0 => /lib/libpam.so.0 (0x40049000)
libpam_misc.so.0 => /lib/libpam_misc.so.0 (0x40051000)
libdl.so.2 => /lib/libdl.so.2 (0x40054000)
libc.so.6 => /lib/libc.so.6 (0x40058000)
/lib/ld-linux.so.2 => /lib/ld-linux.so.2 (0x40000000)
</screen>
<para>
Caso a biblioteca <filename>libpam</filename> for listada, o programa tem
suporte a PAM compilado.  Programas que não possuem suporte a PAM deverão ter o
código fonte modificado inserindo as funções para tratamento dos módulos de
autenticação.
</para>
</section>

<section id="d-restr-pam-policy"><title>Definindo uma política padrão restritiva</title>
<para>
A política padrão do PAM é especificado em
<filename>/etc/pam.d/other</filename> e define o que acontecerá caso nenhum dos
arquivos de controle de serviço em <filename>/etc/pam.d</filename> confiram com
o serviço em questão.  Normalmente o módulo <filename>pam_unix.so</filename> é
usado para fazer a política padrão, para deixar o sistema mais seguro, utilize
a seguinte configuração no arquivo <filename>/etc/pam.d/other</filename>:
</para>
<screen>
auth     required       /usr/lib/security/pam_warn.so
auth     required       /usr/lib/security/pam_deny.so
account  required       /usr/lib/security/pam_deny.so
password required       /usr/lib/security/pam_warn.so
password required       /usr/lib/security/pam_deny.so
session  required       /usr/lib/security/pam_deny.so
</screen>
<para>
O módulo <filename>pam_deny.so</filename> é responsável por fazer o bloqueio, e
o <filename>pam_warn</filename> envia avisos ao <command>syslog</command>
(facilidade <emphasis>auth</emphasis> nível <emphasis>notice</emphasis>) caso
serviços módulos PAM que necessitem do serviço de autenticação sejam bloqueados
(isto não é feito automaticamente pelo <filename>pam_deny.so</filename>).
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Esta configuração poderá causar
bloqueio em muitas coisas caso possua módulos de autenticação mau configurados.
Esteja certo de utilizar o módulo <filename>pam_warn.so</filename> (antes do
<filename>pam_deny.so</filename>) nas diretivas restritivas para entender qual
é o problema através da análise dos arquivos de logs.
</para>
<para>
Mais detalhes sobre a configuração de módulos de autenticação poderão ser
encontrados no endereço <ulink
url="ftp://ftp.us.kernel.org/pub/linux/libs/pam/Linux-PAM-html/pam.html">ftp://ftp.us.kernel.org/pub/linux/libs/pam/Linux-PAM-html/pam.html</ulink>
e <ulink
url="http://www.kernel.org/pub/linux/libs/pam/pre/doc/rfc86.0.txt.gz">http://www.kernel.org/pub/linux/libs/pam/pre/doc/rfc86.0.txt.gz</ulink>.
</para>
</section>

<section id="d-restr-pam-login"><title>Restringindo/Bloqueando o login</title>
<para>
Isto é controlado pelo arquivo <filename>/etc/security/access.conf</filename>.
O formato deste arquivo consistem em três campos separados por ":":
</para>
<itemizedlist>
<listitem>
<para>
<literal>Primeiro campo</literal> - Garante ("+") ou bloqueia ("-") o acesso
caso as condições nos outros campos confiram.
</para>
</listitem>
<listitem>
<para>
<literal>Segundo campo</literal> - Contém o login, grupo.  O formato
<emphasis>usuário@computador</emphasis> pode ser usado para conferir com
usuários que acessam de determinadas máquinas.  Caso existam mais de um
parâmetro, estes devem ser separados usando espaços.  As palavras chave
<literal>ALL</literal> (todos) e <literal>EXCEPT</literal> (exceção) e console
também podem ser usadas.
</para>
</listitem>
<listitem>
<para>
<literal>Terceiro campo</literal> - Lista de terminais (tty - na forma listada
pelo <command>ttyname</command>), nomes de máquinas, nomes de domínios
(começando com "."), endereços IP ou FQDN, porção de rede (finalizando com um
".").  As palavras chave <literal>ALL</literal> (todos) e
<literal>LOCAL</literal> (máquinas na mesma rede) também podem ser usadas.
</para>
</listitem>
</itemizedlist>
<para>
<emphasis role="strong">OBS1:</emphasis> - A configuração padrão do
<filename>access.conf</filename> é garantir o acesso a todos os usuários,
através de qualquer lugar (permissiva).
</para>
<para>
<emphasis role="strong">OBS2:</emphasis>: Mesmo se existir uma regra
autorizando o acesso ao usuário, as restantes serão verificadas em busca de uma
que bloqueie o acesso do usuário.  Se nenhuma regra conferir, o usuário terá
acesso garantido.
</para>
<para>
<emphasis role="strong">OBS3:</emphasis> - O nome de grupo somente é checado
quando nenhum nome de usuário confere com nenhum usuário logado no sistema.
</para>
<para>
<emphasis role="strong">OBS4:</emphasis> - Grupos/usuários NIS podem ser
especificados precedendo o nome do usuário ou grupo por uma "@".
</para>
<para>
Abaixo uma configuração restrita de
<filename>/etc/security/access.conf</filename>:
</para>
<screen>
#
# Desabilita o login de todos os usuários EXCETO o root no terminal tty1
-:ALL EXCEPT root:tty1

# Permite o login no console de todos os usuários especificados.
+:gleydson root:console

# Conexões vindas da rede *.debian.org e *.debian.org.br de usuários pertencendo 
# ao grupo operadores são consideradas seguras (exceto para o usuário root).
+:operadores EXCEPT root: .debian.org .debian.org.br

# Qualquer outra tentativa de acesso não definida acima é bloqueada imediatamente.
-: ALL: ALL
</screen>
</section>

<section id="d-restr-pam-root"><title>Restringindo o acesso a root no su</title>
<para>
A restrição de acesso a usuário <literal>root</literal> pelo PAM funciona
permitindo que somente alguns usuários que pertençam a um grupo criado pelo
administrador possam se tornar o superusuário usando o comando
<command>su</command>.  Esta restrição funciona até mesmo para os usuários que
possuem a senha correta de root, retornando uma mensagem de login ou senha
incorretos.  Isto é extremamente útil para restrições de acesso.
</para>
<para>
Um outro ponto positivo é caso ocorra um possível acesso não autorizado em seu
sistema ou um daemon seja corrompido e o atacante cair em um shell, ele não
poderá obter <literal>root</literal> na máquina pois o UID do daemon
provavelmente não terá autorização.  A distribuição <command>Debian</command>,
em especial, possui grupos e nomes de usuários organizados de forma a permitir
segurança e separação total caso utilize este mecanismo.
</para>
<para>
Este recurso se mostra bem eficiente para proteger a integridade da máquina até
mesmo no comprometimento de máquinas que possui a senha semelhante, somente se
usado em conjunto com as restrições de acesso de outros serviços remotos (como
o <command>ssh</command>, <command>ftp</command>, etc).  O guia Foca documenta
as formas de restrição e seu impacto na segurança da máquina nos capítulos do
nível Avançado (veja o índice para buscar o capítulo correspondente ao que
deseja proteger).
</para>
<para>
Para configurar esta restrição, siga os seguintes passos:
</para>
<itemizedlist>
<listitem>
<para>
Crie um grupo onde os usuários cadastrados terão acesso
<literal>root</literal>.  Por exemplo, <literal>usuarios-su</literal> (ou algo
mais discreto).
</para>
</listitem>
<listitem>
<para>
Edite o arquivo <filename>/etc/pam.d/su</filename>.  Insira a seguinte linha
(caso não existir) no arquivo de configuração:
</para>
<screen>
auth       required   pam_wheel.so group=usuarios-su
</screen>
<para>
O que ela faz é usar o módulo <filename>pam_wheel.so</filename> requerendo que
os usuários pertençam ao grupo <filename>usuarios-su</filename>.  Salve e saia
do editor.
</para>
</listitem>
<listitem>
<para>
Ainda como usuário <literal>root</literal>, adicione os usuários que terão
acesso a root no grupo <filename>usuarios-su</filename>.  Recomendo que
adicione seu usuário primeiro, principalmente se estiver fazendo acesso remoto,
pois se acontecer uma queda no link não ficará sem acesso root por cair na
restrição :-)
</para>
</listitem>
<listitem>
<para>
Tente pegar o <literal>root</literal> com outros usuários que não pertençam ao
grupo <filename>usuarios-su</filename> estes simplesmente terão o acesso
negado.
</para>
</listitem>
</itemizedlist>
</section>

<section id="d-restr-pam-time"><title>Restrições de serviços PAM baseados em dia/hora</title>
<para>
Estas restrições são controladas pelo arquivo
<filename>/etc/security/time.conf</filename>, a sintaxe deste arquivo é quatro
campos separados por ";":
</para>
<itemizedlist>
<listitem>
<para>
<literal>Primeiro campo</literal> - Nome do serviço PAM que será controlado (um
dos serviços contidos em <filename>/etc/pam.d</filename>).
</para>
</listitem>
<listitem>
<para>
<literal>Segundo campo</literal> - Lista de nomes de terminais que a regra que
aplicará.  O sinal "&" tem a função <emphasis>and</emphasis>, "|" tem a função
<emphasis>or</emphasis> e "!"  especifica uma exceção.
</para>
</listitem>
<listitem>
<para>
<literal>Terceiro campo</literal> - Nome de usuários afetados pela regra.  O
sinal "&" tem a função <emphasis>and</emphasis>, "|" tem a função
<emphasis>or</emphasis> e "!"  especifica uma exceção.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> O "*" poderá ser usado somente no
primeiro, segundo ou terceiro campo em uma mesma regra.
</para>
</listitem>
<listitem>
<para>
<literal>Quarto campo</literal> - DiaSemana/faixa-de-horas que a restrição se
aplicará.  O dia da semana é especificado em duas letras:
</para>
<itemizedlist>
<listitem>
<para>
<literal>Mo</literal> - Segunda-feira
</para>
</listitem>
<listitem>
<para>
<literal>Tu</literal> - Terça-feira
</para>
</listitem>
<listitem>
<para>
<literal>We</literal> - Quarta-feira
</para>
</listitem>
<listitem>
<para>
<literal>Th</literal> - Quinta-feira
</para>
</listitem>
<listitem>
<para>
<literal>Fr</literal> - Sexta-feira
</para>
</listitem>
<listitem>
<para>
<literal>Sa</literal> - Sábado
</para>
</listitem>
<listitem>
<para>
<literal>Su</literal> - Domingo
</para>
</listitem>
<listitem>
<para>
<literal>Wk</literal> - Todos os dias da semana
</para>
</listitem>
<listitem>
<para>
<literal>Wd</literal> - Somente sábado e domingo (fim de semana)
</para>
</listitem>
<listitem>
<para>
<literal>Al</literal> - Todos os dias
</para>
</listitem>
</itemizedlist>
<para>
O sinal "!"  especifica uma exceção.  A faixa de horas é especificada após o
dia no formato HHMM-HHMM.  Por exemplo:
</para>
<screen>
MoTuWe0000-2400 - Segundas, terças e quartas 
MoFrSu0800-1900- - Segundas, sextas e domingo das 08:00 da manha as 19:00 da noite.
FrFr0500-0600 - Não será realizada na sexta (especificações repetidas são anuladas) 
                de 05:00 as 06:00.
WkWe0731-1456 - Todos os dias da semana a partir de Quarta de 07:31 da manhã as 
                14:56 da tarde.
AlMo0000-2400 - Todos os dias da semana, exceto segunda-feira.
</screen>
</listitem>
</itemizedlist>
<para>
Por padrão o acesso é garantido a todos os usuários.  Abaixo um exemplo de
restrições usando o <filename>/etc/security/time.conf</filename>:
</para>
<screen>
# Bloqueia o login do usuário user1 ou user2 em qualquer tty, a restrição 
# durante todos os dias de 00:00 as 06:30
login;tty*;user1|user2;!Al0000-0630

# Bloqueia o acesso do usuário root ao serviço login nos terminais tty* 
# (e não nos terminais ttyp*) nos finais de semana.
login;tty* & !ttyp*;root;!Wd0000-2400

# O usuário 1 não poderá efetuar o login as terças feiras de 00:00 as 06:00
login;!tty*;user1;Tu0000-0600
</screen>
<para>
<emphasis role="strong">OBS1:</emphasis> Mesmo se existir uma regra autorizando
o acesso ao usuário, as restantes serão verificadas em busca de uma que
bloqueie o acesso do usuário.  Se nenhuma regra conferir, o usuário terá acesso
garantido.
</para>
<para>
<emphasis role="strong">OBS2:</emphasis> Quando as restrições de tempo são
ativadas no <filename>/etc/security/time.conf</filename>, o daemon
<command>logoutd</command> poderá ser ativado manualmente (através de
<filename>/etc/init.d/logoutd</filename>) para monitora as restrições neste
arquivo, forçando o logout de usuário de acordo com as configurações do
<filename>/etc/security/time.conf</filename>.  Isto ocorrerá automaticamente na
próxima vez que iniciar o sistema (a distribuição detecta a presença de
restrições de tempo no arquivo <filename>/etc/security/time.conf</filename>
para decidir se deve ou não carregar este daemon).
</para>
<para>
Quando não está em execução, os limites de tempo são verificados somente no
login do usuário, ele poderá ultrapassar este tempo sem ser desconectado do
sistema.
</para>
</section>

<section id="d-restr-pam-group"><title>Permitindo acesso a grupos extras</title>
<para>
Este recurso é controlado pelo arquivo
<filename>/etc/security/group.conf</filename>.  Este arquivo é composto por 5
campos separados por ";" (os 4 primeiros são os mesmos explicados em <xref
linkend="d-restr-pam-time"/>.  O 5o campo contém um ou mais grupos (separados
por espaços ou vírgulas) que serão adicionados aos grupos do usuário quando as
condições dos campos anteriores conferirem.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Se o usuário escrever um programa que
chama um interpretador de comandos e der a permissão SGID (chmod g+s programa),
ele terá acesso àquele grupo na hora que quiser.  Restrinja o uso de grupos
somente a usuários de confiança ou crie grupos específicos para evitar
problemas.
</para>
<para>
Exemplo de configuração do arquivo
<filename>/etc/security/group.conf</filename>:
</para>
<screen>
# Permite que o usuário gleydson tenha acesso ao grupo floppy efetuando o login
# entre 08:00 da manha e 19:00 da noite
login;tty*;gleydson;Al0800-1900;floppy

# Todos os usuários podem ter acesso ao grupo games e sound aos sábados e domingos
login;tty*;*;SaSu0000-2400;sound games

# Todos os usuários podem ter acesso ao grupo games e sound todos os dias 
# de 18:00 as 05:00 da manhã (fora do horário de expediente ;-)
login;tty*;*;Al1800-0500;sound,games

# Backups são permitidos fora do horário de expediente (para não sobrecarregar 
# a CPU e evitar o uso excessivo de disco). 
login;tty*;gleydson;Al1830-2400;backup
</screen>
<para>
<emphasis role="strong">OBS1:</emphasis> Mesmo que uma regra confira com o
usuário, as outras também serão verificadas para garantir acesso grupos extras.
</para>
<para>
<emphasis role="strong">OBS2:</emphasis> O padrão na maioria das distribuições
é limitar o número máximo de grupos do usuário para 32.  Caso precise aumentar
este limite, será necessário recompilar o kernel (e também a glibc, se
necessário) para aceitar um número maior modificando a variável
<replaceable>ngroup</replaceable>.
</para>
</section>

<section id="d-restr-pam-limits"><title>Limitação de recursos do shell</title>
<para>
Estas restrições são especificadas no arquivo
<filename>/etc/security/limits.conf</filename>.  Seu formato consiste em 4
campos separados por ou ou mais espaços:
</para>
<itemizedlist>
<listitem>
<para>
<literal>Primeiro campo</literal> - Especifica o nome de usuário, um nome de
grupo (@grupo) ou um "*" especificando que as restrições nos outros campos se
aplicam a todos os grupos e todos os usuários.
</para>
</listitem>
<listitem>
<para>
<literal>Segundo campo</literal> - Tipo de restrição:
</para>
<itemizedlist>
<listitem>
<para>
<literal>soft</literal> - Limite suave de bloqueio.
</para>
</listitem>
<listitem>
<para>
<literal>hard</literal> - Limite rígido de bloqueio.
</para>
</listitem>
<listitem>
<para>
<literal>-</literal> - Quando o tipo de restrição não se aplica ao Ítem que
deseja restringir o acesso.
</para>
</listitem>
</itemizedlist>
<para>
Quando somente o limite "hard" (rígido) é especificado, o limite suave assume o
mesmo valor.
</para>
</listitem>
<listitem>
<para>
<literal>Terceiro campo</literal> - Ítem que deseja restringir o acesso:
</para>
<itemizedlist>
<listitem>
<para>
<literal>core</literal> - Limita o tamanho do arquivo core (KB)
</para>
</listitem>
<listitem>
<para>
<literal>data</literal> - Tamanho máximo de arquivo de dados (KB)
</para>
</listitem>
<listitem>
<para>
<literal>fsize</literal> - Tamanho máximo de arquivo (KB)
</para>
</listitem>
<listitem>
<para>
<literal>memlock</literal> - Tamanho máximo do espaço de endereços bloqueado na
memória (KB)
</para>
</listitem>
<listitem>
<para>
<literal>nofile</literal> - Número máximo de arquivos abertos
</para>
</listitem>
<listitem>
<para>
<literal>rss</literal> - Tamanho máximo residente (KB)
</para>
</listitem>
<listitem>
<para>
<literal>stack</literal> - Tamanho máximo da pilha (KB)
</para>
</listitem>
<listitem>
<para>
<literal>cpu</literal> - Tempo máximo de uso da CPU (MIN)
</para>
</listitem>
<listitem>
<para>
<literal>nproc</literal> - Número máximo de processos
</para>
</listitem>
<listitem>
<para>
<literal>as</literal> - Limite de espaço de endereços
</para>
</listitem>
<listitem>
<para>
<literal>maxlogins</literal> - Número máximo de logins
</para>
</listitem>
<listitem>
<para>
<literal>priority</literal> - Prioridade de execução de processos de usuários
</para>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<para>
<literal>Quarto campo</literal> - Especifica o valor do campo anterior
</para>
</listitem>
</itemizedlist>
<para>
Os limites aplicados ao usuário podem ser visualizados através do comando
<literal>ulimit -S -a</literal> (para listar limites suaves - soft) e
<literal>ulimit -H -a</literal> (para listar limites rígidos - hard).  Caso o
parâmetro <emphasis>-S</emphasis> ou <emphasis>-H</emphasis> sejam omitidos, os
limites listados serão os suaves (soft).  Um exemplo de
<filename>/etc/security/limits.conf</filename> (retirado da distribuição
<command>Debian GNU/Linux</command>:
</para>
<screen>
*               soft    core            0
*               hard    rss             10000
@student        hard    nproc           20
@faculty        soft    nproc           20
@faculty        hard    nproc           50
ftp             hard    nproc           0
@student        -       maxlogins       4
gleydson        -       maxlogins       2
</screen>
<para>
<emphasis role="strong">OBS:</emphasis> Estas permissões passam a ter efeito no
momento que o usuário se conecta ao sistema, e não quando elas são modificadas
no arquivo <filename>/etc/security/limits.conf</filename>.
</para>
</section>

</section>

<section id="d-restr-grupos"><title>Restrições de acesso a programas/diretórios/arquivos usando grupos</title>
<para>
Usuários podem ter o acesso liberado a diretórios/arquivos execução de
programas de acordo com o grupo que pertencem.  Este é um recurso valioso na
administração de sistemas <command>Unix</command> que se bem usado, aumenta as
restrições de acesso e segurança no acesso/utilização de programas em um
ambiente de trabalho.  Usuários de sistema tendem a usar o usuário
<literal>root</literal> para fazer tarefas como conexão com internet,
utilização da placa de som, modem, etc.  e as vezes nem sabem que isso pode ser
feito através do mesmo usuário adicionando este a um grupo específico.
</para>
<para>
Esta tarefa pode ser feita com o comando <literal>adduser usuário
grupo</literal> ou editando manualmente os arquivos
<filename>/etc/group</filename> e <filename>/etc/gshadow</filename>.  Podemos
ter as seguintes situações facilitadas com o uso de grupos:
</para>
<itemizedlist>
<listitem>
<para>
Usar a placa de som.  Os dispositivos usados pela placa de som como
<filename>/dev/audio</filename>, <filename>/dev/dsp</filename>,
<filename>/dev/sndstat</filename>, etc.  normalmente tem permissão
leitura/gravação para o usuário <literal>root</literal> e grupo
<literal>audio</literal> (cheque com o comando <literal>ls -la
/dev/audio</literal>).  Para autorizar determinados usuários usar a placa de
som basta adiciona-los neste grupo: <literal>adduser usuario audio</literal>.
</para>
</listitem>
<listitem>
<para>
Conectar a Internet.  Normalmente o utilitário ppp tem as permissões SUID
<literal>root</literal> e grupo <literal>dip</literal>.  Adicionamos o usuário
a este grupo: <literal>adduser usuario dip</literal>.  Agora ele poderá
conectar/desconectar a internet sem a intervenção do usuário
<literal>root</literal>.
</para>
<para>
<emphasis role="strong">OBS</emphasis> Certamente o usuário terá acesso aos
arquivos de configuração da discagem do <command>ppp</command> e
conseqüentemente a senha de conexão internet, e esta senha é a mesma usada no
e-mail primário do provedor (com o mesmo nome da conta).  Esta mesma situação
pode acontecer com outros programas que autorize o acesso a grupos, é
importante que conheça bem as permissões do programa e entender se existem
riscos.
</para>
</listitem>
<listitem>
<para>
Utilizar o modem.  Um bom grupo para permitir a utilização do modem é
<literal>dialout</literal>.  O dispositivo utilizado pelo modem (não seu link)
deve ter permissões leitura/gravação para o usuário <literal>root</literal> e
grupo <literal>dialout</literal>.  Cadastrando o usuário neste grupo autorizará
a utilização do modem: <literal>adduser usuario dialout</literal>.
</para>
</listitem>
<listitem>
<para>
Permitir que diversos usuários compartilhem um mesmo diretório.  Isto é útil
quando muitas pessoas estão desenvolvendo um mesmo projeto.  Siga estes passos:
</para>
<itemizedlist>
<listitem>
<para>
Crie um novo grupo no sistema: <command>groupadd gp1</command>, a opção
<emphasis>-g</emphasis> permite selecionar manualmente a GID.  Opcionalmente
você poderá usar um grupo já existente no sistema (veja o arquivo
<filename>/etc/group</filename>).
</para>
</listitem>
<listitem>
<para>
Crie o diretório que será usado para armazenar os arquivos deste grupo de
usuários: <filename>mkdir projeto1</filename>).
</para>
</listitem>
<listitem>
<para>
Mude o dono/grupo do diretório: <literal>chown root.gp1 projeto1/</literal>
</para>
</listitem>
<listitem>
<para>
De permissões de leitura/gravação para o dono/grupo do diretório, vamos também
incluir a permissão SGID para que todos os arquivos criados dentro deste
diretório pertençam ao mesmo grupo e não ao grupo primário do usuário, assim
todos os usuários terão acesso: <literal>chmod 2770 projeto1</literal>
</para>
</listitem>
<listitem>
<para>
Agora cadastre os usuários que deverão ter acesso ao diretório
<filename>projeto1/</filename> no grupo <literal>gp1</literal>, somente estes
usuários e o root terão acesso ao diretório (permissões 2770).
</para>
</listitem>
<listitem>
<para>
É interessante também mudar a "umask" do usuário de <literal>022</literal> para
<literal>002</literal> (ou equivalente) para que os novos arquivos criados
tenham permissão de leitura/gravação para o grupo <literal>gp1</literal>.  Caso
contrário, lembre-se de modificar as permissões de seus arquivos manualmente.
Um ótimo comando para fazer isso (sem afetar diretórios) é: <literal>find .
-type f -user usuario1 -exec chmod 0660 \{\} \;</literal>.  Este comando parece
estranho mas é excelente!  um <literal>chmod -R 0660</literal> afetaria até os
diretórios, imagine o caos.
</para>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<para>
A maioria das distribuições <command>Linux</command> vem com uma boa política
de grupos para permitir um controle eficaz de recurso.  Se você quer saber
quais arquivos em seu sistema pertencem a determinado grupo (útil para saber o
que o usuário terá acesso se adiciona-lo àquele grupo) execute o comando:
</para>
<screen>
find / -group nome_do_grupo
</screen>
</section>

<section id="d-restr-sudo"><title>Dando poderes de root para executar determinados programas</title>
<para>
A ferramenta ideal para isto é o <command>sudo</command>.  Através dela é
possível permitir um usuário comum executar um comando como
<command>root</command> e registrar quando isto foi feito.  É possível
selecionar os usuários/grupos que terão acesso e quais aplicativos que poderão
ser usados, estas configurações são feitas no arquivo
<filename>/etc/sudoers</filename>.
</para>
<para>
Por exemplo, para o usuário "john" usar o comando <literal>shutdown</literal>
para desligar o computador: <literal>sudo shutdown -h now</literal>.
</para>
<para>
O <command>sudo</command> é um programa muito completo, tomaria muitos
Kilobytes neste guia.  Recomendo dar uma lida na página de manual para entender
como as variáveis do arquivo de configuração funcionam.  Mesmo assim aqui vai
um exemplo simples deste arquivo para iniciar rapidamente o uso do
<command>sudo</command>:
</para>
<screen>
# arquivo sudoers.
#
# Edite este arquivo com o comando 'visudo' como root 
# 
#

# Especificação de máquinas. O primeiro campo (Host_Alias) diz que a variável 
# LOCALSERVER será um nome/endereço de máquina
Host_Alias	LOCALSERVER=192.168.0.1

# Especificação de usuários. O primeiro campo (User_Alias) diz que a variável
# NETMASTERS armazenará nomes de usuários
User_Alias	NETMASTERS=gleydson, goodboy

# Comandos. O primeiro campo (Cmnd_Alias) diz que a variável 
# C_REDE contém comandos do sistema. Mais de um parâmetro
# deve ser separado por vírgulas
Cmnd_Alias	C_REDE=/sbin/ipchains, /sbin/iptables

# Padrões que se aplicam aos usuários da variável NETMASTERS. O parâmetro
# mail_always sempre envia um e-mail ao root avisando sobre o uso do 
# sudo
Defaults:NETMASTERS	mail_always

# As linha que começam com o nome de usuário ou variável "User_Alias" 
# definem o acesso aos recursos. O primeiro campo é o usuário, o segundo
# o endereço de acesso (opcionalmente seguido de um sinal "=" para 
# especificar opções adicionais) o terceiro o comando ou lista de comandos
#
# O usuário root não tem restrições
root	ALL=(ALL) ALL

# Permite que os usuários especificados na variável NETMASTERS 
# acessando dos locais em LOCALSERVER utilizem os comandos 
# em C_REDE (sem fornecer senha). 
NETMASTERS	LOCALSERVER=NOPASSWD: C_REDE
</screen>
<para>
Edite este arquivo com o comando <command>visudo</command>, ele faz algumas
checagens para detectar problemas de configuração.  Para listar os comandos
disponíveis para o usuário no <command>sudo</command>, utilize a opção
<literal>-l</literal>, ex: <literal>sudo -l</literal>.
</para>
</section>

<section id="d-restr-su"><title>Restringindo o comando <command>su</command></title>
<para>
Restrições de acesso através de grupos, bloqueio de acesso, acesso direto sem
senha, etc.  podem ser aplicados ao sudo via seu arquivo de configuração PAM
<filename>/etc/pam.d/su</filename>.  Abaixo um exemplo explicativo deste
arquivo:
</para>
<screen>
# A configuração abaixo requer que o usuário seja membro do 
# grupo adm para usar o 'su'. 
# auth       required   pam_wheel.so group=adm

# Membros do grupo acima não precisam fornecer senha, temos confiança neles.
# auth       sufficient pam_wheel.so trust

# Usuário que pertencem ao grupo "nosu" nunca deverão ter acesso ao 'su'
# auth       required   pam_wheel.so deny group=nosu

# O root não precisa fornecer senha ao 'su'
auth       sufficient pam_rootok.so

# Ativa as restrições PAM de /etc/security/limits.conf
session    required   pam_limits.so

# Isto ativa as restrições PAM de /etc/security/time.conf no 
# comando 'su'
account    requisite  pam_time.so

# Módulos padrões de autenticação Unix
auth       required   pam_unix.so
account    required   pam_unix.so
session    required   pam_unix.so
</screen>
</section>

<section id="d-restr-identd"><title>Restrições baseadas em usuário/IP</title>
<para>
O serviço <command>identd</command> permite identificar os usuários que estão
realizando conexões TCP, adicionalmente esta característica é usada por
programas para fazer restrições para usuários em adição ao endereço de
origem/destino.  A sintaxe usada nas diretivas de acesso é especificada na
forma <emphasis>usuário@endereço</emphasis>.  O <xref linkend="ident"/> explica
a configuração/utilização/vulnerabilidades e recomendações sobre este serviço.
</para>
<para>
Diversos programas que possuem controle de acesso baseado em IP's/hosts aceitam
esta especificação, como o <command>exim</command>, <command>ircd</command>, e
o conhecido <command>tcpd</command>.
</para>
<para>
Segue um exemplo da utilização do <command>identd</command> com o arquivo
<filename>hosts.allow</filename>:
</para>
<screen>
# Permite o acesso ao serviço de telnet somente ao usuário gleydson conectando
# a partir da máquina com IP 192.168.1.1
in.telnetd: gleydson@192.168.1.1

# Permite o acesso ao serviço ftp somente ao usuário gleydson conectando de 
# qualquer máquina da rede 192.168.1.*
in.ftpd: gleydson@192.168.1.
</screen>
<para>
Note que a utilização do <command>identd</command> torna a utilização do
serviço um pouco mais restrita, somente conhecendo os "logins" de quem tem
acesso ao serviço, um cracker conseguirá ter acesso ao mesmo serviço naquele
sistema (este é um dos motivos que é recomendado sempre divulgar o mínimo
detalhes possíveis sobre o sistema para minimizar riscos de ataques).
</para>
<para>
Veja mais detalhes sobre o uso do <command>identd</command> em <xref
linkend="ident"/>.
</para>
</section>

<section id="d-restr-ipmac"><title>Restrições por MAC Address/IP</title>
<para>
Esta proteção oferece uma barreira maior se segurança contra IPs spoofing
evitando que pessoas mal intencionadas façam um IP spoofing da máquina para
obter acessos privilegiados que somente o detentor original do MAC/IP teria.
Recomendo não levar em consideração que isto seja a solução definitiva contra
IP spoofing, pois é possível falsificar o MAC address de uma interface para
tomar outra identidade.
</para>
<para>
Este método poderá ser aplicado para fornecer um maior laço de confiança por
hardware entre as máquinas que compõem uma rede de servidores.  Ele também
evita mesmo que uma máquina configurada de forma errônea tenha acesso indevido
ao servidor ou em uma situação extrema, se torne o gateway da rede.
</para>
<para>
Para restringir as conexões para uma máquina <command>Linux</command> por MAC
address, utilize o firewall <command>iptables</command>.  Com ele será
permitido fazer a restrição por serviços, criando uma barreira bastante chata
para crackers tentarem se conectar a um serviço.  Como referência, leia a seção
<xref linkend="fw-iptables-mod-mac"/>.
</para>
<para>
Outra situação é a restrição por par MAC/IP usando o próprio cache arp da
máquina, usando entradas estáticas de endereços.  Um exemplo deste uso é quando
você é extremamente paranóico ou quando uma rede que utiliza algum método de
autenticação baseado no <filename>rhosts</filename> (como é o caso do sistema
de backup do <command>Amanda</command>), então é importante dizer para as
máquinas servidoras, qual o MAC address/IP privilegiado que terá o acesso ao
usuário para conexão sem senha.
</para>
<para>
O local padronizado para definir um MAC estático (e bastante desconhecido da
maioria dos administradores de sistemas) é o <filename>/etc/ethers</filename>.
O formato deste arquivo é o <literal>MAC Address</literal> e
<literal>IP</literal> separados por espaço, cada linha com uma nova entrada de
MAC Address.  Veja o exemplo:
</para>
<screen>
00:03:47:AA:AA:AB       www.focalinux.org.br
00:03:47:BB:AA:BA       www2.focalinux.org.br
00:03:47:BB:AA:BB       192.168.0.1
</screen>
<para>
Caso não conheça o formato do endereço de MAC Address, os três primeiros 3
campos definem o fabricante da placa de rede, e os 3 últimos é uma
identificação única do fabricante para a Placa, ou seja, NENHUMA placa de rede
fabricada tem o mesmo MAC Address físico.
</para>
<para>
Para que o comando <command>arp</command> crie as entradas estáticas no seu
cache ARP, será necessário executar o comando <literal>arp -f
/etc/ethers</literal>.  Este comando poderá ser colocado em algum script ou
diretório de inicialização de sua distribuição para que seja executado
automaticamente (como por exemplo, no <filename>/etc/rc.boot</filename> da
<command>Debian</command>).  Digitando <literal>arp</literal> você verá as
linhas definidas no arquivo <filename>/etc/ethers</filename> marcadas com as
opção (flag) <literal>M</literal> (manual/permanente).  Outra forma de
verificar, é usando o <literal>arp -a máquina</literal> ou somente <literal>arp
-a</literal>.  As máquinas especificadas estaticamente (manualmente) terão o
nome <literal>PERM</literal> listados (cache arp permanente).
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Como deve ter notado, a restrição por
MAC Address implica em um aumento no trabalho de gerenciamento das
configurações.  Assim, planeje-se para que esta tarefa não seja desgastante,
crie programas para realizar atualizações dinâmicas estudando a estrutura de
sua rede e como suas máquinas se comunicam para não ter problemas obscuros
quando tiver que fazer uma simples modificação em uma interface de rede :)
</para>
<para>
Uma boa configuração restritiva requer análise sobre os impactos na rede.
</para>
</section>

<section id="d-restr-inetd"><title>Desabilitando serviços não usados no Inetd</title>
<para>
Desative todos os serviços que não serão utilizados no arquivo
<filename>/etc/inetd.conf</filename>, isto diminui bastante as possibilidades
de ataques em seu sistema.  Os nomes de serviços são os parâmetros
especificados na primeira coluna do arquivo
<filename>/etc/inetd.conf</filename> (por exemplo, talk, ircd, pop3, auth,
smtp).
</para>
<para>
Para desativar serviços neste arquivo, ponha o símbolo "#" no inicio das linhas
que deseja comentar e execute um <literal>killall -HUP inetd</literal>.
Alternativamente, o comando <literal>update-inetd</literal> pode ser usado para
facilitar esta tarefa:
</para>
<screen>
update-inetd --disable finger,talk,time,daytime

update-inetd --disable
</screen>
<para>
Este comando envia automaticamente o sinal de reinicio (HUP) ao
<command>inetd</command>.  O serviço poderá ser novamente ativado substituindo
a opção <emphasis>--disable</emphasis> por <emphasis>--enable</emphasis> ou
retirando o trecho "#&lt;off&gt;#" no começo da linha do serviço do
<filename>/etc/inetd.conf</filename>.
</para>
</section>

<section id="d-restr-authinseg"><title>Evitando o uso de <filename>hosts.equiv</filename> e <filename>.rhosts</filename></title>
<para>
O arquivo <filename>hosts.equiv</filename> contém uma lista de usuários
autorizados/desautorizados que podem fazer uso dos serviços "r*" sem fornecer
uma senha (como <command>rsh</command>, <command>rcp</command>,
<command>rexec</command>, etc) , veja <xref linkend="rede-seg-tcpd-e"/>.  É
muito fácil falsificar um nome de usuário para obter acesso aos privilégios de
outro usuário usando este recurso.
</para>
<para>
Os arquivos <filename>~/.rhosts</filename>, <filename>~/.shosts</filename> tem
o funcionamento parecido com o <filename>hosts.equiv</filename> mas contém
somente dois campos, o primeiro especificando o nome do computador (FQDN) e o
segundo o nome do usuário que tem permissão de acesso sem fornecer senha.  Ele
garantirá este acesso ao usuário e máquina remota especificada neste arquivo.
Se for definido somente o nome do computador, o nome de usuário deverá ser o
mesmo do local para que o acesso sem senha seja garantido.  É recomendável
restringir o acesso a estes arquivos somente ao usuário/grupo quando for
realmente necessário.  Um exemplo de <filename>~/.rhosts</filename>:
</para>
<screen>
maquina1.dominio.com.br usuario1
maquina2.dominio.com.br usuario2
</screen>
<para>
O uso destes dois mecanismos e dos serviços "r*" são desencorajados!  (o último
por usar transferência de dados não criptografadas).  Veja <xref
linkend="ssh"/> para uma alternativa melhor.  Utilize estes dois mecanismos
somente se deseja facilidade no gerenciamento e se sua rede seja absolutamente
confiável e a segurança de dados não seja prioridade pra você...
</para>
</section>

<section id="d-restr-shutdown"><title>Restringindo o uso do shutdown</title>
<para>
Por padrão todos que tem acesso ao console do sistema podem efetuar o reinicio
do computador pressionando CTRL+ALT+DEL.  Estas teclas de combinação são
definidas pela linha
</para>
<screen>
ca:12345:ctrlaltdel:/sbin/shutdown -r now
</screen>
<para>
do arquivo <filename>/etc/inittab</filename>.  A opção <emphasis>-a</emphasis>
(access) do <command>shutdown</command> restringe isto, permitindo somente o
reinicio do sistema caso um dos usuários cadastrados no arquivo
<filename>/etc/shutdown.allow</filename> estejam logados no console.  Caso
nenhum usuário autorizado esteja logado, a mensagem <literal>shutdown: no
authorized users logged in</literal> é exibida no console local.
</para>
<para>
O arquivo <filename>/etc/shutdown.allow</filename> deve conter um usuário por
linha e 32 no máximo.
</para>
<para>
A mesma linha do <filename>/etc/inittab</filename> pode ser modificada para a
seguinte:
</para>
<screen>
ca:12345:ctrlaltdel:/sbin/shutdown -a -t5 -r now
</screen>
<para>
<emphasis role="strong">OBS:</emphasis> Se a opção <emphasis>-a</emphasis> seja
especificada e o arquivo <filename>/etc/shutdown.allow</filename> não existe, a
opção <emphasis>-a</emphasis> é ignorada.
</para>
</section>

<section id="d-restr-proc"><title>Restringindo o acesso ao sistema de arquivos /proc</title>
<para>
O patch <emphasis>restricted proc fs</emphasis> é um dos melhores para realizar
esta tarefa.  Restringindo o acesso ao sistema de arquivos
<filename>/proc</filename> evita que o usuário normal tenha acesso aos detalhes
sobre processos de outros (com <literal>ps aux</literal>) ou acesso a detalhes
de processos de outros usuários existentes nos subdiretórios numéricos
(equivalentes a PID) em <filename>/proc</filename>.  Abaixo algumas
características do patch <emphasis>restricted proc fs</emphasis>:
</para>
<itemizedlist>
<listitem>
<para>
É pequeno, rápido e faz poucas modificações no fonte do kernel.
</para>
</listitem>
<listitem>
<para>
Seu método de funcionamento é baseado nas restrições de dono/grupo (nativas de
ambiente <command>Unix</command>).
</para>
</listitem>
<listitem>
<para>
Restringe a visualização de processos só dos usuários.  Adicionalmente será
especificada uma GID para o diretório <filename>/proc</filename>, qualquer
usuário que pertença ao grupo especificado poderá visualizar todos os processos
e entrar em qualquer diretório do kernel (sem restrições, como se não tivesse o
patch).
</para>
</listitem>
<listitem>
<para>
Muito estável e confiável.
</para>
</listitem>
</itemizedlist>
<para>
Este patch deve ser baixado de <ulink
url="http://noc.res.cmu.edu/proc">http://noc.res.cmu.edu/proc</ulink>, existem
versões para os kernels da série 2.2 e 2.4, baixe e aplique o patch, na
configuração do kernel ative a opção <literal>Restricted Proc fs
support</literal>.  Compile e instale seu kernel.
</para>
<para>
No arquivo <filename>/etc/fstab</filename> inclua um grupo para a montagem do
sistema de arquivos <filename>/proc</filename> (vamos usar o grupo
<literal>adm</literal> com a GID 4):
</para>
<screen>
# /etc/fstab: informações estáticas do sistemas de arquivos.
#
# &lt;Sist. Arq.&gt;    &lt;Ponto Mont.&gt;  &lt;tipo&gt;  &lt;opções&gt;       &lt;dump&gt; &lt;passo&gt;
  proc            /proc          proc    defaults,gid=4   0       0
</screen>
<para>
Após reiniciar o sistema, execute o comando <literal>ls -lad /proc</literal>
note que o grupo do diretório <filename>/proc</filename> será modificado para
<literal>adm</literal>.  Agora entre como um usuário e execute um <literal>ps
aux</literal>, somente seus processos serão listados.  Para autorizar um
usuário específico ver todos os processos (ter acesso novamente ao diretório
<filename>/proc</filename>), inclua este no grupo que usou no arquivo
<filename>/etc/fstab</filename>:
</para>
<screen>
adduser usuario adm
</screen>
<para>
Após efetuar o usuário já estará pertencendo ao grupo <literal>adm</literal>
(confira digitando <literal>groups</literal>), e poderá ver novamente os
processos de todos os usuários com o comando <literal>ps aux</literal>.
</para>
<para>
<emphasis role="strong">OBS1:</emphasis> Incluir um usuário no grupo
<literal>adm</literal> É PERIGOSO, porque este usuário poderá ter acesso a
arquivo/diretórios que pertençam a este grupo, como os arquivos/diretórios em
<filename>/var/log</filename>.  Se esta não é sua intenção, crie um grupo
independente como <literal>restrproc</literal> para controlar quem terá acesso
ao diretório <filename>/proc</filename>: <literal>addgroup restrproc</literal>.
</para>
<para>
<emphasis role="strong">OBS2:</emphasis> Se a opção <literal>gid</literal> não
for especificada para a montagem de <filename>/proc</filename> no
<filename>/etc/fstab</filename>, o grupo <literal>root</literal> será usado
como padrão.  NUNCA adicione usuários ao grupo <literal>root</literal>, use o
método da observação acima para permitir outros usuários ver todos os processos
em execução.
</para>
<para>
<emphasis role="strong">OBS3</emphasis> Caso o servidor
<command>identd</command> esteja sendo usado na máquina servidora, será
necessário roda-lo com a mesma GID do diretório <filename>/proc</filename> para
que continue funcionando.  Se ele é executado como daemon, adicione a opção
<emphasis>-g GRUPO</emphasis> no script que inicia o serviço em
<filename>/etc/init.d</filename> e reinicie o daemon.  Caso ele seja iniciado
via inetd, faça a seguinte modificação no arquivo
<filename>/etc/inetd.conf</filename> (assumindo o uso do
<command>oidentd</command>):
</para>
<screen>
#:INFO: Info services
auth		stream	tcp	nowait.40	nobody.adm	/usr/sbin/oidentd oidend -q -i -t 40
</screen>
<para>
Veja <xref linkend="ident"/> para detalhes sobre este serviço.
</para>
</section>

<section id="d-restr-quotas"><title>Limitando o uso de espaço em disco (quotas)</title>
<para>
O sistema de <command>quotas</command> é usado para limitar o espaço em disco
disponível a usuários/grupo.  O uso de partições independentes para o diretório
<filename>/home</filename> e outros montados separadamente não é muito eficaz
porque muitos usuários serão prejudicados se a partição for totalmente ocupada
e alguns possuem requerimentos de uso maior do que outros.
</para>
<para>
O suporte a <emphasis>Quotas</emphasis> deve estar compilado no kernel (seção
<emphasis>FileSystems</emphasis>) e o sistema de arquivos deverá ser do tipo
<emphasis>ext2</emphasis> ou <emphasis>XFS</emphasis> para funcionar.
</para>
<section id="d-restr-quotas-install"><title>Instalando o sistema de quotas</title>
<para>
Abaixo o passo a passo para a instalação de quotas em seu sistema:
</para>
<orderedlist numeration="arabic">
<listitem>
<para>
Recompile seu kernel com suporte a quota.  Habilite a opção "Quota support" na
seção "FileSystems" na configuração de recursos do seu kernel.
</para>
</listitem>
<listitem>
<para>
Instale o pacote <systemitem role="package">quota</systemitem> no sistema
(<literal>apt-get install quota</literal>).
</para>
</listitem>
<listitem>
<para>
Habilite a quota para os sistemas de arquivos que deseja restringir no arquivo
<filename>/etc/fstab</filename>:
</para>
<screen>
/dev/hda1    /boot ext2     defaults                   1  1
/dev/hda3    /     ext2     defaults,usrquota          1  2
/dev/hda4    /usr  ext2     defaults,grpquota          1  3
/dev/hda5    /pub  ext2     defaults,usrquota,grpquota 1  4
</screen>
<para>
O sistema de arquivos <filename>/dev/hda1</filename> não terá suporte a quota,
<filename>/dev/hda3</filename> terá suporte a quotas de usuários
(<emphasis>usrquota</emphasis>), <filename>/dev/hda4</filename> terá suporte a
quotas de grupos (<emphasis>grpquota</emphasis>) e
<filename>/dev/hda5</filename> terá suporte a ambos.  Por padrão é assumido que
os arquivos de controle de quota estão localizados no ponto de montagem da
partição com os nomes <filename>quota.user</filename> e
<filename>quota.group</filename>.
</para>
</listitem>
<listitem>
<para>
Agora será necessário criar os arquivos <filename>quota.user</filename> e
<filename>quota.group</filename> no ponto de montagem de cada partição
<emphasis>ext2</emphasis> acima que utilizará o recurso de quotas.  O arquivo
<filename>quota.user</filename> controla as quotas de usuários e
<filename>quota.group</filename> controla as quotas de grupos.
</para>
<itemizedlist>
<listitem>
<para>
Crie um arquivo vazio <filename>quota.user</filename> em <filename>/</filename>
(terá suporte somente a quota de usuários, veja a opção de montagem no
<filename>/etc/fstab</filename>): <literal>touch /quota.user</literal> ou
<literal>echo -n &gt;/quota.user</literal>.
</para>
</listitem>
<listitem>
<para>
Crie um arquivo vazio <filename>quota.group</filename> em
<filename>/usr</filename> (terá suporte somente a quota de grupos):
<literal>touch /usr/quota.group</literal> ou <literal>echo -n
&gt;/usr/quota.group</literal>.
</para>
</listitem>
<listitem>
<para>
Crie um arquivo vazio <filename>quota.user</filename> e
<filename>quota.group</filename> em <filename>/pub</filename> (este sistema de
arquivos tem suporte a ambos os tipos de quota): <literal>touch /pub/quota.user
/pub/quota.group</literal>.
</para>
</listitem>
</itemizedlist>
<para>
Por motivos de segurança, as permissões dos arquivos de controle de quota
<filename>quota.user</filename> e <filename>quota.group</filename> devem ser
leitura/gravação ao usuário <literal>root</literal> e sem permissões para
grupo/outros usuários: <literal>chmod 0600 /quota.user /quota.group</literal>.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Se deseja utilizar o quota versão 1,
certifique-se que não existem os arquivos chamados
<filename>aquota.user</filename> e <filename>aquota.group</filename> no
diretório raíz de sua partição.  Se eles estiverem disponíveis, os utilitários
de quota utilizarão esta versão como padrão, atualmente o kernel 2.4 possui
somente suporte a quota versão 1.
</para>
<para>
A versão 2 do quota checa corrompimento dos arquivos de dados de quota e
trabalha mais rápido em partições grandes.  São necessários patches da série
"ac" (Alan Cox) para usar a versão 2 do quota.
</para>
</listitem>
<listitem>
<para>
Entre em modo monousuário <literal>init 1</literal>, desmonte os sistemas de
arquivos que utilizarão a quota e monte-os novamente (isto serve para ativar as
opções de quota).  Alternativamente, execute <literal>umount -a</literal> (para
desmontar todos os sistemas de arquivos) e <literal>mount -a</literal> para
remontar todos.
</para>
<para>
Se você ativou as quotas para o sistema de arquivos <filename>/</filename>
(como em nosso exemplo) será necessário reiniciar o sistema.
</para>
</listitem>
<listitem>
<para>
O próximo passo é scanear o disco para criar os dados para as partições com
suporte a quota (ativadas no <filename>/etc/fstab</filename>):
</para>
<screen>
 quotacheck -augv
</screen>
<para>
O parâmetro <emphasis>-a</emphasis> diz para checar todas as partições com
suporte a quota no arquivo <filename>/etc/mtab</filename>,
<emphasis>-u</emphasis> para checar quotas de usuários, <emphasis>-g</emphasis>
para checar grupos e <emphasis>-v</emphasis> para mostrar o progresso da
checagem da partição.
</para>
<para>
Na primeira execução é mostrado uma mensagem de erro de arquivo
<filename>quota.user</filename>/<filename>quota.group</filename> corrompido,
mas isto é normal porque o arquivo anterior tem tamanho zero.  Estes nomes
também servem para o <command>quotacheck</command> "auto-detectar" a versão do
sistema de quota usada no sistema de arquivos.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Certamente será necessário "forçar" a
remontagem como somente leitura do sistema de arquivos <filename>/</filename>
com a opção <emphasis>-m</emphasis> para o <command>quotacheck</command> criar
as configurações de quota nesta partição.
</para>
</listitem>
<listitem>
<para>
Agora resta ativar o suporte as quotas de disco em todas as partições
(<emphasis>-a</emphasis>) com recurso de quota especificado (no
<filename>/etc/mtab</filename>):
</para>
<screen>
 quotaon -augv
</screen>
<para>
As opções possuem o mesmo significado do comando <command>quotacheck</command>.
O utilitário <command>quotaoff</command> serve para desativar quotas de
usuários e usa as mesmas opções do <command>quotaon</command>.  Estes três
utilitários somente podem ser usados pelo usuário <literal>root</literal>.  As
opções de quota podem ser especificadas independente para cada sistema de
arquivos:
</para>
<screen>
# Ativa o suporte a quota em /pub (somente grupos de usuários no momento).
quotaon -gv /pub

# Ativa as quotas de usuários em /pub
quotaon -uv /pub

# Desativa as quotas de grupos em /pub (deixando somente a de usuários ativa)
quotaoff -gv /pub
</screen>
</listitem>
</orderedlist>
<para>
A atualização de quotas durante a gravação/exclusão de arquivos é feita
automaticamente.  O utilitário <command>quotacheck</command> deverá ser
executado sempre que o sistema de quotas for desativado (por não haver
atualização automática dos dados de uso de disco) ou quando ocorrerem falhas de
disco.
</para>
<para>
Na distribuição <command>Debian</command> o <command>quotacheck</command> é
disparado sempre que necessário após as situações de checagem de disco.  As
quotas de todas as partições também são ativadas automaticamente pelo script
<filename>/etc/init.d/quota</filename> e
<filename>/etc/init.d/quotarpc</filename>.
</para>
<para>
Em sistemas que utilizam NFS e possuem sistemas de arquivos exportados em
<filename>/etc/exports</filename>, o daemon <command>rpc.rquotad</command>
deverá ser carregado.  Sua função é fornecer os detalhes de
<command>quota</command> dos sistemas de arquivos locais exportados para as
máquinas clientes.
</para>
</section>

<section id="d-restr-quotas-editando"><title>Editando quotas de usuários/grupos</title>
<para>
O programa <command>edquota</command> é usado pelo <literal>root</literal> para
editar as quotas de usuários/grupos.  Por padrão, todos os usuários/grupos do
sistema não possuem quotas.  Sua sintaxe é a seguinte
</para>
<para>
<literal>edquota [<emphasis>opções</emphasis>]
[<emphasis>usuário/grupo</emphasis>]</literal>
</para>
<para>
As opções podem ser:
</para>
<variablelist>
<varlistentry>
<term>-u</term>
<listitem>
<para>
Edita a quota do usuário especificado (esta é a padrão).
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>-g</term>
<listitem>
<para>
Edita a quota de grupo especificado.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>-r</term>
<listitem>
<para>
Permite editar a quota de sistemas de arquivos remotos através do daemon
<command>rpc.rquotad</command>.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>-p [usuário/grupo]</term>
<listitem>
<para>
Usa os valores especificados para o <emphasis>usuário/grupo</emphasis> para
definir a nova quota, sem necessidade de entrar no modo de edição.
</para>
</listitem>
</varlistentry>
<varlistentry>
<term>-t</term>
<listitem>
<para>
Permite modificar o valor de tolerância dos limites que ultrapassam
<emphasis>soft</emphasis> até que sejam bloqueados.  Durante o tempo de
tolerância, serão enviados somente avisos sobre a quota ultrapassada sem
bloquear totalmente a gravação de arquivos (até que o limite
<emphasis>hard</emphasis> seja atingido ou o tempo de tolerância seja
ultrapassado).
</para>
</listitem>
</varlistentry>
</variablelist>
<para>
Quando a quota <emphasis>soft</emphasis> do usuário/grupo é estourada, a
mensagem "warning: user disk quota excedeed" será exibida.  Quando a quota
<emphasis>hard</emphasis> é ultrapassada, a gravação atual é interrompida e a
mensagem "write failed, user disk limit reatched" é mostrada ao usuário.
Nenhuma nova gravação que ultrapasse a quota <emphasis>hard</emphasis> é
permitida Por exemplo, para modificar a quota do usuário gleydson:
<literal>edquota gleydson</literal>
</para>
<screen>
Disk quotas for user gleydson (uid 1000): 
  Filesystem                   blocks       soft       hard     inodes     soft
    hard
  /dev/hda5                    504944     500100     600000      10868        15000
       20000
</screen>
<para>
O editor de textos usado poderá ser modificado através da variável
<replaceable>$EDITOR</replaceable>.  Abaixo a explicação destes campos:
</para>
<itemizedlist>
<listitem>
<para>
<literal>Filesystem</literal> - Sistema de arquivos que terá a quota do
usuário/grupo editada.  As restrições se aplicam individualmente de acordo com
o sistema de arquivos.
</para>
</listitem>
<listitem>
<para>
<literal>blocks</literal> - Número máximo de blocos (especificado em Kbytes)
que o usuário possui atualmente.  O usuário <literal>gleydson</literal> está
usando atualmente 504944 Kbytes.
</para>
<itemizedlist>
<listitem>
<para>
<literal>soft</literal> - Restrição mínima de espaço em disco usado.
Atualmente 500100 Kb.
</para>
</listitem>
<listitem>
<para>
<literal>hard</literal> - Limite máximo aceitável de uso em disco para o
usuário/grupo sendo editado.  600000 Kb atualmente.  O sistema de quotas nunca
deixará este limite ser ultrapassado.
</para>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<para>
<literal>inodes</literal> - Número máximo de arquivos que o usuário possui
atualmente na partição especificada.  O usuário <literal>gleydson</literal>
possui atualmente 10868 arquivos na partição <filename>/pub</filename>.
</para>
<itemizedlist>
<listitem>
<para>
<literal>soft</literal> - Restrição mínima de número de arquivos que o
usuário/grupo possui no disco.  Atualmente em 15.000.
</para>
</listitem>
<listitem>
<para>
<literal>hard</literal> - Restrição máxima de número de arquivos que o
usuário/grupo possui no disco.  Atualmente em 20.000.
</para>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<para>
Para desativar as restrições coloque "0" no campo <emphasis>soft</emphasis> ou
<emphasis>hard</emphasis>.  Quando o limite <emphasis>soft</emphasis> é
atingido, o usuário é alertado por ter ultrapassado sua quota com a mensagem
"warning: user quota excedeed" (quota do usuário excedida).  O programa
<command>setquota</command> é uma programa não-interativo para edição de quotas
para ser usado diretamente na linha de comando ou em shell scripts.
</para>
<para>
Após ultrapassar o limite <emphasis>soft</emphasis>, começa a contagem do tempo
para que este passe a valer como limite <emphasis>hard</emphasis> (o máximo
aceitável e que nunca poderá ser ultrapassado).  O comando <literal>edquota
-t</literal> serve para modificar estes valores na partição especificada:
</para>
<screen>
Grace period before enforcing soft limits for users: 
Time units may be: days, hours, minutes, or seconds
  Filesystem             Block grace period     Inode grace period
  /dev/hda5                  2days                  7days
</screen>
<para>
Abaixo a explicação destes campos:
</para>
<itemizedlist>
<listitem>
<para>
<literal>Filesystem</literal> - Sistema de arquivos que terá o período de
tolerância modificado.
</para>
</listitem>
<listitem>
<para>
<literal>Block grade period</literal> - Tempo máximo de tolerância para
usuários/grupos que ultrapassaram sua quota <emphasis>soft</emphasis> de espaço
em disco antes de passar a valer como <emphasis>hard</emphasis>.  No exemplo, o
usuário tem 2 dias para excluir possíveis arquivos ou contactar o administrador
para redimensionar o tamanho de quota.  O valor padrão é 7 dias.
</para>
</listitem>
<listitem>
<para>
<literal>Inode grade period</literal> - Tempo máximo de tolerância para
usuários/grupos que ultrapassaram sua quota <emphasis>soft</emphasis> de número
de arquivos gravados antes de passar a valer como <emphasis>hard</emphasis>.
No exemplo, o usuário tem 7 dias para excluir possíveis arquivos ou contactar o
administrador para analisar seu tamanho de quota.  O valor padrão é 7 dias.
</para>
</listitem>
</itemizedlist>
<para>
<emphasis role="strong">OBS1:</emphasis> - O comando
<command>quotacheck</command> deverá ser executado na partição sempre que novas
restrições/limites forem editados com o <command>edquota</command>.  Isto
atualiza os arquivos <filename>quota.user</filename> e
<filename>quota.group</filename>.  Lembre-se de desativar o sistema de quotas
(<literal>quotaoff -ugv /partição</literal>) antes de executar este comando
(para liberar totalmente a partição, <command>quotacheck</command> remonta a
partição somente para leitura quando é executado).  Por este motivo é
recomendável fazer isso em modo monousuário.
</para>
<para>
<emphasis role="strong">OBS2:</emphasis> Quando o limite
<emphasis>soft</emphasis> (suave) é excedido, o sistema começará a lhe mostrar
mensagens alertando a passagem do limite (para lhe dar tempo de eliminar
arquivos ou não ser pego desprevenido com o bloqueio de gravação) porque o
limite <emphasis>hard</emphasis> (rígido) nunca poderá ser ultrapassado.
</para>
<para>
<emphasis role="strong">OBS3:</emphasis> - O tempo de tolerância restante ao
usuário/grupo quando a quota é ultrapassada poder ser visualizada com o comando
<command>quota</command> (veja <xref linkend="d-restr-quotas-checando"/>).
</para>
<para>
<emphasis role="strong">OBS4:</emphasis> - Quando o usuário exclui seus
arquivos e volta a ficar abaixo dos limites <emphasis>soft</emphasis> da quota,
o tempo de tolerância é resetado aos valores padrões (especificados por
<literal>edquota -t</literal>.
</para>
<para>
<emphasis role="strong">OBS5:</emphasis> - As quotas de espaço em disco podem
ser definidas automaticamente para os novos usuários adicionados ao sistema
colocando o espaço em disco na variável
<replaceable>QUOTAUSER=numero</replaceable> do arquivo
<filename>/etc/adduser.conf</filename>.  Isto será equivalente a digitar o
comando <literal>edquota -q QUOTA novo_usuário</literal>.
</para>
</section>

<section id="d-restr-quotas-mudtodos"><title>Modificando a quota de todos os usuários de uma vez</title>
<para>
Editar manualmente a quota de cada usuário é uma tarefa trabalhosa quando se
está instalando quotas e possui muitos usuários, existe uma maneira mais fácil
de fazer isso usando o próprio <command>edquota</command> e um usuário com a
quota já definida.  Por exemplo, instalamos quota em nosso sistema e queremos
que todos os 300 usuários tenham a quota de usuário de 10MB e de grupo de 15MB:
</para>
<orderedlist numeration="arabic">
<listitem>
<para>
Criamos um usuário com esta quota usando o <command>edquota</command> (como
descrito em <xref linkend="d-restr-quotas-editando"/>).  Como exemplo usaremos
o usuário <literal>teste_user</literal>.  Use o comando <literal>quota
teste_user</literal> para verificar se as quotas para este usuário está
correta.
</para>
</listitem>
<listitem>
<para>
Criamos um script que modifique a quota padrão de todos os usuários do sistema
de uma só vez:
</para>
<screen>
#!/bin/sh
cd /home
for USUARIO in *
do
edquota -u ${USUARIO} -p teste_user

done
</screen>
<para>
Pronto, verifique a quota de todos os usuários com o comando <literal>repquota
-a</literal>.
</para>
</listitem>
</orderedlist>
</section>

<section id="d-restr-quotas-checando"><title>Verificando a quota disponível ao usuário</title>
<para>
Execute o comando <command>quota</command> mostra os limites de usuários/grupos
e a tolerância restante antes do limite <emphasis>soft</emphasis> se tornar
rígido.  Abaixo alguns exemplos descritivos deste comando:
</para>
<screen>
quota

Disk quotas for user gleydson (uid 1234): 
     Filesystem  blocks   quota   limit   grace   files   quota   limit   grace
      /dev/hda5  504944* 500100  600000   00:05   10868       0       0
</screen>
<para>
Os campos tem o seguinte significado:
</para>
<itemizedlist>
<listitem>
<para>
<literal>Filesystem</literal> - Sistema de arquivos.
</para>
</listitem>
<listitem>
<para>
<literal>blocks</literal> - Número de blocos usados atualmente na partição (em
Kb).  O "*" indica que o limite foi ultrapassado.  Atualmente em 504944.
</para>
<itemizedlist>
<listitem>
<para>
<literal>quota</literal> - Limite suave (<emphasis>soft</emphasis>) de espaço
na partição que o usuário/grupo possui.  Atualmente 500100.  O valor 0 indica
que o usuário/grupo não possui restrições.
</para>
</listitem>
<listitem>
<para>
<literal>limit</literal> - Limite máximo (<emphasis>hard</emphasis>) de espaço
na partição que o usuário/grupo possui.  Atualmente em 600000.  O valor 0
indica que o usuário/grupo não possui restrições.
</para>
</listitem>
<listitem>
<para>
<literal>grace</literal> - Tolerância antes que o limite
<emphasis>soft</emphasis> passe a valer como <emphasis>hard</emphasis> quando o
espaço em disco é ultrapassado.  Este usuário tem 5 minutos restantes para que
isto ocorra.  Quando o valor <emphasis>soft</emphasis> volta a ficar abaixo da
quota, a tolerância é resetada.
</para>
<para>
O parâmetro "none" indica que o tempo de tolerância expirou (caso existam
limitações de quota que foram ultrapassadas) ou que o usuário/grupo não possui
restrições.  Veja se existe um "*" no campo <literal>blocks</literal>.
</para>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<para>
<literal>files</literal> - Número máximo de arquivos que usuário/grupo possui
atualmente na partição.  Um "*' indica que o limite foi ultrapassado.
Atualmente em 10868.
</para>
<itemizedlist>
<listitem>
<para>
<literal>quota</literal> - Limite suave (<emphasis>soft</emphasis>) de número
de arquivos na partição que o usuário/grupo possui.  Atualmente ilimitado.
</para>
</listitem>
<listitem>
<para>
<literal>limit</literal> - Limite máximo (<emphasis>hard</emphasis>) de número
de arquivos na partição que o usuário/grupo possui.  Atualmente ilimitado.
</para>
</listitem>
<listitem>
<para>
<literal>grace</literal> - Tolerância antes que o limite
<emphasis>soft</emphasis> passe a valer como <emphasis>hard</emphasis> para o
número de arquivos ultrapassados.  Como não existe quota para número de
arquivos, não existe tolerância.  A tolerância é resetada aos valores padrões
quando o valor <emphasis>soft</emphasis> volta a ficar abaixo da quota.
</para>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<para>
A quota de outros usuários/grupos podem ser visualizadas especificando as
opções <emphasis>-u</emphasis> (padrão) e <emphasis>-g</emphasis> na linha de
comando respectivamente.  A opção <emphasis>-v</emphasis> permite visualizar
quotas em sistemas de arquivos não alocados e <emphasis>-q</emphasis> mostra
somente uma mensagem dizendo se o usuário está ou não dentro de sua quota:
</para>
<screen>
quota -u usuario

quota -uq usuario

quota -g users
</screen>
<para>
Por motivos de segurança, você não poderá visualizar as quotas de outros
usuários e grupos que não pertence (exceto para o usuário
<literal>root</literal>).
</para>
</section>

<section id="d-restr-quotas-todas"><title>Verificando a quota de todos os usuários/grupos do sistema</title>
<para>
Quando precisamos verificar o uso de quotas de todos os usuários/grupos do
sistema o <command>quota</command> se torna incômodo e pouco prático.  O
comando <command>repquota</command> lista está disponível ao administrador para
facilitar esta tarefa.  Sua listagem é organizada por partições listando dados
adicionais como <literal>grace time</literal> e aceita as mesmas opções dos
utilitários <command>quotaon</command> e <command>quotaoff</command>.  Primeiro
são listados as restrições de usuários e depois de grupos para a partição.
(tolerância) As opções aceitas por este utilitário tem o mesmo significado das
opções do <command>quotaon</command> e <command>quotaoff</command>:
</para>
<screen>
repquota -aug

*** Report for user quotas on device /dev/hda3
Block grace time: 7days; Inode grace time: 7days
                        Block limits                File limits
User            used    soft    hard  grace    used  soft  hard  grace
----------------------------------------------------------------------
root      --   29160       0       0   none    9970     0     0   none
daemon    --      64       0       0             22     0     0       
man       --     944       0       0             65     0     0       
mail      --    4960       0       0            823     0     0       
news      --       4       0       0              1     0     0       
gleydson  --   31032       0       0           6956     0     0       
testuser  --      16       0       0              4     0     0       
anotheruser --    16       0       0              4     0     0       
nobody    --    2344       0       0              2     0     0       

*** Report for user quotas on device /dev/hda5
Block grace time: 2days; Inode grace time: 7days
                        Block limits                File limits
User            used    soft    hard  grace    used  soft  hard  grace
----------------------------------------------------------------------
root      --   16052       0       0   none    6443     0     0   none
gleydson  +-    4944  500100  600000   none   10868     0     0       

*** Report for group quotas on device /dev/hda5
Block grace time: 7days; Inode grace time: 7days
                        Block limits                File limits
Group           used    soft    hard  grace    used  soft  hard  grace
----------------------------------------------------------------------
root      --   20308       0       0   none     636     0     0   none
src       --   11404       0       0            660     0     0       
users     --    1756       0       0           6561     0     0       
gleydson  --    3452       0       0           9307     0     0
</screen>
<para>
Um sinal de "+-" no segundo campo indica quota ultrapassada ou no espaço em
disco, "-+' em número de arquivos e "++" em ambos.  Como vimos acima, o este
comando também lista o número de arquivos e bytes pertencentes a cada usuário
na partição (mesmo não sendo monitorado pelas restrições de quota), isto ajuda
a monitorar ações suspeitas com a excedência de espaço em disco de determinados
usuários/grupos do sistema.  Um exemplo é alguém que esteja fora da quota e
abusando de seu usuário/grupo para uso excessivo de espaço em disco sem seu
conhecimento.
</para>
<para>
<emphasis role="strong">OBS:</emphasis> Este utilitário pode ser executado por
qualquer usuário no sistema e mostrar o uso de quotas de usuários/grupos que
não deveria ter acesso.  É recomendado deve ter permissões de leitura/gravação
somente para o usuário <literal>root</literal> e sem permissões para
grupo/outros usuários.
</para>
</section>

<section id="d-restr-quotas-warn"><title>Avisando usuários sobre o estouro de quota</title>
<para>
Avisos sobre quota ultrapassada podem ser enviadas automaticamente a todos os
usuários pelo utilitário <command>warnquota</command>.  Ele poderá ser
executado periodicamente através do <command>cron</command> (por padrão isto é
feito diariamente na distribuição <command>Debian</command> pelo script
<filename>/etc/cron.daily/quota</filename>).  Dados adicionais sobre o envio
das mensagens devem ser especificados no arquivo
<filename>/etc/warnquota.conf</filename> seu formato é o seguinte:
</para>
<screen>
# Programa usado para enviar as mensagens
MAIL_CMD 	= "/usr/sbin/sendmail -t"
# Campo de origem da mensagem
FROM 		= "root@localhost"
# but they don't have to be:
SUBJECT 	= Quota excedida
CC_TO 		= "root@localhost"
SUPPORT 	= "root@localhost"
PHONE 		= "5555-2525"
#
</screen>
<para>
O e-mail é enviado aos usuários (e usuários que pertencem a grupos com a quota
excedida) com o seguinte formato:
</para>
<screen>
From: root@localhost
To: gleydson@debian.gms.com.br
Cc: root@localhost
Reply-To: root@localhost
Subject: Quota Excedida
Date: Sat, 22 Sep 2001 14:27:38 -0400

Hi,

We noticed that you are in violation with the quotasystem
used on this system. We have found the following violations:


                        Block limits               File limits
Filesystem           used    soft    hard  grace    used  soft  hard  grace
/dev/hda5      +-  504944  500100  600000   none   10868     0     0       


We hope that you will cleanup before your grace period expires.

Basically, this means that the system thinks you are using more disk space
on the above partition(s) than you are allowed.  If you do not delete files
and get below your quota before the grace period expires, the system will
prevent you from creating new files.

For additional assistance, please contact us at root@localhost
or via phone at 5555-2525.
</screen>
</section>

</section>

<section id="s40.13"><title>Suporte a senhas ocultas</title>
<para>
Veja <xref linkend="d-contas-segsenhas-shadow"/>.
</para>
</section>

<section id="s40.14"><title>Suporte a senhas md5</title>
<para>
Veja <xref linkend="d-contas-segsenhas-md5"/>.
</para>
</section>

<section id="d-restr-hardware"><title>Restrições no hardware do sistema</title>
<para>
As restrições descritas aqui são úteis para diminuir as chances de um ataque
por acesso físico ser realizado com sucesso no sistema que desejamos proteger.
</para>
<para>
Ter um sistema totalmente seguro é praticamente impossível, mas existem
diversas maneiras de se dificultar as coisas.
</para>
<section id="d-restr-hardware-bios"><title>BIOS do sistema</title>
<para>
Algumas restrições podem ser configuradas na para diminuir as chances de se
obter acesso <literal>root</literal> (usando métodos conhecidos de recuperação
via disquete/CD inicializável) ou simplesmente aumentar nossa confiança no
sistema:
</para>
<itemizedlist>
<listitem>
<para>
Coloque uma senha para entrada no Setup da máquina, compartilhe esta senha
<emphasis role="strong">somente</emphasis> com as pessoas que tem poder de root
(ou seja, pessoal de confiança que administra a máquina).
</para>
</listitem>
<listitem>
<para>
Mude a seqüencia de partida para somente sua unidade de disco rígido que contém
o sistema operacional.  As BIOS trazem convenções de DOS para especificar o
método de partida, então <emphasis>Only C</emphasis> quer dizer somente o
primeiro disco rígido, <emphasis>SCSI</emphasis> tentar dispositivos SCSI
primeiro, etc.  Isso pode variar de acordo com o modelo de sua BIOS.
</para>
</listitem>
</itemizedlist>
<para>
Com os dois ítens acima qualquer um ficará impedido de inicializar o sistema a
partir de um disco de recuperação ou entrar no Setup para modificar a ordem de
procura do sistema operacional para dar a partida via disquetes.
</para>
</section>

<section id="d-restr-hardware-floppy"><title>Retirada da unidade de disquetes</title>
<para>
Como não é seguro confiar nas restrições de senha da BIOS (qualquer um com
conhecimentos de hardware e acesso físico a máquina pode abrir o gabinete e dar
um curto na bateria que mantém os dados na CMOS ou aterrar o pino de sinal da
CMOS), a retirada da unidade de disquetes é recomendada, isso dificultará
bastante as coisas.
</para>
</section>

<section id="d-restr-hardware-netboot"><title>Placas de rede com eprom de boot</title>
<para>
Evite a utilização de placas de rede com recursos de boot via EPROM no
servidor, um servidor dhcp/bootp/tftp poderá ser configurado sem problemas por
um cracker na rede (caso a BIOS esteja com a ordem inadequada de procura de
discos) e o ataque se dar com mais "sofisticação" e rapidez.
</para>
</section>

<section id="d-restr-hardware-lilo"><title>Protegendo o LILO</title>
<para>
A opção <emphasis>passwd=senha</emphasis> e <emphasis>restricted</emphasis>
poderão ser usadas na seção da imagem que desejamos proteger.  Respectivamente
pedem uma senha para a inicialização do sistema e caso argumentos como
<emphasis>root=single</emphasis> sejam usados para conseguir acesso
<literal>root</literal> sem fornecer senha.
</para>
<para>
E deixe somente as permissões de acesso ao usuário <literal>root</literal>
(caso contrário sua senha poderá ser vista por qualquer usuário) e modifique os
atributos deste arquivo para imutável para que nem mesmo o
<literal>root</literal> possa modifica-lo: <literal>chattr +i
/etc/lilo.conf</literal>.
</para>
</section>

<section id="d-restr-hardware-harddisk"><title>Disco rígido</title>
<para>
O disco rígido do servidor poderá se retirado como alternativa para se ter
acesso aos dados armazenados.  Isto poderá ser dificultado com o uso de lacres
de disco ou outras maneiras de dificultar mais esta tarefa (mais parafusos,
armazenamento em partes de difícil manipulação do HD, etc) qualquer coisa que
possa lhe fazer ganhar tempo e despertar suspeitas para evitar o sucesso desta
alternativa (ousada).
</para>
<para>
Dados importantes ou confidenciais poderão ser armazenados em um sistema de
arquivos criptografados e serem montados somente pelos administradores que
possuem acesso físico ao sistema.  O algoritmo <emphasis>Serpent</emphasis> é
muito forte na proteção de dados além de possuir um ótimo desempenho.  Patches
de criptografia poderão ser aplicados no kernel para ativação deste recurso
(veja <xref linkend="d-cripto-criptofs"/>) para detalhes.
</para>
<para>
Sensores podem ser ligados na carcaça do HD como forma de disparar um pequeno
alarme embutido no gabinete do servidor, se você gosta de eletrônica poderá
montar um destes facilmente para chamar a atenção alimentado por fonte/baterias
em um circuito de emergência, e poderá acomodar sua caixa em uma segunda
"carcaça de fonte" apenas para desviar suspeitas.  Um circuito interno de
câmeras também é uma boa alternativa para monitorar a movimentação.
</para>
<para>
Esquemas de segurança dependendo do porte da organização e dos dados que se
desejam proteger deverão ser elaborados e postos em prática.  Todos os métodos
imagináveis deverão ser considerados de acordo com as possibilidades do
ambiente.
</para>
</section>

</section>

</chapter>

